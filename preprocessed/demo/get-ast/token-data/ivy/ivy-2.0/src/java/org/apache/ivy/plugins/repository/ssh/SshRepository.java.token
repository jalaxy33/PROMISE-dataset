package
org
apache
ivy
plugins
repository
ssh
import
java
io
BufferedReader
import
java
io
ByteArrayInputStream
import
java
io
ByteArrayOutputStream
import
java
io
File
import
java
io
IOException
import
java
io
InputStream
import
java
io
StringReader
import
java
net
URI
import
java
net
URISyntaxException
import
java
util
ArrayList
import
java
util
List
import
org
apache
ivy
plugins
repository
Resource
import
org
apache
ivy
util
Message
import
com
jcraft
jsch
ChannelExec
import
com
jcraft
jsch
JSchException
import
com
jcraft
jsch
Session
public
class
SshRepository
extends
AbstractSshBasedRepository
private
static
final
int
BUFFER_SIZE
private
static
final
String
ARGUMENT_PLACEHOLDER
private
static
final
int
POLL_SLEEP_TIME
private
char
fileSeparator
private
String
listCommand
private
String
existCommand
private
String
createDirCommand
private
String
publishPermissions
public
Resource
getResource
String
source
Message
debug
source
return
new
SshResource
this
source
public
SshResource
resolveResource
String
source
Message
debug
source
SshResource
result
Session
session
try
session
getSession
source
Scp
myCopy
new
Scp
session
Scp
FileInfo
fileInfo
myCopy
getFileinfo
new
URI
source
getPath
result
new
SshResource
this
source
fileInfo
getLength
fileInfo
getLastModified
catch
IOException
e
if
session
releaseSession
session
source
result
new
SshResource
catch
URISyntaxException
e
if
session
releaseSession
session
source
result
new
SshResource
catch
RemoteScpException
e
result
new
SshResource
Message
debug
return
result
private
void
readSessionOutput
ChannelExec
channel
StringBuffer
strStdout
StringBuffer
strStderr
throws
IOException
InputStream
stdout
channel
getInputStream
InputStream
stderr
channel
getErrStream
try
channel
connect
catch
JSchException
e1
throw
IOException
new
IOException
initCause
e1
byte
buffer
new
byte
BUFFER_SIZE
while
int
avail
while
avail
stdout
available
int
len
stdout
read
buffer
avail
BUFFER_SIZE
BUFFER_SIZE
avail
strStdout
append
new
String
buffer
len
while
avail
stderr
available
int
len
stderr
read
buffer
avail
BUFFER_SIZE
BUFFER_SIZE
avail
strStderr
append
new
String
buffer
len
if
channel
isClosed
break
try
Thread
sleep
POLL_SLEEP_TIME
catch
Exception
ee
int
avail
while
avail
stdout
available
int
len
stdout
read
buffer
avail
BUFFER_SIZE
BUFFER_SIZE
avail
strStdout
append
new
String
buffer
len
while
avail
stderr
available
int
len
stderr
read
buffer
avail
BUFFER_SIZE
BUFFER_SIZE
avail
strStderr
append
new
String
buffer
len
public
List
list
String
parent
throws
IOException
Message
debug
parent
ArrayList
result
new
ArrayList
Session
session
ChannelExec
channel
session
getSession
parent
channel
getExecChannel
session
URI
parentUri
try
parentUri
new
URI
parent
catch
URISyntaxException
e1
String
fullCmd
replaceArgument
listCommand
parentUri
getPath
channel
setCommand
fullCmd
StringBuffer
stdOut
new
StringBuffer
StringBuffer
stdErr
new
StringBuffer
readSessionOutput
channel
stdOut
stdErr
if
channel
getExitStatus
Message
error
Message
error
stdErr
toString
return
else
BufferedReader
br
new
BufferedReader
new
StringReader
stdOut
toString
String
line
while
line
br
readLine
result
add
line
return
result
private
ChannelExec
getExecChannel
Session
session
throws
IOException
ChannelExec
channel
try
channel
ChannelExec
session
openChannel
catch
JSchException
e
throw
new
IOException
return
channel
private
String
replaceArgument
String
command
String
argument
String
fullCmd
if
command
indexOf
ARGUMENT_PLACEHOLDER
fullCmd
command
argument
else
fullCmd
command
replaceAll
ARGUMENT_PLACEHOLDER
argument
return
fullCmd
public
void
put
File
source
String
destination
boolean
overwrite
throws
IOException
Message
debug
destination
Session
session
getSession
destination
try
URI
destinationUri
try
destinationUri
new
URI
destination
catch
URISyntaxException
e
String
filePath
destinationUri
getPath
int
lastSep
filePath
lastIndexOf
fileSeparator
String
path
String
name
if
lastSep
name
filePath
path
else
name
filePath
substring
lastSep
path
filePath
substring
lastSep
if
overwrite
if
checkExistence
filePath
session
throw
new
IOException
if
path
makePath
path
session
Scp
myCopy
new
Scp
session
myCopy
put
source
getCanonicalPath
path
name
publishPermissions
catch
IOException
e
if
session
releaseSession
session
destination
throw
e
catch
RemoteScpException
e
throw
new
IOException
e
getMessage
private
void
makePath
String
path
Session
session
throws
IOException
ChannelExec
channel
String
trimmed
path
try
while
trimmed
length
trimmed
charAt
trimmed
length
fileSeparator
trimmed
trimmed
substring
trimmed
length
if
trimmed
length
checkExistence
trimmed
session
return
int
nextSlash
trimmed
lastIndexOf
fileSeparator
if
nextSlash
String
parent
trimmed
substring
nextSlash
makePath
parent
session
channel
getExecChannel
session
String
mkdir
replaceArgument
createDirCommand
trimmed
Message
debug
mkdir
channel
setCommand
mkdir
StringBuffer
stdOut
new
StringBuffer
StringBuffer
stdErr
new
StringBuffer
readSessionOutput
channel
stdOut
stdErr
finally
if
channel
channel
disconnect
private
boolean
checkExistence
String
filePath
Session
session
throws
IOException
Message
debug
filePath
ChannelExec
channel
channel
getExecChannel
session
String
fullCmd
replaceArgument
existCommand
filePath
channel
setCommand
fullCmd
StringBuffer
stdOut
new
StringBuffer
StringBuffer
stdErr
new
StringBuffer
readSessionOutput
channel
stdOut
stdErr
return
channel
getExitStatus
public
void
get
String
source
File
destination
throws
IOException
Message
debug
source
destination
getCanonicalPath
if
destination
getParentFile
destination
getParentFile
mkdirs
Session
session
getSession
source
try
URI
sourceUri
try
sourceUri
new
URI
source
catch
URISyntaxException
e
if
sourceUri
Message
error
source
return
Scp
myCopy
new
Scp
session
myCopy
get
sourceUri
getPath
destination
getCanonicalPath
catch
IOException
e
if
session
releaseSession
session
source
throw
e
catch
RemoteScpException
e
throw
new
IOException
e
getMessage
public
void
setListCommand
String
cmd
this
listCommand
cmd
trim
public
String
getListCommand
return
listCommand
public
String
getCreateDirCommand
return
createDirCommand
public
void
setCreateDirCommand
String
createDirCommand
this
createDirCommand
createDirCommand
public
String
getExistCommand
return
existCommand
public
void
setExistCommand
String
existCommand
this
existCommand
existCommand
public
void
setFileSeparator
char
fileSeparator
this
fileSeparator
fileSeparator
public
void
setPublishPermissions
String
permissions
this
publishPermissions
permissions
protected
String
getRepositoryScheme
return
public
InputStream
openStream
SshResource
resource
throws
IOException
Session
session
getSession
resource
getName
Scp
scp
new
Scp
session
ByteArrayOutputStream
os
new
ByteArrayOutputStream
try
scp
get
resource
getName
os
catch
IOException
e
if
session
releaseSession
session
resource
getName
throw
e
catch
RemoteScpException
e
throw
new
IOException
e
getMessage
return
new
ByteArrayInputStream
os
toByteArray
