package
fr
jayasoft
ivy
xml
import
java
io
File
import
java
io
IOException
import
java
net
URL
import
java
text
ParseException
import
java
util
ArrayList
import
java
util
Arrays
import
java
util
Collection
import
java
util
Date
import
java
util
List
import
javax
xml
parsers
ParserConfigurationException
import
org
xml
sax
Attributes
import
org
xml
sax
SAXException
import
org
xml
sax
SAXParseException
import
org
xml
sax
helpers
DefaultHandler
import
fr
jayasoft
ivy
Configuration
import
fr
jayasoft
ivy
ConflictManager
import
fr
jayasoft
ivy
DefaultDependencyArtifactDescriptor
import
fr
jayasoft
ivy
DefaultDependencyDescriptor
import
fr
jayasoft
ivy
DefaultModuleDescriptor
import
fr
jayasoft
ivy
Ivy
import
fr
jayasoft
ivy
License
import
fr
jayasoft
ivy
MDArtifact
import
fr
jayasoft
ivy
ModuleDescriptor
import
fr
jayasoft
ivy
ModuleId
import
fr
jayasoft
ivy
ModuleRevisionId
import
fr
jayasoft
ivy
Status
import
fr
jayasoft
ivy
conflict
FixedConflictManager
import
fr
jayasoft
ivy
repository
Resource
import
fr
jayasoft
ivy
repository
url
URLResource
import
fr
jayasoft
ivy
util
Message
import
fr
jayasoft
ivy
util
XMLHelper
public
class
XmlModuleDescriptorParser
extends
DefaultHandler
private
static
final
Collection
ALLOWED_VERSIONS
Arrays
asList
new
String
private
DefaultModuleDescriptor
_md
private
DefaultDependencyDescriptor
_dd
private
DefaultDependencyArtifactDescriptor
_dad
private
MDArtifact
_artifact
private
List
_errors
new
ArrayList
private
String
_conf
private
boolean
_validate
private
Ivy
_ivy
private
boolean
_artifactsDeclared
private
static
final
int
NONE
private
static
final
int
INFO
private
static
final
int
CONF
private
static
final
int
PUB
private
static
final
int
DEP
private
static
final
int
ARTIFACT_INCLUDE
private
static
final
int
ARTIFACT_EXCLUDE
private
static
final
int
CONFLICT
private
int
_state
NONE
private
Resource
_res
private
String
_defaultConf
public
XmlModuleDescriptorParser
Ivy
ivy
boolean
validate
_ivy
ivy
_validate
validate
public
static
ModuleDescriptor
parseDescriptor
Ivy
ivy
URL
xmlURL
boolean
validate
throws
ParseException
IOException
return
parseDescriptor
ivy
xmlURL
new
URLResource
xmlURL
validate
public
static
ModuleDescriptor
parseDescriptor
Ivy
ivy
URL
xmlURL
Resource
res
boolean
validate
throws
ParseException
IOException
XmlModuleDescriptorParser
parser
new
XmlModuleDescriptorParser
ivy
validate
parser
parse
xmlURL
res
validate
return
parser
getModuleDescriptor
private
ModuleDescriptor
getModuleDescriptor
throws
ParseException
if
_errors
isEmpty
throw
new
ParseException
_errors
toString
return
_md
private
void
parse
URL
xmlURL
Resource
res
boolean
validate
throws
ParseException
IOException
try
_md
new
DefaultModuleDescriptor
_res
res
_md
setLastModified
getLastModified
URL
schemaURL
validate
getClass
getResource
XMLHelper
parse
xmlURL
schemaURL
this
checkConfigurations
if
_artifactsDeclared
String
confs
_md
getConfigurationsNames
for
int
i
i
confs
length
i
_md
addArtifact
confs
i
new
MDArtifact
_md
_md
getModuleRevisionId
getName
catch
SAXException
ex
ParseException
pe
new
ParseException
ex
getMessage
xmlURL
pe
initCause
ex
throw
pe
catch
ParserConfigurationException
ex
IllegalStateException
ise
new
IllegalStateException
ex
getMessage
xmlURL
ise
initCause
ex
throw
ise
private
Date
getDefaultPubDate
return
new
Date
_md
getLastModified
private
long
getLastModified
long
last
_res
getLastModified
if
last
return
last
else
Message
debug
_res
return
System
currentTimeMillis
public
void
startElement
String
uri
String
localName
String
qName
Attributes
attributes
throws
SAXException
try
if
equals
qName
String
version
attributes
getValue
if
ALLOWED_VERSIONS
contains
version
addError
version
throw
new
SAXException
version
else
if
equals
qName
_state
INFO
String
org
_ivy
substitute
attributes
getValue
String
module
_ivy
substitute
attributes
getValue
String
revision
_ivy
substitute
attributes
getValue
_md
setModuleRevisionId
ModuleRevisionId
newInstance
org
module
revision
String
status
_ivy
substitute
attributes
getValue
_md
setStatus
status
Status
DEFAULT_STATUS
status
_md
setResolverName
_ivy
substitute
attributes
getValue
_md
setDefault
Boolean
valueOf
_ivy
substitute
attributes
getValue
booleanValue
String
pubDate
_ivy
substitute
attributes
getValue
if
pubDate
pubDate
length
try
_md
setPublicationDate
Ivy
DATE_FORMAT
parse
pubDate
catch
ParseException
e
addError
pubDate
_md
setPublicationDate
getDefaultPubDate
else
_md
setPublicationDate
getDefaultPubDate
else
if
equals
qName
_md
addLicense
new
License
attributes
getValue
attributes
getValue
else
if
equals
qName
_md
setHomePage
attributes
getValue
else
if
equals
qName
_state
CONF
else
if
equals
qName
_state
PUB
_artifactsDeclared
checkConfigurations
else
if
equals
qName
_state
DEP
_defaultConf
attributes
getValue
_defaultConf
_defaultConf
_defaultConf
checkConfigurations
else
if
equals
qName
_state
CONFLICT
checkConfigurations
else
if
equals
qName
if
_state
PUB
String
ext
attributes
getValue
ext
ext
ext
attributes
getValue
_artifact
new
MDArtifact
_md
attributes
getValue
attributes
getValue
ext
String
confs
attributes
getValue
if
confs
confs
length
String
conf
if
equals
confs
conf
_md
getConfigurationsNames
else
conf
confs
split
for
int
i
i
conf
length
i
_artifact
addConfiguration
conf
i
trim
_md
addArtifact
conf
i
trim
_artifact
else
if
_state
DEP
addDependencyArtifactsIncludes
attributes
else
if
_validate
addError
_state
else
if
equals
qName
addDependencyArtifactsIncludes
attributes
else
if
equals
qName
addDependencyArtifactsExcludes
attributes
else
if
equals
qName
String
org
_ivy
substitute
attributes
getValue
if
org
org
_md
getModuleRevisionId
getOrganisation
boolean
force
Boolean
valueOf
attributes
getValue
booleanValue
String
name
_ivy
substitute
attributes
getValue
String
rev
_ivy
substitute
attributes
getValue
_dd
new
DefaultDependencyDescriptor
_md
ModuleRevisionId
newInstance
org
name
rev
force
_md
addDependency
_dd
String
confs
attributes
getValue
if
confs
confs
length
parseDepsConfs
confs
else
if
equals
qName
String
conf
attributes
getValue
switch
_state
case
CONF
String
visibility
attributes
getValue
String
ext
attributes
getValue
_md
addConfiguration
new
Configuration
conf
Configuration
Visibility
getVisibility
visibility
visibility
attributes
getValue
ext
ext
split
break
case
PUB
if
equals
conf
String
confs
_md
getConfigurationsNames
for
int
i
i
confs
length
i
_artifact
addConfiguration
confs
i
_md
addArtifact
confs
i
_artifact
else
_artifact
addConfiguration
conf
_md
addArtifact
conf
_artifact
break
case
DEP
_conf
conf
String
mappeds
attributes
getValue
if
mappeds
String
mapped
mappeds
split
for
int
i
i
mapped
length
i
_dd
addDependencyConfiguration
_conf
mapped
i
trim
break
case
ARTIFACT_INCLUDE
case
ARTIFACT_EXCLUDE
_dad
addConfiguration
conf
break
default
if
_validate
addError
_state
break
else
if
equals
qName
_dd
addDependencyConfiguration
_conf
attributes
getValue
else
if
equals
qName
_state
CONFLICT
String
org
_ivy
substitute
attributes
getValue
org
org
org
String
mod
_ivy
substitute
attributes
getValue
mod
mod
mod
ConflictManager
cm
String
name
_ivy
substitute
attributes
getValue
String
rev
_ivy
substitute
attributes
getValue
if
rev
String
revs
rev
split
for
int
i
i
revs
length
i
revs
i
revs
i
trim
cm
new
FixedConflictManager
revs
else
if
name
cm
_ivy
getConflictManager
name
if
cm
addError
name
return
else
addError
return
_md
addConflictManager
new
ModuleId
org
mod
cm
else
if
_validate
_state
INFO
addError
qName
catch
Exception
ex
addError
ex
getMessage
throw
new
SAXException
ex
getMessage
ex
private
void
parseDepsConfs
String
confs
String
conf
confs
split
for
int
i
i
conf
length
i
String
ops
conf
i
split
if
ops
length
if
ops
indexOf
addError
conf
i
_dd
getDependencyRevisionId
else
_dd
addDependencyConfiguration
ops
trim
ops
trim
else
if
ops
length
String
modConfs
ops
split
String
depConfs
ops
split
for
int
j
j
modConfs
length
j
for
int
k
k
depConfs
length
k
_dd
addDependencyConfiguration
modConfs
j
trim
depConfs
k
trim
else
addError
conf
i
_dd
getDependencyRevisionId
private
void
addDependencyArtifactsIncludes
Attributes
attributes
_state
ARTIFACT_INCLUDE
addDependencyArtifact
attributes
private
void
addDependencyArtifactsExcludes
Attributes
attributes
_state
ARTIFACT_EXCLUDE
addDependencyArtifact
attributes
private
void
addDependencyArtifact
Attributes
attributes
boolean
includes
String
name
attributes
getValue
name
name
name
String
type
attributes
getValue
type
type
type
String
ext
attributes
getValue
ext
ext
ext
type
_dad
new
DefaultDependencyArtifactDescriptor
_dd
name
type
ext
includes
String
confs
attributes
getValue
if
confs
confs
length
String
conf
if
equals
confs
conf
_md
getConfigurationsNames
else
conf
confs
split
for
int
i
i
conf
length
i
_dad
addConfiguration
conf
i
trim
public
void
endElement
String
uri
String
localName
String
qName
throws
SAXException
if
_state
PUB
equals
qName
_artifact
getConfigurations
length
String
confs
_md
getConfigurationsNames
for
int
i
i
confs
length
i
_artifact
addConfiguration
confs
i
_md
addArtifact
confs
i
_artifact
else
if
equals
qName
checkConfigurations
else
if
_state
ARTIFACT_INCLUDE
equals
qName
equals
qName
_state
ARTIFACT_EXCLUDE
equals
qName
_state
DEP
if
_dad
getConfigurations
length
String
confs
_md
getConfigurationsNames
for
int
i
i
confs
length
i
_dad
addConfiguration
confs
i
else
if
equals
qName
_dd
getModuleConfigurations
length
parseDepsConfs
_defaultConf
private
void
checkConfigurations
if
_md
getConfigurations
length
_md
addConfiguration
new
Configuration
public
void
warning
SAXParseException
ex
Message
warn
getLocationString
ex
ex
getMessage
public
void
error
SAXParseException
ex
Message
error
getLocationString
ex
ex
getMessage
public
void
fatalError
SAXParseException
ex
throws
SAXException
addError
getLocationString
ex
ex
getMessage
private
String
getLocationString
SAXParseException
ex
StringBuffer
str
new
StringBuffer
String
systemId
ex
getSystemId
if
systemId
int
index
systemId
lastIndexOf
if
index
systemId
systemId
substring
index
str
append
systemId
else
if
_res
str
append
_res
toString
str
append
str
append
ex
getLineNumber
str
append
str
append
ex
getColumnNumber
return
str
toString
private
void
addError
String
msg
if
_res
_errors
add
msg
_res
else
_errors
add
msg
public
static
void
main
String
args
throws
Exception
System
out
println
parseDescriptor
new
Ivy
new
File
toURL
