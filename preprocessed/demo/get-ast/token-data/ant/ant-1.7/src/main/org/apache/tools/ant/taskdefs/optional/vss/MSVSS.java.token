package
org
apache
tools
ant
taskdefs
optional
vss
import
org
apache
tools
ant
types
EnumeratedAttribute
import
java
io
File
import
java
io
IOException
import
java
text
DateFormat
import
java
text
ParseException
import
java
util
Calendar
import
java
util
Date
import
java
util
GregorianCalendar
import
org
apache
tools
ant
BuildException
import
org
apache
tools
ant
Project
import
org
apache
tools
ant
Task
import
org
apache
tools
ant
taskdefs
Execute
import
org
apache
tools
ant
taskdefs
LogStreamHandler
import
org
apache
tools
ant
types
Commandline
import
org
apache
tools
ant
util
FileUtils
public
abstract
class
MSVSS
extends
Task
implements
MSVSSConstants
private
String
ssDir
private
String
vssLogin
private
String
vssPath
private
String
serverPath
private
String
version
private
String
date
private
String
label
private
String
autoResponse
private
String
localPath
private
String
comment
private
String
fromLabel
private
String
toLabel
private
String
outputFileName
private
String
user
private
String
fromDate
private
String
toDate
private
String
style
private
boolean
quiet
private
boolean
recursive
private
boolean
writable
private
boolean
failOnError
private
boolean
getLocalCopy
private
int
numDays
Integer
MIN_VALUE
private
DateFormat
dateFormat
DateFormat
getDateInstance
DateFormat
SHORT
private
CurrentModUpdated
timestamp
private
WritableFiles
writableFiles
abstract
Commandline
buildCmdLine
public
final
void
setSsdir
String
dir
this
ssDir
FileUtils
translatePath
dir
public
final
void
setLogin
final
String
vssLogin
this
vssLogin
vssLogin
public
final
void
setVsspath
final
String
vssPath
String
projectPath
if
vssPath
startsWith
projectPath
vssPath
substring
else
projectPath
vssPath
if
projectPath
startsWith
PROJECT_PREFIX
this
vssPath
projectPath
else
this
vssPath
PROJECT_PREFIX
projectPath
public
final
void
setServerpath
final
String
serverPath
this
serverPath
serverPath
public
final
void
setFailOnError
final
boolean
failOnError
this
failOnError
failOnError
public
void
execute
throws
BuildException
int
result
Commandline
commandLine
buildCmdLine
result
run
commandLine
if
Execute
isFailure
result
getFailOnError
String
msg
formatCommandLine
commandLine
result
throw
new
BuildException
msg
getLocation
protected
void
setInternalComment
final
String
comment
this
comment
comment
protected
void
setInternalAutoResponse
final
String
autoResponse
this
autoResponse
autoResponse
protected
void
setInternalDate
final
String
date
this
date
date
protected
void
setInternalDateFormat
final
DateFormat
dateFormat
this
dateFormat
dateFormat
protected
void
setInternalFailOnError
final
boolean
failOnError
this
failOnError
failOnError
protected
void
setInternalFromDate
final
String
fromDate
this
fromDate
fromDate
protected
void
setInternalFromLabel
final
String
fromLabel
this
fromLabel
fromLabel
protected
void
setInternalLabel
final
String
label
this
label
label
protected
void
setInternalLocalPath
final
String
localPath
this
localPath
localPath
protected
void
setInternalNumDays
final
int
numDays
this
numDays
numDays
protected
void
setInternalOutputFilename
final
String
outputFileName
this
outputFileName
outputFileName
protected
void
setInternalQuiet
final
boolean
quiet
this
quiet
quiet
protected
void
setInternalRecursive
final
boolean
recursive
this
recursive
recursive
protected
void
setInternalStyle
final
String
style
this
style
style
protected
void
setInternalToDate
final
String
toDate
this
toDate
toDate
protected
void
setInternalToLabel
final
String
toLabel
this
toLabel
toLabel
protected
void
setInternalUser
final
String
user
this
user
user
protected
void
setInternalVersion
final
String
version
this
version
version
protected
void
setInternalWritable
final
boolean
writable
this
writable
writable
protected
void
setInternalFileTimeStamp
final
CurrentModUpdated
timestamp
this
timestamp
timestamp
protected
void
setInternalWritableFiles
final
WritableFiles
writableFiles
this
writableFiles
writableFiles
protected
void
setInternalGetLocalCopy
final
boolean
getLocalCopy
this
getLocalCopy
getLocalCopy
protected
String
getSSCommand
if
ssDir
return
SS_EXE
return
ssDir
endsWith
File
separator
ssDir
SS_EXE
ssDir
File
separator
SS_EXE
protected
String
getVsspath
return
vssPath
protected
String
getQuiet
return
quiet
FLAG_QUIET
protected
String
getRecursive
return
recursive
FLAG_RECURSION
protected
String
getWritable
return
writable
FLAG_WRITABLE
protected
String
getLabel
String
shortLabel
if
label
label
length
shortLabel
FLAG_LABEL
getShortLabel
return
shortLabel
private
String
getShortLabel
String
shortLabel
if
label
label
length
shortLabel
this
label
substring
log
shortLabel
Project
MSG_WARN
else
shortLabel
label
return
shortLabel
protected
String
getStyle
return
style
style
protected
String
getVersionDateLabel
String
versionDateLabel
if
version
versionDateLabel
FLAG_VERSION
version
else
if
date
versionDateLabel
FLAG_VERSION_DATE
date
else
String
shortLabel
getShortLabel
if
shortLabel
shortLabel
equals
versionDateLabel
FLAG_VERSION_LABEL
shortLabel
return
versionDateLabel
protected
String
getVersion
return
version
FLAG_VERSION
version
protected
String
getLocalpath
String
lclPath
if
localPath
File
dir
getProject
resolveFile
localPath
if
dir
exists
boolean
done
dir
mkdirs
if
done
String
msg
localPath
throw
new
BuildException
msg
getLocation
getProject
log
dir
getAbsolutePath
lclPath
FLAG_OVERRIDE_WORKING_DIR
localPath
return
lclPath
protected
String
getComment
return
comment
FLAG_COMMENT
comment
FLAG_COMMENT
protected
String
getAutoresponse
if
autoResponse
return
FLAG_AUTORESPONSE_DEF
else
if
autoResponse
equalsIgnoreCase
return
FLAG_AUTORESPONSE_YES
else
if
autoResponse
equalsIgnoreCase
return
FLAG_AUTORESPONSE_NO
else
return
FLAG_AUTORESPONSE_DEF
protected
String
getLogin
return
vssLogin
FLAG_LOGIN
vssLogin
protected
String
getOutput
return
outputFileName
FLAG_OUTPUT
outputFileName
protected
String
getUser
return
user
FLAG_USER
user
protected
String
getVersionLabel
if
fromLabel
toLabel
return
if
fromLabel
toLabel
if
fromLabel
length
fromLabel
fromLabel
substring
log
fromLabel
Project
MSG_WARN
if
toLabel
length
toLabel
toLabel
substring
log
toLabel
Project
MSG_WARN
return
FLAG_VERSION_LABEL
toLabel
VALUE_FROMLABEL
fromLabel
else
if
fromLabel
if
fromLabel
length
fromLabel
fromLabel
substring
log
fromLabel
Project
MSG_WARN
return
FLAG_VERSION
VALUE_FROMLABEL
fromLabel
else
if
toLabel
length
toLabel
toLabel
substring
log
toLabel
Project
MSG_WARN
return
FLAG_VERSION_LABEL
toLabel
protected
String
getVersionDate
throws
BuildException
if
fromDate
toDate
numDays
Integer
MIN_VALUE
return
if
fromDate
toDate
return
FLAG_VERSION_DATE
toDate
VALUE_FROMDATE
fromDate
else
if
toDate
numDays
Integer
MIN_VALUE
try
return
FLAG_VERSION_DATE
toDate
VALUE_FROMDATE
calcDate
toDate
numDays
catch
ParseException
ex
String
msg
toDate
throw
new
BuildException
msg
getLocation
else
if
fromDate
numDays
Integer
MIN_VALUE
try
return
FLAG_VERSION_DATE
calcDate
fromDate
numDays
VALUE_FROMDATE
fromDate
catch
ParseException
ex
String
msg
fromDate
throw
new
BuildException
msg
getLocation
else
return
fromDate
FLAG_VERSION
VALUE_FROMDATE
fromDate
FLAG_VERSION_DATE
toDate
protected
String
getGetLocalCopy
return
getLocalCopy
FLAG_NO_GET
private
boolean
getFailOnError
return
getWritableFiles
equals
WRITABLE_SKIP
failOnError
public
String
getFileTimeStamp
if
timestamp
return
else
if
timestamp
getValue
equals
TIME_MODIFIED
return
FLAG_FILETIME_MODIFIED
else
if
timestamp
getValue
equals
TIME_UPDATED
return
FLAG_FILETIME_UPDATED
else
return
FLAG_FILETIME_DEF
public
String
getWritableFiles
if
writableFiles
return
else
if
writableFiles
getValue
equals
WRITABLE_REPLACE
return
FLAG_REPLACE_WRITABLE
else
if
writableFiles
getValue
equals
WRITABLE_SKIP
failOnError
return
FLAG_SKIP_WRITABLE
else
return
private
int
run
Commandline
cmd
try
Execute
exe
new
Execute
new
LogStreamHandler
this
Project
MSG_INFO
Project
MSG_WARN
if
serverPath
String
env
exe
getEnvironment
if
env
env
new
String
String
newEnv
new
String
env
length
System
arraycopy
env
newEnv
env
length
newEnv
env
length
serverPath
exe
setEnvironment
newEnv
exe
setAntRun
getProject
exe
setWorkingDirectory
getProject
getBaseDir
exe
setCommandline
cmd
getCommandline
exe
setVMLauncher
return
exe
execute
catch
IOException
e
throw
new
BuildException
e
getLocation
private
String
calcDate
String
startDate
int
daysToAdd
throws
ParseException
Calendar
calendar
new
GregorianCalendar
Date
currentDate
dateFormat
parse
startDate
calendar
setTime
currentDate
calendar
add
Calendar
DATE
daysToAdd
return
dateFormat
format
calendar
getTime
private
String
formatCommandLine
Commandline
cmd
StringBuffer
sBuff
new
StringBuffer
cmd
toString
int
indexUser
sBuff
substring
indexOf
FLAG_LOGIN
if
indexUser
int
indexPass
sBuff
substring
indexOf
indexUser
int
indexAfterPass
sBuff
substring
indexOf
indexPass
for
int
i
indexPass
i
indexAfterPass
i
sBuff
setCharAt
i
return
sBuff
toString
public
static
class
CurrentModUpdated
extends
EnumeratedAttribute
public
String
getValues
return
new
String
TIME_CURRENT
TIME_MODIFIED
TIME_UPDATED
public
static
class
WritableFiles
extends
EnumeratedAttribute
public
String
getValues
return
new
String
WRITABLE_REPLACE
WRITABLE_SKIP
WRITABLE_FAIL
