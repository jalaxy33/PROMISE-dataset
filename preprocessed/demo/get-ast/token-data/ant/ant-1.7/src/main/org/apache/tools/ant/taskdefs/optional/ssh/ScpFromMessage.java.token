package
org
apache
tools
ant
taskdefs
optional
ssh
import
java
io
File
import
java
io
IOException
import
java
io
EOFException
import
java
io
InputStream
import
java
io
OutputStream
import
java
io
FileOutputStream
import
java
io
ByteArrayOutputStream
import
com
jcraft
jsch
JSchException
import
com
jcraft
jsch
Session
import
com
jcraft
jsch
Channel
public
class
ScpFromMessage
extends
AbstractSshMessage
private
static
final
byte
LINE_FEED
private
static
final
int
BUFFER_SIZE
private
String
remoteFile
private
File
localFile
private
boolean
isRecursive
public
ScpFromMessage
Session
session
super
session
public
ScpFromMessage
boolean
verbose
Session
session
super
verbose
session
public
ScpFromMessage
boolean
verbose
Session
session
String
aRemoteFile
File
aLocalFile
boolean
recursive
super
verbose
session
this
remoteFile
aRemoteFile
this
localFile
aLocalFile
this
isRecursive
recursive
public
ScpFromMessage
Session
session
String
aRemoteFile
File
aLocalFile
boolean
recursive
this
session
aRemoteFile
aLocalFile
recursive
public
void
execute
throws
IOException
JSchException
String
command
if
isRecursive
command
command
remoteFile
Channel
channel
openExecChannel
command
try
OutputStream
out
channel
getOutputStream
InputStream
in
channel
getInputStream
channel
connect
sendAck
out
startRemoteCpProtocol
in
out
localFile
finally
if
channel
channel
disconnect
log
private
void
startRemoteCpProtocol
InputStream
in
OutputStream
out
File
localFile
throws
IOException
File
startFile
localFile
while
ByteArrayOutputStream
stream
new
ByteArrayOutputStream
while
int
read
in
read
if
read
return
if
byte
read
LINE_FEED
break
stream
write
read
String
serverResponse
stream
toString
if
serverResponse
charAt
parseAndFetchFile
serverResponse
startFile
out
in
else
if
serverResponse
charAt
startFile
parseAndCreateDirectory
serverResponse
startFile
sendAck
out
else
if
serverResponse
charAt
startFile
startFile
getParentFile
sendAck
out
else
if
serverResponse
charAt
serverResponse
charAt
throw
new
IOException
serverResponse
substring
private
File
parseAndCreateDirectory
String
serverResponse
File
localFile
int
start
serverResponse
indexOf
start
serverResponse
indexOf
start
String
directoryName
serverResponse
substring
start
if
localFile
isDirectory
File
dir
new
File
localFile
directoryName
dir
mkdir
log
dir
return
dir
return
private
void
parseAndFetchFile
String
serverResponse
File
localFile
OutputStream
out
InputStream
in
throws
IOException
int
start
int
end
serverResponse
indexOf
start
start
end
end
serverResponse
indexOf
start
long
filesize
Long
parseLong
serverResponse
substring
start
end
String
filename
serverResponse
substring
end
log
filename
filesize
File
transferFile
localFile
isDirectory
new
File
localFile
filename
localFile
fetchFile
transferFile
filesize
out
in
waitForAck
in
sendAck
out
private
void
fetchFile
File
localFile
long
filesize
OutputStream
out
InputStream
in
throws
IOException
byte
buf
new
byte
BUFFER_SIZE
sendAck
out
FileOutputStream
fos
new
FileOutputStream
localFile
int
length
long
totalLength
long
startTime
System
currentTimeMillis
boolean
trackProgress
getVerbose
filesize
long
initFilesize
filesize
int
percentTransmitted
try
while
length
in
read
buf
BUFFER_SIZE
filesize
BUFFER_SIZE
int
filesize
if
length
throw
new
EOFException
fos
write
buf
length
filesize
length
totalLength
length
if
filesize
break
if
trackProgress
percentTransmitted
trackProgress
initFilesize
totalLength
percentTransmitted
finally
long
endTime
System
currentTimeMillis
logStats
startTime
endTime
totalLength
fos
flush
fos
close
