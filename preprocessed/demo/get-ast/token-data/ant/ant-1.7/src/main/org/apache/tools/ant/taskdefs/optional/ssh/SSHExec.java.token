package
org
apache
tools
ant
taskdefs
optional
ssh
import
org
apache
tools
ant
BuildException
import
org
apache
tools
ant
Project
import
org
apache
tools
ant
util
TeeOutputStream
import
org
apache
tools
ant
util
KeepAliveOutputStream
import
java
io
ByteArrayOutputStream
import
java
io
File
import
java
io
FileWriter
import
java
io
IOException
import
java
io
StringReader
import
com
jcraft
jsch
ChannelExec
import
com
jcraft
jsch
JSchException
import
com
jcraft
jsch
Session
public
class
SSHExec
extends
SSHBase
private
String
command
private
long
maxwait
private
Thread
thread
private
String
outputProperty
private
File
outputFile
private
boolean
append
private
static
final
String
TIMEOUT_MESSAGE
public
SSHExec
super
public
void
setCommand
String
command
this
command
command
public
void
setTimeout
long
timeout
maxwait
timeout
public
void
setOutput
File
output
outputFile
output
public
void
setAppend
boolean
append
this
append
append
public
void
setOutputproperty
String
property
outputProperty
property
public
void
execute
throws
BuildException
if
getHost
throw
new
BuildException
if
getUserInfo
getName
throw
new
BuildException
if
getUserInfo
getKeyfile
getUserInfo
getPassword
throw
new
BuildException
if
command
throw
new
BuildException
ByteArrayOutputStream
out
new
ByteArrayOutputStream
TeeOutputStream
tee
new
TeeOutputStream
out
new
KeepAliveOutputStream
System
out
Session
session
try
session
openSession
session
setTimeout
int
maxwait
final
ChannelExec
channel
ChannelExec
session
openChannel
channel
setCommand
command
channel
setOutputStream
tee
channel
setExtOutputStream
tee
channel
connect
thread
new
Thread
public
void
run
while
channel
isEOF
if
thread
return
try
sleep
catch
Exception
e
thread
start
thread
join
maxwait
if
thread
isAlive
thread
if
getFailonerror
throw
new
BuildException
TIMEOUT_MESSAGE
else
log
TIMEOUT_MESSAGE
Project
MSG_ERR
else
if
outputProperty
getProject
setProperty
outputProperty
out
toString
if
outputFile
writeToFile
out
toString
append
outputFile
int
ec
channel
getExitStatus
if
ec
String
msg
ec
if
getFailonerror
throw
new
BuildException
msg
else
log
msg
Project
MSG_ERR
catch
BuildException
e
throw
e
catch
JSchException
e
if
e
getMessage
indexOf
if
getFailonerror
throw
new
BuildException
TIMEOUT_MESSAGE
e
else
log
TIMEOUT_MESSAGE
Project
MSG_ERR
else
if
getFailonerror
throw
new
BuildException
e
else
log
e
getMessage
Project
MSG_ERR
catch
Exception
e
if
getFailonerror
throw
new
BuildException
e
else
log
e
getMessage
Project
MSG_ERR
finally
if
session
session
isConnected
session
disconnect
private
void
writeToFile
String
from
boolean
append
File
to
throws
IOException
FileWriter
out
try
out
new
FileWriter
to
getAbsolutePath
append
StringReader
in
new
StringReader
from
char
buffer
new
char
int
bytesRead
while
bytesRead
in
read
buffer
if
bytesRead
break
out
write
buffer
bytesRead
out
flush
finally
if
out
out
close
