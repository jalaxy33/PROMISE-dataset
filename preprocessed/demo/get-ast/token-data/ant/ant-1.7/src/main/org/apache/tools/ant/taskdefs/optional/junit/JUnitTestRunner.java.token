package
org
apache
tools
ant
taskdefs
optional
junit
import
java
io
BufferedReader
import
java
io
ByteArrayOutputStream
import
java
io
File
import
java
io
FileInputStream
import
java
io
FileWriter
import
java
io
IOException
import
java
io
OutputStream
import
java
io
PrintStream
import
java
io
PrintWriter
import
java
io
StringReader
import
java
io
StringWriter
import
java
lang
reflect
Method
import
java
util
Enumeration
import
java
util
Hashtable
import
java
util
Properties
import
java
util
StringTokenizer
import
java
util
Vector
import
junit
framework
AssertionFailedError
import
junit
framework
Test
import
junit
framework
TestFailure
import
junit
framework
TestListener
import
junit
framework
TestResult
import
junit
framework
TestSuite
import
org
apache
tools
ant
BuildException
import
org
apache
tools
ant
Project
import
org
apache
tools
ant
types
Permissions
import
org
apache
tools
ant
util
StringUtils
import
org
apache
tools
ant
util
TeeOutputStream
public
class
JUnitTestRunner
implements
TestListener
JUnitTaskMirror
JUnitTestRunnerMirror
private
Vector
formatters
new
Vector
private
TestResult
res
private
static
boolean
filtertrace
private
boolean
showOutput
private
boolean
outputToFormatters
private
Permissions
perm
private
static
final
String
DEFAULT_TRACE_FILTERS
new
String
private
boolean
haltOnError
private
boolean
haltOnFailure
private
int
retCode
SUCCESS
private
JUnitTest
junitTest
private
PrintStream
systemError
private
PrintStream
systemOut
private
boolean
forked
private
static
boolean
multipleTests
private
ClassLoader
loader
private
boolean
logTestListenerEvents
private
boolean
junit4
private
static
String
crashFile
public
JUnitTestRunner
JUnitTest
test
boolean
haltOnError
boolean
filtertrace
boolean
haltOnFailure
this
test
haltOnError
filtertrace
haltOnFailure
public
JUnitTestRunner
JUnitTest
test
boolean
haltOnError
boolean
filtertrace
boolean
haltOnFailure
boolean
showOutput
this
test
haltOnError
filtertrace
haltOnFailure
showOutput
public
JUnitTestRunner
JUnitTest
test
boolean
haltOnError
boolean
filtertrace
boolean
haltOnFailure
boolean
showOutput
boolean
logTestListenerEvents
this
test
haltOnError
filtertrace
haltOnFailure
showOutput
logTestListenerEvents
public
JUnitTestRunner
JUnitTest
test
boolean
haltOnError
boolean
filtertrace
boolean
haltOnFailure
ClassLoader
loader
this
test
haltOnError
filtertrace
haltOnFailure
loader
public
JUnitTestRunner
JUnitTest
test
boolean
haltOnError
boolean
filtertrace
boolean
haltOnFailure
boolean
showOutput
ClassLoader
loader
this
test
haltOnError
filtertrace
haltOnFailure
showOutput
loader
public
JUnitTestRunner
JUnitTest
test
boolean
haltOnError
boolean
filtertrace
boolean
haltOnFailure
boolean
showOutput
boolean
logTestListenerEvents
ClassLoader
loader
JUnitTestRunner
filtertrace
filtertrace
this
junitTest
test
this
haltOnError
haltOnError
this
haltOnFailure
haltOnFailure
this
showOutput
showOutput
this
logTestListenerEvents
logTestListenerEvents
this
loader
loader
private
PrintStream
savedOut
public
void
run
res
new
TestResult
res
addListener
wrapListener
this
for
int
i
i
formatters
size
i
res
addListener
wrapListener
TestListener
formatters
elementAt
i
ByteArrayOutputStream
errStrm
new
ByteArrayOutputStream
systemError
new
PrintStream
errStrm
ByteArrayOutputStream
outStrm
new
ByteArrayOutputStream
systemOut
new
PrintStream
outStrm
PrintStream
savedErr
if
forked
if
outputToFormatters
if
showOutput
savedOut
System
out
savedErr
System
err
System
setOut
new
PrintStream
new
OutputStream
public
void
write
int
b
System
setErr
new
PrintStream
new
OutputStream
public
void
write
int
b
else
savedOut
System
out
savedErr
System
err
if
showOutput
System
setOut
systemOut
System
setErr
systemError
else
System
setOut
new
PrintStream
new
TeeOutputStream
savedOut
systemOut
System
setErr
new
PrintStream
new
TeeOutputStream
savedErr
systemError
perm
else
if
perm
perm
setSecurityManager
Test
suite
Throwable
exception
boolean
startTestSuiteSuccess
try
try
Class
testClass
if
loader
testClass
Class
forName
junitTest
getName
else
testClass
Class
forName
junitTest
getName
loader
Method
suiteMethod
try
suiteMethod
testClass
getMethod
new
Class
catch
NoSuchMethodException
e
if
suiteMethod
suite
Test
suiteMethod
invoke
new
Class
else
Class
junit4TestAdapterClass
try
Class
forName
if
loader
junit4TestAdapterClass
Class
forName
else
junit4TestAdapterClass
Class
forName
loader
catch
ClassNotFoundException
e
junit4
junit4TestAdapterClass
if
junit4
suite
Test
junit4TestAdapterClass
getConstructor
new
Class
Class
class
newInstance
new
Object
testClass
else
suite
new
TestSuite
testClass
catch
Throwable
e
retCode
ERRORS
exception
e
long
start
System
currentTimeMillis
fireStartTestSuite
startTestSuiteSuccess
if
exception
for
int
i
i
formatters
size
i
TestListener
formatters
elementAt
i
addError
exception
junitTest
setCounts
junitTest
setRunTime
else
try
logTestListenerEvent
suite
countTestCases
suite
run
res
finally
if
junit4
int
cnts
findJUnit4FailureErrorCount
res
junitTest
setCounts
res
runCount
cnts
cnts
else
junitTest
setCounts
res
runCount
res
failureCount
res
errorCount
junitTest
setRunTime
System
currentTimeMillis
start
finally
if
perm
perm
restoreSecurityManager
if
savedOut
System
setOut
savedOut
if
savedErr
System
setErr
savedErr
systemError
close
systemError
systemOut
close
systemOut
if
startTestSuiteSuccess
sendOutAndErr
new
String
outStrm
toByteArray
new
String
errStrm
toByteArray
fireEndTestSuite
if
retCode
SUCCESS
res
errorCount
retCode
ERRORS
else
if
res
failureCount
retCode
FAILURES
public
int
getRetCode
return
retCode
public
void
startTest
Test
t
String
testName
JUnitVersionHelper
getTestCaseName
t
logTestListenerEvent
testName
public
void
endTest
Test
test
String
testName
JUnitVersionHelper
getTestCaseName
test
logTestListenerEvent
testName
private
void
logTestListenerEvent
String
msg
PrintStream
out
savedOut
savedOut
System
out
if
logTestListenerEvents
out
flush
out
println
JUnitTask
TESTLISTENER_PREFIX
msg
out
flush
public
void
addFailure
Test
test
Throwable
t
String
testName
JUnitVersionHelper
getTestCaseName
test
logTestListenerEvent
testName
t
getMessage
if
haltOnFailure
res
stop
public
void
addFailure
Test
test
AssertionFailedError
t
addFailure
test
Throwable
t
public
void
addError
Test
test
Throwable
t
String
testName
JUnitVersionHelper
getTestCaseName
test
logTestListenerEvent
testName
t
getMessage
if
haltOnError
res
stop
public
void
setPermissions
Permissions
permissions
perm
permissions
public
void
handleOutput
String
output
if
logTestListenerEvents
output
startsWith
JUnitTask
TESTLISTENER_PREFIX
else
if
systemOut
systemOut
print
output
public
int
handleInput
byte
buffer
int
offset
int
length
throws
IOException
return
public
void
handleErrorOutput
String
output
if
systemError
systemError
print
output
public
void
handleFlush
String
output
if
systemOut
systemOut
print
output
public
void
handleErrorFlush
String
output
if
systemError
systemError
print
output
private
void
sendOutAndErr
String
out
String
err
for
int
i
i
formatters
size
i
JUnitResultFormatter
formatter
JUnitResultFormatter
formatters
elementAt
i
formatter
setSystemOutput
out
formatter
setSystemError
err
private
void
fireStartTestSuite
for
int
i
i
formatters
size
i
JUnitResultFormatter
formatters
elementAt
i
startTestSuite
junitTest
private
void
fireEndTestSuite
for
int
i
i
formatters
size
i
JUnitResultFormatter
formatters
elementAt
i
endTestSuite
junitTest
public
void
addFormatter
JUnitResultFormatter
f
formatters
addElement
f
public
void
addFormatter
JUnitTaskMirror
JUnitResultFormatterMirror
f
formatters
addElement
JUnitResultFormatter
f
public
static
void
main
String
args
throws
IOException
boolean
haltError
boolean
haltFail
boolean
stackfilter
Properties
props
new
Properties
boolean
showOut
boolean
outputToFormat
boolean
logTestListenerEvents
if
args
length
System
err
println
System
exit
ERRORS
if
args
startsWith
Constants
TESTSFILE
multipleTests
args
args
substring
Constants
TESTSFILE
length
for
int
i
i
args
length
i
if
args
i
startsWith
Constants
HALT_ON_ERROR
haltError
Project
toBoolean
args
i
substring
Constants
HALT_ON_ERROR
length
else
if
args
i
startsWith
Constants
HALT_ON_FAILURE
haltFail
Project
toBoolean
args
i
substring
Constants
HALT_ON_FAILURE
length
else
if
args
i
startsWith
Constants
FILTERTRACE
stackfilter
Project
toBoolean
args
i
substring
Constants
FILTERTRACE
length
else
if
args
i
startsWith
Constants
CRASHFILE
crashFile
args
i
substring
Constants
CRASHFILE
length
registerTestCase
Constants
BEFORE_FIRST_TEST
else
if
args
i
startsWith
Constants
FORMATTER
try
createAndStoreFormatter
args
i
substring
Constants
FORMATTER
length
catch
BuildException
be
System
err
println
be
getMessage
System
exit
ERRORS
else
if
args
i
startsWith
Constants
PROPSFILE
FileInputStream
in
new
FileInputStream
args
i
substring
Constants
PROPSFILE
length
props
load
in
in
close
else
if
args
i
startsWith
Constants
SHOWOUTPUT
showOut
Project
toBoolean
args
i
substring
Constants
SHOWOUTPUT
length
else
if
args
i
startsWith
Constants
LOGTESTLISTENEREVENTS
logTestListenerEvents
Project
toBoolean
args
i
substring
Constants
LOGTESTLISTENEREVENTS
length
else
if
args
i
startsWith
Constants
OUTPUT_TO_FORMATTERS
outputToFormat
Project
toBoolean
args
i
substring
Constants
OUTPUT_TO_FORMATTERS
length
Hashtable
p
System
getProperties
for
Enumeration
e
p
keys
e
hasMoreElements
Object
key
e
nextElement
props
put
key
p
get
key
int
returnCode
SUCCESS
if
multipleTests
try
java
io
BufferedReader
reader
new
java
io
BufferedReader
new
java
io
FileReader
args
String
testCaseName
int
code
boolean
errorOccurred
boolean
failureOccurred
String
line
while
line
reader
readLine
StringTokenizer
st
new
StringTokenizer
line
testCaseName
st
nextToken
JUnitTest
t
new
JUnitTest
testCaseName
t
setTodir
new
File
st
nextToken
t
setOutfile
st
nextToken
code
launch
t
haltError
stackfilter
haltFail
showOut
outputToFormat
logTestListenerEvents
props
errorOccurred
code
ERRORS
failureOccurred
code
SUCCESS
if
errorOccurred
failureOccurred
if
errorOccurred
haltError
failureOccurred
haltFail
registerNonCrash
System
exit
code
else
if
code
returnCode
returnCode
code
System
out
println
t
getName
catch
IOException
e
e
printStackTrace
else
returnCode
launch
new
JUnitTest
args
haltError
stackfilter
haltFail
showOut
outputToFormat
logTestListenerEvents
props
registerNonCrash
System
exit
returnCode
private
static
Vector
fromCmdLine
new
Vector
private
static
void
transferFormatters
JUnitTestRunner
runner
JUnitTest
test
runner
addFormatter
new
JUnitResultFormatter
public
void
startTestSuite
JUnitTest
suite
throws
BuildException
public
void
endTestSuite
JUnitTest
suite
throws
BuildException
public
void
setOutput
OutputStream
out
public
void
setSystemOutput
String
out
public
void
setSystemError
String
err
public
void
addError
Test
arg0
Throwable
arg1
public
void
addFailure
Test
arg0
AssertionFailedError
arg1
public
void
endTest
Test
arg0
public
void
startTest
Test
arg0
registerTestCase
JUnitVersionHelper
getTestCaseName
arg0
for
int
i
i
fromCmdLine
size
i
FormatterElement
fe
FormatterElement
fromCmdLine
elementAt
i
if
multipleTests
fe
getUseFile
File
destFile
new
File
test
getTodir
test
getOutfile
fe
getExtension
fe
setOutfile
destFile
runner
addFormatter
JUnitResultFormatter
fe
createFormatter
private
static
void
createAndStoreFormatter
String
line
throws
BuildException
FormatterElement
fe
new
FormatterElement
int
pos
line
indexOf
if
pos
fe
setClassname
line
fe
setUseFile
else
fe
setClassname
line
substring
pos
fe
setUseFile
if
multipleTests
fe
setOutfile
new
File
line
substring
pos
else
int
fName
line
indexOf
IGNORED_FILE_NAME
if
fName
fe
setExtension
line
substring
fName
IGNORED_FILE_NAME
length
fromCmdLine
addElement
fe
public
static
String
getFilteredTrace
Throwable
t
String
trace
StringUtils
getStackTrace
t
return
JUnitTestRunner
filterStack
trace
public
static
String
filterStack
String
stack
if
filtertrace
return
stack
StringWriter
sw
new
StringWriter
PrintWriter
pw
new
PrintWriter
sw
StringReader
sr
new
StringReader
stack
BufferedReader
br
new
BufferedReader
sr
String
line
try
while
line
br
readLine
if
filterLine
line
pw
println
line
catch
Exception
e
return
stack
return
sw
toString
private
static
boolean
filterLine
String
line
for
int
i
i
DEFAULT_TRACE_FILTERS
length
i
if
line
indexOf
DEFAULT_TRACE_FILTERS
i
return
return
private
static
int
launch
JUnitTest
t
boolean
haltError
boolean
stackfilter
boolean
haltFail
boolean
showOut
boolean
outputToFormat
boolean
logTestListenerEvents
Properties
props
t
setProperties
props
JUnitTestRunner
runner
new
JUnitTestRunner
t
haltError
stackfilter
haltFail
showOut
logTestListenerEvents
runner
forked
runner
outputToFormatters
outputToFormat
transferFormatters
runner
t
runner
run
return
runner
getRetCode
private
static
void
registerNonCrash
throws
IOException
if
crashFile
FileWriter
out
try
out
new
FileWriter
crashFile
out
write
Constants
TERMINATED_SUCCESSFULLY
out
flush
finally
if
out
out
close
private
static
void
registerTestCase
String
testCase
if
crashFile
try
FileWriter
out
try
out
new
FileWriter
crashFile
out
write
testCase
out
flush
finally
if
out
out
close
catch
IOException
e
private
TestListener
wrapListener
final
TestListener
testListener
return
new
TestListener
public
void
addError
Test
test
Throwable
t
if
junit4
t
instanceof
AssertionFailedError
testListener
addFailure
test
AssertionFailedError
t
else
if
junit4
t
getClass
getName
equals
try
String
msg
t
getMessage
AssertionFailedError
failure
msg
new
AssertionFailedError
msg
new
AssertionFailedError
Method
initCause
Throwable
class
getMethod
new
Class
Throwable
class
initCause
invoke
failure
new
Object
t
testListener
addFailure
test
failure
catch
Exception
e
e
printStackTrace
testListener
addError
test
t
else
testListener
addError
test
t
public
void
addFailure
Test
test
AssertionFailedError
t
testListener
addFailure
test
t
public
void
addFailure
Test
test
Throwable
t
if
t
instanceof
AssertionFailedError
testListener
addFailure
test
AssertionFailedError
t
else
testListener
addError
test
t
public
void
endTest
Test
test
testListener
endTest
test
public
void
startTest
Test
test
testListener
startTest
test
private
int
findJUnit4FailureErrorCount
TestResult
res
int
failures
int
errors
Enumeration
e
res
failures
while
e
hasMoreElements
e
nextElement
failures
e
res
errors
while
e
hasMoreElements
Throwable
t
TestFailure
e
nextElement
thrownException
if
t
instanceof
AssertionFailedError
t
getClass
getName
equals
failures
else
errors
return
new
int
failures
errors
