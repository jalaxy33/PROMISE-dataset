package
org
apache
tools
ant
taskdefs
import
org
apache
tools
ant
BuildException
import
org
apache
tools
ant
DirectoryScanner
import
org
apache
tools
ant
Project
import
org
apache
tools
ant
types
EnumeratedAttribute
import
java
io
import
java
util
public
class
FixCRLF
extends
MatchingTask
private
static
final
int
UNDEF
private
static
final
int
NOTJAVA
private
static
final
int
LOOKING
private
static
final
int
IN_CHAR_CONST
private
static
final
int
IN_STR_CONST
private
static
final
int
IN_SINGLE_COMMENT
private
static
final
int
IN_MULTI_COMMENT
private
static
final
int
ASIS
private
static
final
int
CR
private
static
final
int
LF
private
static
final
int
CRLF
private
static
final
int
ADD
private
static
final
int
REMOVE
private
static
final
int
SPACES
private
static
final
int
TABS
private
static
final
int
INBUFLEN
private
static
final
int
LINEBUFLEN
private
static
final
char
CTRLZ
private
int
tablength
private
String
spaces
private
StringBuffer
linebuf
new
StringBuffer
private
StringBuffer
linebuf2
new
StringBuffer
private
int
eol
private
String
eolstr
private
int
ctrlz
private
int
tabs
private
boolean
javafiles
private
File
srcDir
private
File
destDir
public
FixCRLF
tabs
ASIS
if
System
getProperty
equals
ctrlz
REMOVE
if
System
getProperty
indexOf
eol
CR
eolstr
else
eol
LF
eolstr
else
ctrlz
ASIS
eol
CRLF
eolstr
public
void
setSrcdir
File
srcDir
this
srcDir
srcDir
public
void
setDestdir
File
destDir
this
destDir
destDir
public
void
setJavafiles
boolean
javafiles
this
javafiles
javafiles
public
void
setEol
CrLf
attr
String
option
attr
getValue
if
option
equals
eol
ASIS
else
if
option
equals
eol
CR
eolstr
else
if
option
equals
eol
LF
eolstr
else
eol
CRLF
eolstr
public
void
setCr
AddAsisRemove
attr
log
Project
MSG_WARN
log
Project
MSG_WARN
String
option
attr
getValue
CrLf
c
new
CrLf
if
option
equals
c
setValue
else
if
option
equals
c
setValue
else
c
setValue
setEol
c
public
void
setTab
AddAsisRemove
attr
String
option
attr
getValue
if
option
equals
tabs
SPACES
else
if
option
equals
tabs
ASIS
else
tabs
TABS
public
void
setTablength
int
tlength
throws
BuildException
if
tlength
tlength
throw
new
BuildException
location
tablength
tlength
StringBuffer
sp
new
StringBuffer
for
int
i
i
tablength
i
sp
append
spaces
sp
toString
public
void
setEof
AddAsisRemove
attr
String
option
attr
getValue
if
option
equals
ctrlz
REMOVE
else
if
option
equals
ctrlz
ASIS
else
ctrlz
ADD
public
void
execute
throws
BuildException
if
srcDir
throw
new
BuildException
if
srcDir
exists
throw
new
BuildException
if
srcDir
isDirectory
throw
new
BuildException
if
destDir
if
destDir
exists
throw
new
BuildException
if
destDir
isDirectory
throw
new
BuildException
log
eol
ASIS
eol
CR
eol
LF
tabs
TABS
tabs
ASIS
ctrlz
ADD
ctrlz
ASIS
tablength
Project
MSG_VERBOSE
DirectoryScanner
ds
super
getDirectoryScanner
srcDir
String
files
ds
getIncludedFiles
for
int
i
i
files
length
i
processFile
files
i
private
File
createTempFile
String
name
new
Random
System
currentTimeMillis
nextLong
if
destDir
return
new
File
srcDir
name
else
return
new
File
destDir
name
private
boolean
filesEqual
File
file1
File
file2
BufferedReader
reader1
BufferedReader
reader2
char
buf1
new
char
INBUFLEN
char
buf2
new
char
INBUFLEN
int
buflen
if
file1
length
file2
length
return
try
reader1
new
BufferedReader
new
FileReader
file1
INBUFLEN
reader2
new
BufferedReader
new
FileReader
file2
INBUFLEN
while
buflen
reader1
read
buf1
INBUFLEN
reader2
read
buf2
INBUFLEN
for
int
i
i
buflen
i
if
buf1
i
buf2
i
reader1
close
reader2
close
return
reader1
close
reader2
close
return
catch
IOException
e
throw
new
BuildException
file1
file2
private
void
processFile
String
file
throws
BuildException
File
srcFile
new
File
srcDir
file
File
tmpFile
BufferedWriter
outWriter
OneLiner
BufferLine
line
OneLiner
lines
new
OneLiner
srcFile
try
try
tmpFile
createTempFile
FileWriter
writer
new
FileWriter
tmpFile
outWriter
new
BufferedWriter
writer
catch
IOException
e
throw
new
BuildException
e
while
lines
hasMoreElements
int
endComment
try
line
OneLiner
BufferLine
lines
nextElement
catch
NoSuchElementException
e
throw
new
BuildException
e
String
lineString
line
getLineString
int
linelen
line
length
if
tabs
ASIS
try
outWriter
write
lineString
catch
IOException
e
throw
new
BuildException
e
else
int
ptr
while
ptr
line
getNext
linelen
switch
lines
getState
case
NOTJAVA
notInConstant
line
line
length
outWriter
break
case
IN_MULTI_COMMENT
if
endComment
lineString
indexOf
line
getNext
endComment
lines
setState
LOOKING
else
endComment
linelen
notInConstant
line
endComment
outWriter
break
case
IN_SINGLE_COMMENT
notInConstant
line
line
length
outWriter
lines
setState
LOOKING
break
case
IN_CHAR_CONST
case
IN_STR_CONST
int
begin
line
getNext
char
terminator
lines
getState
IN_STR_CONST
endOfCharConst
line
terminator
while
line
getNext
line
getLookahead
if
line
getNextCharInc
line
setColumn
line
getColumn
tablength
line
getColumn
tablength
else
line
incColumn
try
outWriter
write
line
substring
begin
line
getNext
catch
IOException
e
throw
new
BuildException
e
lines
setState
LOOKING
break
case
LOOKING
nextStateChange
line
notInConstant
line
line
getLookahead
outWriter
break
try
outWriter
write
eolstr
catch
IOException
e
throw
new
BuildException
e
try
if
ctrlz
ASIS
outWriter
write
lines
getEofStr
else
if
ctrlz
ADD
outWriter
write
CTRLZ
outWriter
close
catch
IOException
e
throw
new
BuildException
e
File
destFile
new
File
destDir
srcDir
destDir
file
try
lines
close
lines
catch
IOException
e
throw
new
BuildException
srcFile
if
destFile
exists
log
Project
MSG_DEBUG
if
filesEqual
destFile
tmpFile
log
destFile
Project
MSG_DEBUG
if
destFile
delete
throw
new
BuildException
destFile
if
tmpFile
renameTo
destFile
throw
new
BuildException
srcFile
destFile
tmpFile
else
log
destFile
Project
MSG_DEBUG
if
tmpFile
delete
throw
new
BuildException
tmpFile
else
log
Project
MSG_DEBUG
if
tmpFile
renameTo
destFile
throw
new
BuildException
srcFile
destFile
tmpFile
tmpFile
finally
try
if
lines
lines
close
catch
IOException
io
log
srcFile
Project
MSG_ERR
if
tmpFile
tmpFile
delete
private
void
nextStateChange
OneLiner
BufferLine
bufline
throws
BuildException
int
eol
bufline
length
int
ptr
bufline
getNext
while
ptr
eol
switch
bufline
getChar
ptr
case
bufline
setState
IN_CHAR_CONST
bufline
setLookahead
ptr
return
case
bufline
setState
IN_STR_CONST
bufline
setLookahead
ptr
return
case
if
ptr
eol
if
bufline
getChar
ptr
bufline
setState
IN_MULTI_COMMENT
bufline
setLookahead
ptr
return
else
if
bufline
getChar
ptr
bufline
setState
IN_SINGLE_COMMENT
bufline
setLookahead
ptr
return
break
bufline
setLookahead
ptr
private
void
endOfCharConst
OneLiner
BufferLine
bufline
char
terminator
throws
BuildException
int
ptr
bufline
getNext
int
eol
bufline
length
char
c
ptr
while
ptr
eol
if
c
bufline
getChar
ptr
ptr
else
if
c
terminator
bufline
setLookahead
ptr
return
throw
new
BuildException
private
void
notInConstant
OneLiner
BufferLine
bufline
int
end
BufferedWriter
outWriter
int
nextTab
int
nextStop
int
tabspaces
String
line
bufline
substring
bufline
getNext
end
int
place
int
col
bufline
getColumn
linebuf
setLength
while
nextTab
line
indexOf
int
place
linebuf
append
line
substring
place
nextTab
col
nextTab
place
tabspaces
tablength
col
tablength
linebuf
append
spaces
substring
tabspaces
col
tabspaces
place
nextTab
linebuf
append
line
substring
place
line
length
String
linestring
new
String
linebuf
toString
if
tabs
REMOVE
try
outWriter
write
linestring
catch
IOException
e
throw
new
BuildException
e
else
int
tabCol
linebuf2
setLength
place
col
bufline
getColumn
int
placediff
col
nextStop
col
tablength
col
tablength
if
nextStop
col
linebuf2
append
linestring
substring
place
nextStop
placediff
place
nextStop
placediff
nextStop
tablength
for
nextStop
placediff
linestring
length
nextStop
tablength
for
tabCol
nextStop
tabCol
placediff
place
linestring
charAt
tabCol
placediff
if
nextStop
tabCol
linebuf2
append
linestring
substring
place
tabCol
placediff
linebuf2
append
else
linebuf2
append
linestring
substring
place
nextStop
placediff
place
nextStop
placediff
linebuf2
append
linestring
substring
place
linestring
length
try
outWriter
write
linebuf2
toString
catch
IOException
e
throw
new
BuildException
e
bufline
setColumn
bufline
getColumn
linestring
length
bufline
setNext
end
class
OneLiner
implements
Enumeration
private
int
state
javafiles
LOOKING
NOTJAVA
private
StringBuffer
eolStr
new
StringBuffer
LINEBUFLEN
private
StringBuffer
eofStr
new
StringBuffer
private
BufferedReader
reader
private
String
line
public
OneLiner
File
srcFile
throws
BuildException
try
reader
new
BufferedReader
new
FileReader
srcFile
INBUFLEN
nextLine
catch
IOException
e
throw
new
BuildException
e
protected
void
nextLine
throws
BuildException
int
ch
int
eolcount
eolStr
setLength
try
int
linelen
reader
mark
INBUFLEN
line
reader
readLine
if
line
linelen
else
linelen
line
length
reader
reset
reader
skip
long
linelen
reader
mark
INBUFLEN
ch
reader
read
switch
char
ch
case
eolcount
eolStr
append
switch
char
ch
reader
read
case
if
char
ch
reader
read
eolcount
eolStr
append
break
case
eolcount
eolStr
append
break
break
case
eolcount
eolStr
append
break
reader
reset
reader
skip
long
eolcount
if
line
eolcount
int
i
linelen
while
i
line
charAt
i
CTRLZ
if
i
linelen
eofStr
append
line
substring
i
line
i
line
substring
i
catch
IOException
e
throw
new
BuildException
e
public
String
getEofStr
return
eofStr
toString
public
int
getState
return
state
public
void
setState
int
state
this
state
state
public
boolean
hasMoreElements
return
line
public
Object
nextElement
throws
NoSuchElementException
if
hasMoreElements
throw
new
NoSuchElementException
BufferLine
tmpLine
new
BufferLine
line
eolStr
toString
nextLine
return
tmpLine
public
void
close
throws
IOException
if
reader
reader
close
class
BufferLine
private
int
next
private
int
column
private
int
lookahead
UNDEF
private
String
line
private
String
eolStr
public
BufferLine
String
line
String
eolStr
throws
BuildException
next
column
this
line
line
this
eolStr
eolStr
public
int
getNext
return
next
public
void
setNext
int
next
this
next
next
public
int
getLookahead
return
lookahead
public
void
setLookahead
int
lookahead
this
lookahead
lookahead
public
char
getChar
int
i
return
line
charAt
i
public
char
getNextChar
return
getChar
next
public
char
getNextCharInc
return
getChar
next
public
int
getColumn
return
column
public
void
setColumn
int
col
column
col
public
int
incColumn
return
column
public
int
length
return
line
length
public
int
getEolLength
return
eolStr
length
public
String
getLineString
return
line
public
String
getEol
return
eolStr
public
String
substring
int
begin
return
line
substring
begin
public
String
substring
int
begin
int
end
return
line
substring
begin
end
public
void
setState
int
state
OneLiner
this
setState
state
public
int
getState
return
OneLiner
this
getState
public
static
class
AddAsisRemove
extends
EnumeratedAttribute
public
String
getValues
return
new
String
public
static
class
CrLf
extends
EnumeratedAttribute
public
String
getValues
return
new
String
