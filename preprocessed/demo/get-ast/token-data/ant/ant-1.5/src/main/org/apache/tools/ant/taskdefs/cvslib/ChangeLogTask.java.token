package
org
apache
tools
ant
taskdefs
cvslib
import
java
io
File
import
java
io
FileInputStream
import
java
io
FileOutputStream
import
java
io
IOException
import
java
io
OutputStreamWriter
import
java
io
PrintWriter
import
java
io
UnsupportedEncodingException
import
java
text
SimpleDateFormat
import
java
util
Date
import
java
util
Enumeration
import
java
util
Properties
import
java
util
Vector
import
org
apache
tools
ant
BuildException
import
org
apache
tools
ant
Project
import
org
apache
tools
ant
Task
import
org
apache
tools
ant
DirectoryScanner
import
org
apache
tools
ant
taskdefs
Execute
import
org
apache
tools
ant
types
Commandline
import
org
apache
tools
ant
types
FileSet
public
class
ChangeLogTask
extends
Task
private
File
m_usersFile
private
Vector
m_cvsUsers
new
Vector
private
File
m_dir
private
File
m_destfile
private
Date
m_start
private
Date
m_stop
private
final
Vector
m_filesets
new
Vector
public
void
setDir
final
File
dir
m_dir
dir
public
void
setDestfile
final
File
destfile
m_destfile
destfile
public
void
setUsersfile
final
File
usersFile
m_usersFile
usersFile
public
void
addUser
final
CvsUser
user
m_cvsUsers
addElement
user
public
void
setStart
final
Date
start
m_start
start
public
void
setEnd
final
Date
stop
m_stop
stop
public
void
setDaysinpast
final
int
days
final
long
time
System
currentTimeMillis
long
days
setStart
new
Date
time
public
void
addFileset
final
FileSet
fileSet
m_filesets
addElement
fileSet
public
void
execute
throws
BuildException
File
savedDir
m_dir
try
validate
final
Properties
userList
new
Properties
loadUserlist
userList
for
Enumeration
e
m_cvsUsers
elements
e
hasMoreElements
final
CvsUser
user
CvsUser
e
nextElement
user
validate
userList
put
user
getUserID
user
getDisplayname
final
Commandline
command
new
Commandline
command
setExecutable
command
createArgument
setValue
if
m_start
final
SimpleDateFormat
outputDate
new
SimpleDateFormat
final
String
dateRange
outputDate
format
m_start
command
createArgument
setValue
dateRange
if
m_filesets
isEmpty
final
Enumeration
e
m_filesets
elements
while
e
hasMoreElements
final
FileSet
fileSet
FileSet
e
nextElement
final
DirectoryScanner
scanner
fileSet
getDirectoryScanner
project
final
String
files
scanner
getIncludedFiles
for
int
i
i
files
length
i
command
createArgument
setValue
files
i
final
ChangeLogParser
parser
new
ChangeLogParser
final
RedirectingStreamHandler
handler
new
RedirectingStreamHandler
parser
log
command
toString
Project
MSG_VERBOSE
final
Execute
exe
new
Execute
handler
exe
setWorkingDirectory
m_dir
exe
setCommandline
command
getCommandline
exe
setAntRun
getProject
try
final
int
resultCode
exe
execute
if
resultCode
throw
new
BuildException
catch
final
IOException
ioe
throw
new
BuildException
ioe
toString
final
String
errors
handler
getErrors
if
errors
log
errors
Project
MSG_ERR
final
CVSEntry
entrySet
parser
getEntrySetAsArray
final
CVSEntry
filteredEntrySet
filterEntrySet
entrySet
replaceAuthorIdWithName
userList
filteredEntrySet
writeChangeLog
filteredEntrySet
finally
m_dir
savedDir
private
void
validate
throws
BuildException
if
m_dir
m_dir
getProject
getBaseDir
if
m_destfile
final
String
message
throw
new
BuildException
message
if
m_dir
exists
final
String
message
m_dir
getAbsolutePath
throw
new
BuildException
message
if
m_usersFile
m_usersFile
exists
final
String
message
m_usersFile
getAbsolutePath
throw
new
BuildException
message
private
void
loadUserlist
final
Properties
userList
throws
BuildException
if
m_usersFile
try
userList
load
new
FileInputStream
m_usersFile
catch
final
IOException
ioe
throw
new
BuildException
ioe
toString
ioe
private
CVSEntry
filterEntrySet
final
CVSEntry
entrySet
final
Vector
results
new
Vector
for
int
i
i
entrySet
length
i
final
CVSEntry
cvsEntry
entrySet
i
final
Date
date
cvsEntry
getDate
if
m_start
m_start
after
date
continue
if
m_stop
m_stop
before
date
continue
results
addElement
cvsEntry
final
CVSEntry
resultArray
new
CVSEntry
results
size
results
copyInto
resultArray
return
resultArray
private
void
replaceAuthorIdWithName
final
Properties
userList
final
CVSEntry
entrySet
for
int
i
i
entrySet
length
i
final
CVSEntry
entry
entrySet
i
if
userList
containsKey
entry
getAuthor
entry
setAuthor
userList
getProperty
entry
getAuthor
private
void
writeChangeLog
final
CVSEntry
entrySet
throws
BuildException
FileOutputStream
output
try
output
new
FileOutputStream
m_destfile
final
PrintWriter
writer
new
PrintWriter
new
OutputStreamWriter
output
final
ChangeLogWriter
serializer
new
ChangeLogWriter
serializer
printChangeLog
writer
entrySet
catch
final
UnsupportedEncodingException
uee
getProject
log
uee
toString
Project
MSG_ERR
catch
final
IOException
ioe
throw
new
BuildException
ioe
toString
ioe
finally
if
output
try
output
close
catch
final
IOException
ioe
