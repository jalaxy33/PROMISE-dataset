package
org
apache
tools
ant
taskdefs
import
java
io
BufferedReader
import
java
io
File
import
java
io
FileInputStream
import
java
io
FileOutputStream
import
java
io
InputStreamReader
import
java
io
IOException
import
java
security
DigestInputStream
import
java
security
MessageDigest
import
java
security
NoSuchAlgorithmException
import
java
security
NoSuchProviderException
import
java
util
Enumeration
import
java
util
Hashtable
import
java
util
Vector
import
org
apache
tools
ant
BuildException
import
org
apache
tools
ant
DirectoryScanner
import
org
apache
tools
ant
Project
import
org
apache
tools
ant
taskdefs
condition
Condition
import
org
apache
tools
ant
types
FileSet
public
class
Checksum
extends
MatchingTask
implements
Condition
private
File
file
private
String
algorithm
private
String
provider
private
String
fileext
private
String
property
private
boolean
forceOverwrite
private
String
verifyProperty
private
Vector
filesets
new
Vector
private
Hashtable
includeFileMap
new
Hashtable
private
MessageDigest
messageDigest
private
boolean
isCondition
private
int
readBufferSize
public
void
setFile
File
file
this
file
file
public
void
setAlgorithm
String
algorithm
this
algorithm
algorithm
public
void
setProvider
String
provider
this
provider
provider
public
void
setFileext
String
fileext
this
fileext
fileext
public
void
setProperty
String
property
this
property
property
public
void
setVerifyproperty
String
verifyProperty
this
verifyProperty
verifyProperty
public
void
setForceOverwrite
boolean
forceOverwrite
this
forceOverwrite
forceOverwrite
public
void
setReadBufferSize
int
size
this
readBufferSize
size
public
void
addFileset
FileSet
set
filesets
addElement
set
public
void
execute
throws
BuildException
isCondition
boolean
value
validateAndExecute
if
verifyProperty
project
setNewProperty
verifyProperty
new
Boolean
value
toString
public
boolean
eval
throws
BuildException
isCondition
return
validateAndExecute
private
boolean
validateAndExecute
throws
BuildException
String
savedFileExt
fileext
if
file
filesets
size
throw
new
BuildException
if
file
file
exists
file
isDirectory
throw
new
BuildException
if
property
fileext
throw
new
BuildException
if
property
if
forceOverwrite
throw
new
BuildException
if
file
if
filesets
size
throw
new
BuildException
else
if
filesets
size
throw
new
BuildException
if
verifyProperty
isCondition
if
verifyProperty
forceOverwrite
throw
new
BuildException
if
isCondition
forceOverwrite
throw
new
BuildException
messageDigest
if
provider
try
messageDigest
MessageDigest
getInstance
algorithm
provider
catch
NoSuchAlgorithmException
noalgo
throw
new
BuildException
noalgo
location
catch
NoSuchProviderException
noprovider
throw
new
BuildException
noprovider
location
else
try
messageDigest
MessageDigest
getInstance
algorithm
catch
NoSuchAlgorithmException
noalgo
throw
new
BuildException
noalgo
location
if
messageDigest
throw
new
BuildException
location
if
fileext
fileext
algorithm
else
if
fileext
trim
length
throw
new
BuildException
try
addToIncludeFileMap
file
int
sizeofFileSet
filesets
size
for
int
i
i
sizeofFileSet
i
FileSet
fs
FileSet
filesets
elementAt
i
DirectoryScanner
ds
fs
getDirectoryScanner
project
String
srcFiles
ds
getIncludedFiles
for
int
j
j
srcFiles
length
j
File
src
new
File
fs
getDir
project
srcFiles
j
addToIncludeFileMap
src
return
generateChecksums
finally
fileext
savedFileExt
includeFileMap
clear
private
void
addToIncludeFileMap
File
file
throws
BuildException
if
file
if
file
exists
if
property
File
dest
new
File
file
getParent
file
getName
fileext
if
forceOverwrite
isCondition
file
lastModified
dest
lastModified
includeFileMap
put
file
dest
else
log
file
dest
Project
MSG_VERBOSE
else
includeFileMap
put
file
property
else
String
message
file
getAbsolutePath
log
message
throw
new
BuildException
message
location
private
boolean
generateChecksums
throws
BuildException
boolean
checksumMatches
FileInputStream
fis
FileOutputStream
fos
byte
buf
new
byte
readBufferSize
try
for
Enumeration
e
includeFileMap
keys
e
hasMoreElements
messageDigest
reset
File
src
File
e
nextElement
if
isCondition
log
algorithm
src
fis
new
FileInputStream
src
DigestInputStream
dis
new
DigestInputStream
fis
messageDigest
while
dis
read
buf
readBufferSize
dis
close
fis
close
fis
byte
fileDigest
messageDigest
digest
StringBuffer
checksumSb
new
StringBuffer
for
int
i
i
fileDigest
length
i
String
hexStr
Integer
toHexString
fileDigest
i
if
hexStr
length
checksumSb
append
checksumSb
append
hexStr
String
checksum
checksumSb
toString
Object
destination
includeFileMap
get
src
if
destination
instanceof
java
lang
String
String
prop
String
destination
if
isCondition
checksumMatches
checksum
equals
property
else
project
setNewProperty
prop
checksum
else
if
destination
instanceof
java
io
File
if
isCondition
File
existingFile
File
destination
if
existingFile
exists
fis
new
FileInputStream
existingFile
InputStreamReader
isr
new
InputStreamReader
fis
BufferedReader
br
new
BufferedReader
isr
String
suppliedChecksum
br
readLine
fis
close
fis
br
close
isr
close
checksumMatches
checksum
equals
suppliedChecksum
else
checksumMatches
else
File
dest
File
destination
fos
new
FileOutputStream
dest
fos
write
checksum
getBytes
fos
close
fos
catch
Exception
e
throw
new
BuildException
e
location
finally
if
fis
try
fis
close
catch
IOException
e
if
fos
try
fos
close
catch
IOException
e
return
checksumMatches
