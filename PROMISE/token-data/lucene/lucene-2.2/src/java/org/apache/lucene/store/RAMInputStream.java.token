package
org
.
apache
.
lucene
.
store
;
import
java
.
io
.
IOException
;
class
RAMInputStream
extends
IndexInput
implements
Cloneable
{
static
final
int
BUFFER_SIZE
=
RAMOutputStream
.
BUFFER_SIZE
;
private
RAMFile
file
;
private
long
length
;
private
byte
[
]
currentBuffer
;
private
int
currentBufferIndex
;
private
int
bufferPosition
;
private
long
bufferStart
;
private
int
bufferLength
;
public
RAMInputStream
(
RAMFile
f
)
{
file
=
f
;
length
=
file
.
length
;
currentBufferIndex
=
-
1
;
currentBuffer
=
null
;
}
public
void
close
(
)
{
}
public
long
length
(
)
{
return
length
;
}
public
byte
readByte
(
)
throws
IOException
{
if
(
bufferPosition
>=
bufferLength
)
{
currentBufferIndex
++
;
switchCurrentBuffer
(
)
;
}
return
currentBuffer
[
bufferPosition
++
]
;
}
public
void
readBytes
(
byte
[
]
b
,
int
offset
,
int
len
)
throws
IOException
{
while
(
len
>
0
)
{
if
(
bufferPosition
>=
bufferLength
)
{
currentBufferIndex
++
;
switchCurrentBuffer
(
)
;
}
int
remainInBuffer
=
bufferLength
-
bufferPosition
;
int
bytesToCopy
=
len
<
remainInBuffer
?
len
:
remainInBuffer
;
System
.
arraycopy
(
currentBuffer
,
bufferPosition
,
b
,
offset
,
bytesToCopy
)
;
offset
+=
bytesToCopy
;
len
-=
bytesToCopy
;
bufferPosition
+=
bytesToCopy
;
}
}
private
final
void
switchCurrentBuffer
(
)
throws
IOException
{
if
(
currentBufferIndex
>=
file
.
buffers
.
size
(
)
)
{
throw
new
IOException
(
"Read past EOF"
)
;
}
else
{
currentBuffer
=
(
byte
[
]
)
file
.
buffers
.
get
(
currentBufferIndex
)
;
bufferPosition
=
0
;
bufferStart
=
BUFFER_SIZE
*
currentBufferIndex
;
bufferLength
=
(
int
)
(
length
-
bufferStart
)
;
if
(
bufferLength
>
BUFFER_SIZE
)
{
bufferLength
=
BUFFER_SIZE
;
}
}
}
public
long
getFilePointer
(
)
{
return
currentBufferIndex
<
0
?
0
:
bufferStart
+
bufferPosition
;
}
public
void
seek
(
long
pos
)
throws
IOException
{
long
bufferStart
=
currentBufferIndex
*
BUFFER_SIZE
;
if
(
pos
<
bufferStart
||
pos
>=
bufferStart
+
BUFFER_SIZE
)
{
currentBufferIndex
=
(
int
)
(
pos
/
BUFFER_SIZE
)
;
switchCurrentBuffer
(
)
;
}
bufferPosition
=
(
int
)
(
pos
%
BUFFER_SIZE
)
;
}
}
