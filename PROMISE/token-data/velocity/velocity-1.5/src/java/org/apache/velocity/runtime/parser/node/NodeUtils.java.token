package
org
.
apache
.
velocity
.
runtime
.
parser
.
node
;
import
org
.
apache
.
velocity
.
context
.
Context
;
import
org
.
apache
.
velocity
.
exception
.
MethodInvocationException
;
import
org
.
apache
.
velocity
.
runtime
.
parser
.
Token
;
public
class
NodeUtils
{
public
static
String
specialText
(
Token
t
)
{
StringBuffer
specialText
=
new
StringBuffer
(
)
;
if
(
t
.
specialToken
==
null
||
t
.
specialToken
.
image
.
startsWith
(
"##"
)
)
{
return
""
;
}
Token
tmp_t
=
t
.
specialToken
;
while
(
tmp_t
.
specialToken
!=
null
)
{
tmp_t
=
tmp_t
.
specialToken
;
}
while
(
tmp_t
!=
null
)
{
String
st
=
tmp_t
.
image
;
StringBuffer
sb
=
new
StringBuffer
(
)
;
for
(
int
i
=
0
;
i
<
st
.
length
(
)
;
i
++
)
{
char
c
=
st
.
charAt
(
i
)
;
if
(
c
==
'#'
||
c
==
'$'
)
{
sb
.
append
(
c
)
;
}
if
(
c
==
'\\'
)
{
boolean
ok
=
true
;
boolean
term
=
false
;
int
j
=
i
;
for
(
ok
=
true
;
ok
&&
j
<
st
.
length
(
)
;
j
++
)
{
char
cc
=
st
.
charAt
(
j
)
;
if
(
cc
==
'\\'
)
{
continue
;
}
else
if
(
cc
==
'$'
)
{
term
=
true
;
ok
=
false
;
}
else
{
ok
=
false
;
}
}
if
(
term
)
{
String
foo
=
st
.
substring
(
i
,
j
)
;
sb
.
append
(
foo
)
;
i
=
j
;
}
}
}
specialText
.
append
(
sb
.
toString
(
)
)
;
tmp_t
=
tmp_t
.
next
;
}
return
specialText
.
toString
(
)
;
}
public
static
String
tokenLiteral
(
Token
t
)
{
return
specialText
(
t
)
+
t
.
image
;
}
public
static
String
interpolate
(
String
argStr
,
Context
vars
)
throws
MethodInvocationException
{
StringBuffer
argBuf
=
new
StringBuffer
(
)
;
for
(
int
cIdx
=
0
;
cIdx
<
argStr
.
length
(
)
;
)
{
char
ch
=
argStr
.
charAt
(
cIdx
)
;
switch
(
ch
)
{
case
'$'
:
StringBuffer
nameBuf
=
new
StringBuffer
(
)
;
for
(
++
cIdx
;
cIdx
<
argStr
.
length
(
)
;
++
cIdx
)
{
ch
=
argStr
.
charAt
(
cIdx
)
;
if
(
ch
==
'_'
||
ch
==
'-'
||
Character
.
isLetterOrDigit
(
ch
)
)
nameBuf
.
append
(
ch
)
;
else
if
(
ch
==
'{'
||
ch
==
'}'
)
continue
;
else
break
;
}
if
(
nameBuf
.
length
(
)
>
0
)
{
Object
value
=
vars
.
get
(
nameBuf
.
toString
(
)
)
;
if
(
value
==
null
)
argBuf
.
append
(
"$"
)
.
append
(
nameBuf
.
toString
(
)
)
;
else
argBuf
.
append
(
value
.
toString
(
)
)
;
}
break
;
default
:
argBuf
.
append
(
ch
)
;
++
cIdx
;
break
;
}
}
return
argBuf
.
toString
(
)
;
}
}
