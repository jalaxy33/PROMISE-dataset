package
org
.
apache
.
velocity
.
runtime
.
parser
.
node
;
import
java
.
lang
.
reflect
.
InvocationTargetException
;
import
org
.
apache
.
velocity
.
app
.
event
.
EventHandlerUtil
;
import
org
.
apache
.
velocity
.
context
.
InternalContextAdapter
;
import
org
.
apache
.
velocity
.
exception
.
MethodInvocationException
;
import
org
.
apache
.
velocity
.
exception
.
TemplateInitException
;
import
org
.
apache
.
velocity
.
runtime
.
parser
.
Parser
;
import
org
.
apache
.
velocity
.
runtime
.
parser
.
ParserVisitor
;
import
org
.
apache
.
velocity
.
util
.
introspection
.
Info
;
import
org
.
apache
.
velocity
.
util
.
introspection
.
IntrospectionCacheData
;
import
org
.
apache
.
velocity
.
util
.
introspection
.
VelPropertyGet
;
public
class
ASTIdentifier
extends
SimpleNode
{
private
String
identifier
=
""
;
protected
Info
uberInfo
;
public
ASTIdentifier
(
int
id
)
{
super
(
id
)
;
}
public
ASTIdentifier
(
Parser
p
,
int
id
)
{
super
(
p
,
id
)
;
}
public
Object
jjtAccept
(
ParserVisitor
visitor
,
Object
data
)
{
return
visitor
.
visit
(
this
,
data
)
;
}
public
Object
init
(
InternalContextAdapter
context
,
Object
data
)
throws
TemplateInitException
{
super
.
init
(
context
,
data
)
;
identifier
=
getFirstToken
(
)
.
image
;
uberInfo
=
new
Info
(
context
.
getCurrentTemplateName
(
)
,
getLine
(
)
,
getColumn
(
)
)
;
return
data
;
}
public
Object
execute
(
Object
o
,
InternalContextAdapter
context
)
throws
MethodInvocationException
{
VelPropertyGet
vg
=
null
;
try
{
IntrospectionCacheData
icd
=
context
.
icacheGet
(
this
)
;
if
(
icd
!=
null
&&
(
o
!=
null
)
&&
(
icd
.
contextData
==
o
.
getClass
(
)
)
)
{
vg
=
(
VelPropertyGet
)
icd
.
thingy
;
}
else
{
vg
=
rsvc
.
getUberspect
(
)
.
getPropertyGet
(
o
,
identifier
,
uberInfo
)
;
if
(
vg
!=
null
&&
vg
.
isCacheable
(
)
&&
(
o
!=
null
)
)
{
icd
=
new
IntrospectionCacheData
(
)
;
icd
.
contextData
=
o
.
getClass
(
)
;
icd
.
thingy
=
vg
;
context
.
icachePut
(
this
,
icd
)
;
}
}
}
catch
(
RuntimeException
e
)
{
throw
e
;
}
catch
(
Exception
e
)
{
log
.
error
(
"ASTIdentifier.execute() : identifier = "
+
identifier
,
e
)
;
}
if
(
vg
==
null
)
{
return
null
;
}
try
{
return
vg
.
invoke
(
o
)
;
}
catch
(
InvocationTargetException
ite
)
{
Throwable
t
=
ite
.
getTargetException
(
)
;
if
(
t
instanceof
Exception
)
{
try
{
return
EventHandlerUtil
.
methodException
(
rsvc
,
context
,
o
.
getClass
(
)
,
vg
.
getMethodName
(
)
,
(
Exception
)
t
)
;
}
catch
(
Exception
e
)
{
throw
new
MethodInvocationException
(
"Invocation of method '"
+
vg
.
getMethodName
(
)
+
"'"
+
" in  "
+
o
.
getClass
(
)
+
" threw exception "
+
ite
.
getTargetException
(
)
.
toString
(
)
,
ite
.
getTargetException
(
)
,
vg
.
getMethodName
(
)
,
context
.
getCurrentTemplateName
(
)
,
this
.
getLine
(
)
,
this
.
getColumn
(
)
)
;
}
}
else
{
throw
new
MethodInvocationException
(
"Invocation of method '"
+
vg
.
getMethodName
(
)
+
"'"
+
" in  "
+
o
.
getClass
(
)
+
" threw exception "
+
ite
.
getTargetException
(
)
.
toString
(
)
,
ite
.
getTargetException
(
)
,
vg
.
getMethodName
(
)
,
context
.
getCurrentTemplateName
(
)
,
this
.
getLine
(
)
,
this
.
getColumn
(
)
)
;
}
}
catch
(
IllegalArgumentException
iae
)
{
return
null
;
}
catch
(
RuntimeException
e
)
{
throw
e
;
}
catch
(
Exception
e
)
{
log
.
error
(
"ASTIdentifier() : exception invoking method "
+
"for identifier '"
+
identifier
+
"' in "
+
o
.
getClass
(
)
+
" : "
+
e
)
;
}
return
null
;
}
}
