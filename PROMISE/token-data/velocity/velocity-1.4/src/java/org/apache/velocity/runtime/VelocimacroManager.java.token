package
org
.
apache
.
velocity
.
runtime
;
import
java
.
util
.
Hashtable
;
import
java
.
io
.
StringReader
;
import
java
.
io
.
BufferedReader
;
import
org
.
apache
.
velocity
.
runtime
.
directive
.
VelocimacroProxy
;
import
org
.
apache
.
velocity
.
runtime
.
parser
.
node
.
SimpleNode
;
import
org
.
apache
.
velocity
.
util
.
StringUtils
;
import
org
.
apache
.
velocity
.
context
.
InternalContextAdapter
;
public
class
VelocimacroManager
{
private
RuntimeServices
rsvc
=
null
;
private
static
String
GLOBAL_NAMESPACE
=
""
;
private
boolean
registerFromLib
=
false
;
private
Hashtable
namespaceHash
=
new
Hashtable
(
)
;
private
Hashtable
libraryMap
=
new
Hashtable
(
)
;
private
boolean
namespacesOn
=
true
;
private
boolean
inlineLocalMode
=
false
;
VelocimacroManager
(
RuntimeServices
rs
)
{
this
.
rsvc
=
rs
;
addNamespace
(
GLOBAL_NAMESPACE
)
;
}
public
boolean
addVM
(
String
vmName
,
String
macroBody
,
String
argArray
[
]
,
String
namespace
)
{
MacroEntry
me
=
new
MacroEntry
(
this
,
vmName
,
macroBody
,
argArray
,
namespace
)
;
me
.
setFromLibrary
(
registerFromLib
)
;
boolean
isLib
=
true
;
if
(
registerFromLib
)
{
libraryMap
.
put
(
namespace
,
namespace
)
;
}
else
{
isLib
=
libraryMap
.
containsKey
(
namespace
)
;
}
if
(
!
isLib
&&
usingNamespaces
(
namespace
)
)
{
Hashtable
local
=
getNamespace
(
namespace
,
true
)
;
local
.
put
(
(
String
)
vmName
,
me
)
;
return
true
;
}
else
{
MacroEntry
exist
=
(
MacroEntry
)
getNamespace
(
GLOBAL_NAMESPACE
)
.
get
(
vmName
)
;
if
(
exist
!=
null
)
{
me
.
setFromLibrary
(
exist
.
getFromLibrary
(
)
)
;
}
getNamespace
(
GLOBAL_NAMESPACE
)
.
put
(
vmName
,
me
)
;
return
true
;
}
}
public
VelocimacroProxy
get
(
String
vmName
,
String
namespace
)
{
if
(
usingNamespaces
(
namespace
)
)
{
Hashtable
local
=
getNamespace
(
namespace
,
false
)
;
if
(
local
!=
null
)
{
MacroEntry
me
=
(
MacroEntry
)
local
.
get
(
vmName
)
;
if
(
me
!=
null
)
{
return
me
.
createVelocimacro
(
namespace
)
;
}
}
}
MacroEntry
me
=
(
MacroEntry
)
getNamespace
(
GLOBAL_NAMESPACE
)
.
get
(
vmName
)
;
if
(
me
!=
null
)
{
return
me
.
createVelocimacro
(
namespace
)
;
}
return
null
;
}
public
boolean
dumpNamespace
(
String
namespace
)
{
synchronized
(
this
)
{
if
(
usingNamespaces
(
namespace
)
)
{
Hashtable
h
=
(
Hashtable
)
namespaceHash
.
remove
(
namespace
)
;
if
(
h
==
null
)
return
false
;
h
.
clear
(
)
;
return
true
;
}
return
false
;
}
}
public
void
setNamespaceUsage
(
boolean
b
)
{
namespacesOn
=
b
;
}
public
void
setRegisterFromLib
(
boolean
b
)
{
registerFromLib
=
b
;
}
public
void
setTemplateLocalInlineVM
(
boolean
b
)
{
inlineLocalMode
=
b
;
}
private
Hashtable
getNamespace
(
String
namespace
)
{
return
getNamespace
(
namespace
,
false
)
;
}
private
Hashtable
getNamespace
(
String
namespace
,
boolean
addIfNew
)
{
Hashtable
h
=
(
Hashtable
)
namespaceHash
.
get
(
namespace
)
;
if
(
h
==
null
&&
addIfNew
)
{
h
=
addNamespace
(
namespace
)
;
}
return
h
;
}
private
Hashtable
addNamespace
(
String
namespace
)
{
Hashtable
h
=
new
Hashtable
(
)
;
Object
oh
;
if
(
(
oh
=
namespaceHash
.
put
(
namespace
,
h
)
)
!=
null
)
{
namespaceHash
.
put
(
namespace
,
oh
)
;
return
null
;
}
return
h
;
}
private
boolean
usingNamespaces
(
String
namespace
)
{
if
(
!
namespacesOn
)
{
return
false
;
}
if
(
inlineLocalMode
)
{
return
true
;
}
return
false
;
}
public
String
getLibraryName
(
String
vmName
,
String
namespace
)
{
if
(
usingNamespaces
(
namespace
)
)
{
Hashtable
local
=
getNamespace
(
namespace
,
false
)
;
if
(
local
!=
null
)
{
MacroEntry
me
=
(
MacroEntry
)
local
.
get
(
vmName
)
;
if
(
me
!=
null
)
{
return
null
;
}
}
}
MacroEntry
me
=
(
MacroEntry
)
getNamespace
(
GLOBAL_NAMESPACE
)
.
get
(
vmName
)
;
if
(
me
!=
null
)
{
return
me
.
getSourceTemplate
(
)
;
}
return
null
;
}
protected
class
MacroEntry
{
String
macroname
;
String
[
]
argarray
;
String
macrobody
;
String
sourcetemplate
;
SimpleNode
nodeTree
=
null
;
VelocimacroManager
manager
=
null
;
boolean
fromLibrary
=
false
;
MacroEntry
(
VelocimacroManager
vmm
,
String
vmName
,
String
macroBody
,
String
argArray
[
]
,
String
sourceTemplate
)
{
this
.
macroname
=
vmName
;
this
.
argarray
=
argArray
;
this
.
macrobody
=
macroBody
;
this
.
sourcetemplate
=
sourceTemplate
;
this
.
manager
=
vmm
;
}
public
void
setFromLibrary
(
boolean
b
)
{
fromLibrary
=
b
;
}
public
boolean
getFromLibrary
(
)
{
return
fromLibrary
;
}
public
SimpleNode
getNodeTree
(
)
{
return
nodeTree
;
}
public
String
getSourceTemplate
(
)
{
return
sourcetemplate
;
}
VelocimacroProxy
createVelocimacro
(
String
namespace
)
{
VelocimacroProxy
vp
=
new
VelocimacroProxy
(
)
;
vp
.
setName
(
this
.
macroname
)
;
vp
.
setArgArray
(
this
.
argarray
)
;
vp
.
setMacrobody
(
this
.
macrobody
)
;
vp
.
setNodeTree
(
this
.
nodeTree
)
;
vp
.
setNamespace
(
namespace
)
;
return
vp
;
}
void
setup
(
InternalContextAdapter
ica
)
{
if
(
nodeTree
==
null
)
parseTree
(
ica
)
;
}
void
parseTree
(
InternalContextAdapter
ica
)
{
try
{
BufferedReader
br
=
new
BufferedReader
(
new
StringReader
(
macrobody
)
)
;
nodeTree
=
rsvc
.
parse
(
br
,
"VM:"
+
macroname
,
true
)
;
nodeTree
.
init
(
ica
,
null
)
;
}
catch
(
Exception
e
)
{
rsvc
.
error
(
"VelocimacroManager.parseTree() : exception "
+
macroname
+
" : "
+
StringUtils
.
stackTrace
(
e
)
)
;
}
}
}
}
