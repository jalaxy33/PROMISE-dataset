package
org
.
apache
.
xalan
.
xsltc
.
trax
;
import
java
.
io
.
Serializable
;
import
java
.
io
.
ObjectInput
;
import
java
.
io
.
ObjectOutput
;
import
java
.
io
.
IOException
;
import
java
.
util
.
Properties
;
import
java
.
security
.
AccessController
;
import
java
.
security
.
PrivilegedAction
;
import
javax
.
xml
.
transform
.
*
;
import
org
.
apache
.
xalan
.
xsltc
.
Translet
;
import
org
.
apache
.
xalan
.
xsltc
.
compiler
.
*
;
import
org
.
apache
.
xalan
.
xsltc
.
runtime
.
*
;
import
org
.
apache
.
xalan
.
xsltc
.
compiler
.
util
.
ErrorMsg
;
public
final
class
TemplatesImpl
implements
Templates
,
Serializable
{
private
static
String
ABSTRACT_TRANSLET
=
"org.apache.xalan.xsltc.runtime.AbstractTranslet"
;
private
String
_name
=
null
;
private
byte
[
]
[
]
_bytecodes
=
null
;
private
Class
[
]
_class
=
null
;
private
int
_transletIndex
=
-
1
;
private
Properties
_outputProperties
;
private
int
_indentNumber
;
private
URIResolver
_uriResolver
=
null
;
private
TransformerFactoryImpl
_tfactory
=
null
;
private
class
TransletClassLoader
extends
ClassLoader
{
protected
TransletClassLoader
(
ClassLoader
parent
)
{
super
(
parent
)
;
}
public
Class
defineClass
(
byte
[
]
b
)
{
return
super
.
defineClass
(
null
,
b
,
0
,
b
.
length
)
;
}
}
protected
TemplatesImpl
(
byte
[
]
[
]
bytecodes
,
String
transletName
,
Properties
outputProperties
,
int
indentNumber
,
TransformerFactoryImpl
tfactory
)
{
_bytecodes
=
bytecodes
;
_name
=
transletName
;
_outputProperties
=
outputProperties
;
_indentNumber
=
indentNumber
;
_tfactory
=
tfactory
;
}
public
synchronized
void
writeExternal
(
ObjectOutput
out
)
throws
IOException
{
out
.
writeObject
(
_name
)
;
out
.
writeObject
(
_bytecodes
)
;
out
.
flush
(
)
;
}
public
synchronized
void
readExternal
(
ObjectInput
in
)
throws
IOException
,
ClassNotFoundException
{
_name
=
(
String
)
in
.
readObject
(
)
;
_bytecodes
=
(
byte
[
]
[
]
)
in
.
readObject
(
)
;
_class
=
null
;
}
public
synchronized
void
setURIResolver
(
URIResolver
resolver
)
{
_uriResolver
=
resolver
;
}
protected
synchronized
void
setTransletBytecodes
(
byte
[
]
[
]
bytecodes
)
{
_bytecodes
=
bytecodes
;
}
public
synchronized
byte
[
]
[
]
getTransletBytecodes
(
)
{
return
_bytecodes
;
}
public
synchronized
Class
[
]
getTransletClasses
(
)
{
try
{
if
(
_class
==
null
)
defineTransletClasses
(
)
;
}
catch
(
TransformerConfigurationException
e
)
{
}
return
_class
;
}
public
synchronized
int
getTransletIndex
(
)
{
try
{
if
(
_class
==
null
)
defineTransletClasses
(
)
;
}
catch
(
TransformerConfigurationException
e
)
{
}
return
_transletIndex
;
}
protected
synchronized
void
setTransletName
(
String
name
)
{
_name
=
name
;
}
protected
synchronized
String
getTransletName
(
)
{
return
_name
;
}
private
void
defineTransletClasses
(
)
throws
TransformerConfigurationException
{
if
(
_bytecodes
==
null
)
{
ErrorMsg
err
=
new
ErrorMsg
(
ErrorMsg
.
NO_TRANSLET_CLASS_ERR
)
;
throw
new
TransformerConfigurationException
(
err
.
toString
(
)
)
;
}
TransletClassLoader
loader
=
(
TransletClassLoader
)
AccessController
.
doPrivileged
(
new
PrivilegedAction
(
)
{
public
Object
run
(
)
{
return
new
TransletClassLoader
(
Thread
.
currentThread
(
)
.
getContextClassLoader
(
)
)
;
}
}
)
;
try
{
final
int
classCount
=
_bytecodes
.
length
;
_class
=
new
Class
[
classCount
]
;
for
(
int
i
=
0
;
i
<
classCount
;
i
++
)
{
_class
[
i
]
=
loader
.
defineClass
(
_bytecodes
[
i
]
)
;
final
Class
superClass
=
_class
[
i
]
.
getSuperclass
(
)
;
if
(
superClass
.
getName
(
)
.
equals
(
ABSTRACT_TRANSLET
)
)
{
_transletIndex
=
i
;
}
}
if
(
_transletIndex
<
0
)
{
ErrorMsg
err
=
new
ErrorMsg
(
ErrorMsg
.
NO_MAIN_TRANSLET_ERR
,
_name
)
;
throw
new
TransformerConfigurationException
(
err
.
toString
(
)
)
;
}
}
catch
(
ClassFormatError
e
)
{
ErrorMsg
err
=
new
ErrorMsg
(
ErrorMsg
.
TRANSLET_CLASS_ERR
,
_name
)
;
throw
new
TransformerConfigurationException
(
err
.
toString
(
)
)
;
}
catch
(
LinkageError
e
)
{
ErrorMsg
err
=
new
ErrorMsg
(
ErrorMsg
.
TRANSLET_OBJECT_ERR
,
_name
)
;
throw
new
TransformerConfigurationException
(
err
.
toString
(
)
)
;
}
}
private
Translet
getTransletInstance
(
)
throws
TransformerConfigurationException
{
try
{
if
(
_name
==
null
)
return
null
;
if
(
_class
==
null
)
defineTransletClasses
(
)
;
Translet
translet
=
(
Translet
)
_class
[
_transletIndex
]
.
newInstance
(
)
;
final
int
classCount
=
_bytecodes
.
length
;
for
(
int
i
=
0
;
i
<
classCount
;
i
++
)
{
if
(
i
!=
_transletIndex
)
{
translet
.
addAuxiliaryClass
(
_class
[
i
]
)
;
}
}
return
translet
;
}
catch
(
InstantiationException
e
)
{
ErrorMsg
err
=
new
ErrorMsg
(
ErrorMsg
.
TRANSLET_OBJECT_ERR
,
_name
)
;
throw
new
TransformerConfigurationException
(
err
.
toString
(
)
)
;
}
catch
(
IllegalAccessException
e
)
{
ErrorMsg
err
=
new
ErrorMsg
(
ErrorMsg
.
TRANSLET_OBJECT_ERR
,
_name
)
;
throw
new
TransformerConfigurationException
(
err
.
toString
(
)
)
;
}
}
public
synchronized
Transformer
newTransformer
(
)
throws
TransformerConfigurationException
{
final
TransformerImpl
transformer
=
new
TransformerImpl
(
getTransletInstance
(
)
,
_outputProperties
,
_indentNumber
,
_tfactory
)
;
if
(
_uriResolver
!=
null
)
{
transformer
.
setURIResolver
(
_uriResolver
)
;
}
return
transformer
;
}
public
synchronized
Properties
getOutputProperties
(
)
{
try
{
return
newTransformer
(
)
.
getOutputProperties
(
)
;
}
catch
(
TransformerConfigurationException
e
)
{
return
null
;
}
}
}
