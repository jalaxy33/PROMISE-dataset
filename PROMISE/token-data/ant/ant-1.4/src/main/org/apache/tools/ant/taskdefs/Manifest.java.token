package
org
.
apache
.
tools
.
ant
.
taskdefs
;
import
java
.
util
.
*
;
import
java
.
io
.
*
;
import
org
.
apache
.
tools
.
ant
.
BuildException
;
public
class
Manifest
{
static
public
final
String
ATTRIBUTE_MANIFEST_VERSION
=
"Manifest-Version"
;
static
public
final
String
ATTRIBUTE_SIGNATURE_VERSION
=
"Signature-Version"
;
static
public
final
String
ATTRIBUTE_NAME
=
"Name"
;
static
public
final
String
ATTRIBUTE_FROM
=
"From"
;
static
public
final
String
DEFAULT_MANIFEST_VERSION
=
"1.0"
;
static
public
final
int
MAX_LINE_LENGTH
=
70
;
static
public
class
Attribute
{
private
String
name
=
null
;
private
String
value
=
null
;
public
Attribute
(
)
{
}
public
Attribute
(
String
line
)
throws
ManifestException
{
parse
(
line
)
;
}
public
Attribute
(
String
name
,
String
value
)
{
this
.
name
=
name
;
this
.
value
=
value
;
}
public
boolean
equals
(
Object
rhs
)
{
if
(
!
(
rhs
instanceof
Attribute
)
)
{
return
false
;
}
Attribute
rhsAttribute
=
(
Attribute
)
rhs
;
return
(
name
!=
null
&&
rhsAttribute
.
name
!=
null
&&
name
.
toLowerCase
(
)
.
equals
(
rhsAttribute
.
name
.
toLowerCase
(
)
)
&&
value
!=
null
&&
value
.
equals
(
rhsAttribute
.
value
)
)
;
}
public
void
parse
(
String
line
)
throws
ManifestException
{
int
index
=
line
.
indexOf
(
": "
)
;
if
(
index
==
-
1
)
{
throw
new
ManifestException
(
"Manifest line \""
+
line
+
"\" is not valid"
)
;
}
name
=
line
.
substring
(
0
,
index
)
;
value
=
line
.
substring
(
index
+
2
)
;
}
public
void
setName
(
String
name
)
{
this
.
name
=
name
;
}
public
String
getName
(
)
{
return
name
;
}
public
void
setValue
(
String
value
)
{
this
.
value
=
value
;
}
public
String
getValue
(
)
{
return
value
;
}
public
void
addContinuation
(
String
line
)
{
value
+=
line
.
substring
(
1
)
;
}
public
void
write
(
PrintWriter
writer
)
throws
IOException
{
String
line
=
name
+
": "
+
value
;
while
(
line
.
getBytes
(
)
.
length
>
MAX_LINE_LENGTH
)
{
int
breakIndex
=
MAX_LINE_LENGTH
;
String
section
=
line
.
substring
(
0
,
breakIndex
)
;
while
(
section
.
getBytes
(
)
.
length
>
MAX_LINE_LENGTH
&&
breakIndex
>
0
)
{
breakIndex
--
;
section
=
line
.
substring
(
0
,
breakIndex
)
;
}
if
(
breakIndex
==
0
)
{
throw
new
IOException
(
"Unable to write manifest line "
+
name
+
": "
+
value
)
;
}
writer
.
println
(
section
)
;
line
=
" "
+
line
.
substring
(
breakIndex
)
;
}
writer
.
println
(
line
)
;
}
}
static
public
class
Section
{
private
Vector
warnings
=
new
Vector
(
)
;
private
String
name
=
null
;
private
Hashtable
attributes
=
new
Hashtable
(
)
;
public
void
setName
(
String
name
)
{
this
.
name
=
name
;
}
public
String
getName
(
)
{
return
name
;
}
public
String
read
(
BufferedReader
reader
)
throws
ManifestException
,
IOException
{
Attribute
attribute
=
null
;
while
(
true
)
{
String
line
=
reader
.
readLine
(
)
;
if
(
line
==
null
||
line
.
length
(
)
==
0
)
{
return
null
;
}
if
(
line
.
charAt
(
0
)
==
' '
)
{
if
(
attribute
==
null
)
{
throw
new
ManifestException
(
"Can't start an attribute with a continuation line "
+
line
)
;
}
attribute
.
addContinuation
(
line
)
;
}
else
{
attribute
=
new
Attribute
(
line
)
;
String
nameReadAhead
=
addAttributeAndCheck
(
attribute
)
;
if
(
nameReadAhead
!=
null
)
{
return
nameReadAhead
;
}
}
}
}
public
void
merge
(
Section
section
)
throws
ManifestException
{
if
(
name
==
null
&&
section
.
getName
(
)
!=
null
||
name
!=
null
&&
!
(
name
.
equalsIgnoreCase
(
section
.
getName
(
)
)
)
)
{
throw
new
ManifestException
(
"Unable to merge sections with different names"
)
;
}
for
(
Enumeration
e
=
section
.
attributes
.
keys
(
)
;
e
.
hasMoreElements
(
)
;
)
{
String
attributeName
=
(
String
)
e
.
nextElement
(
)
;
attributes
.
put
(
attributeName
,
section
.
attributes
.
get
(
attributeName
)
)
;
}
for
(
Enumeration
e
=
section
.
warnings
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
warnings
.
addElement
(
e
.
nextElement
(
)
)
;
}
}
public
void
write
(
PrintWriter
writer
)
throws
IOException
{
if
(
name
!=
null
)
{
Attribute
nameAttr
=
new
Attribute
(
ATTRIBUTE_NAME
,
name
)
;
nameAttr
.
write
(
writer
)
;
}
for
(
Enumeration
e
=
attributes
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
Attribute
attribute
=
(
Attribute
)
e
.
nextElement
(
)
;
attribute
.
write
(
writer
)
;
}
writer
.
println
(
)
;
}
public
String
getAttributeValue
(
String
attributeName
)
{
Attribute
attribute
=
(
Attribute
)
attributes
.
get
(
attributeName
.
toLowerCase
(
)
)
;
if
(
attribute
==
null
)
{
return
null
;
}
return
attribute
.
getValue
(
)
;
}
public
void
removeAttribute
(
String
attributeName
)
{
attributes
.
remove
(
attributeName
.
toLowerCase
(
)
)
;
}
public
void
addConfiguredAttribute
(
Attribute
attribute
)
throws
ManifestException
{
String
check
=
addAttributeAndCheck
(
attribute
)
;
if
(
check
!=
null
)
{
throw
new
BuildException
(
"Use the \"name\" attribute of the <section> element rather than using "
+
"the \"Name\" attribute"
)
;
}
}
public
String
addAttributeAndCheck
(
Attribute
attribute
)
throws
ManifestException
{
if
(
attribute
.
getName
(
)
==
null
||
attribute
.
getValue
(
)
==
null
)
{
throw
new
BuildException
(
"Attributes must have name and value"
)
;
}
if
(
attribute
.
getName
(
)
.
equalsIgnoreCase
(
ATTRIBUTE_NAME
)
)
{
warnings
.
addElement
(
"\""
+
ATTRIBUTE_NAME
+
"\" attributes should not occur in the "
+
"main section and must be the first element in all "
+
"other sections: \""
+
attribute
.
getName
(
)
+
": "
+
attribute
.
getValue
(
)
+
"\""
)
;
return
attribute
.
getValue
(
)
;
}
if
(
attribute
.
getName
(
)
.
toLowerCase
(
)
.
startsWith
(
ATTRIBUTE_FROM
.
toLowerCase
(
)
)
)
{
warnings
.
addElement
(
"Manifest attributes should not start with \""
+
ATTRIBUTE_FROM
+
"\" in \""
+
attribute
.
getName
(
)
+
": "
+
attribute
.
getValue
(
)
+
"\""
)
;
}
else
if
(
attributes
.
containsKey
(
attribute
.
getName
(
)
.
toLowerCase
(
)
)
)
{
throw
new
ManifestException
(
"The attribute \""
+
attribute
.
getName
(
)
+
"\" may not "
+
"occur more than once in the same section"
)
;
}
else
{
attributes
.
put
(
attribute
.
getName
(
)
.
toLowerCase
(
)
,
attribute
)
;
}
return
null
;
}
public
Enumeration
getWarnings
(
)
{
return
warnings
.
elements
(
)
;
}
public
boolean
equals
(
Object
rhs
)
{
if
(
!
(
rhs
instanceof
Section
)
)
{
return
false
;
}
Section
rhsSection
=
(
Section
)
rhs
;
if
(
attributes
.
size
(
)
!=
rhsSection
.
attributes
.
size
(
)
)
{
return
false
;
}
for
(
Enumeration
e
=
attributes
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
Attribute
attribute
=
(
Attribute
)
e
.
nextElement
(
)
;
Attribute
rshAttribute
=
(
Attribute
)
rhsSection
.
attributes
.
get
(
attribute
.
getName
(
)
.
toLowerCase
(
)
)
;
if
(
!
attribute
.
equals
(
rshAttribute
)
)
{
return
false
;
}
}
return
true
;
}
}
private
String
manifestVersion
=
DEFAULT_MANIFEST_VERSION
;
private
Section
mainSection
=
new
Section
(
)
;
private
Hashtable
sections
=
new
Hashtable
(
)
;
public
Manifest
(
)
{
}
public
Manifest
(
InputStream
is
)
throws
ManifestException
,
IOException
{
BufferedReader
reader
=
new
BufferedReader
(
new
InputStreamReader
(
is
)
)
;
String
nextSectionName
=
mainSection
.
read
(
reader
)
;
String
readManifestVersion
=
mainSection
.
getAttributeValue
(
ATTRIBUTE_MANIFEST_VERSION
)
;
if
(
readManifestVersion
!=
null
)
{
manifestVersion
=
readManifestVersion
;
mainSection
.
removeAttribute
(
ATTRIBUTE_MANIFEST_VERSION
)
;
}
String
line
=
null
;
while
(
(
line
=
reader
.
readLine
(
)
)
!=
null
)
{
if
(
line
.
length
(
)
==
0
)
{
continue
;
}
Section
section
=
new
Section
(
)
;
if
(
nextSectionName
==
null
)
{
Attribute
sectionName
=
new
Attribute
(
line
)
;
if
(
!
sectionName
.
getName
(
)
.
equalsIgnoreCase
(
ATTRIBUTE_NAME
)
)
{
throw
new
ManifestException
(
"Manifest sections should start with a \""
+
ATTRIBUTE_NAME
+
"\" attribute and not \""
+
sectionName
.
getName
(
)
+
"\""
)
;
}
nextSectionName
=
sectionName
.
getValue
(
)
;
}
else
{
Attribute
firstAttribute
=
new
Attribute
(
line
)
;
section
.
addAttributeAndCheck
(
firstAttribute
)
;
}
section
.
setName
(
nextSectionName
)
;
nextSectionName
=
section
.
read
(
reader
)
;
addConfiguredSection
(
section
)
;
}
}
public
void
addConfiguredSection
(
Section
section
)
throws
ManifestException
{
if
(
section
.
getName
(
)
==
null
)
{
throw
new
BuildException
(
"Sections must have a name"
)
;
}
sections
.
put
(
section
.
getName
(
)
.
toLowerCase
(
)
,
section
)
;
}
public
void
addConfiguredAttribute
(
Attribute
attribute
)
throws
ManifestException
{
mainSection
.
addConfiguredAttribute
(
attribute
)
;
}
public
void
merge
(
Manifest
other
)
throws
ManifestException
{
manifestVersion
=
other
.
manifestVersion
;
mainSection
.
merge
(
other
.
mainSection
)
;
for
(
Enumeration
e
=
other
.
sections
.
keys
(
)
;
e
.
hasMoreElements
(
)
;
)
{
String
sectionName
=
(
String
)
e
.
nextElement
(
)
;
Section
ourSection
=
(
Section
)
sections
.
get
(
sectionName
)
;
Section
otherSection
=
(
Section
)
other
.
sections
.
get
(
sectionName
)
;
if
(
ourSection
==
null
)
{
sections
.
put
(
sectionName
.
toLowerCase
(
)
,
otherSection
)
;
}
else
{
ourSection
.
merge
(
otherSection
)
;
}
}
}
public
void
write
(
PrintWriter
writer
)
throws
IOException
{
writer
.
println
(
ATTRIBUTE_MANIFEST_VERSION
+
": "
+
manifestVersion
)
;
String
signatureVersion
=
mainSection
.
getAttributeValue
(
ATTRIBUTE_SIGNATURE_VERSION
)
;
if
(
signatureVersion
!=
null
)
{
writer
.
println
(
ATTRIBUTE_SIGNATURE_VERSION
+
": "
+
signatureVersion
)
;
mainSection
.
removeAttribute
(
ATTRIBUTE_SIGNATURE_VERSION
)
;
}
mainSection
.
write
(
writer
)
;
if
(
signatureVersion
!=
null
)
{
try
{
mainSection
.
addConfiguredAttribute
(
new
Attribute
(
ATTRIBUTE_SIGNATURE_VERSION
,
signatureVersion
)
)
;
}
catch
(
ManifestException
e
)
{
}
}
for
(
Enumeration
e
=
sections
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
Section
section
=
(
Section
)
e
.
nextElement
(
)
;
section
.
write
(
writer
)
;
}
}
public
String
toString
(
)
{
StringWriter
sw
=
new
StringWriter
(
)
;
try
{
write
(
new
PrintWriter
(
sw
)
)
;
}
catch
(
IOException
e
)
{
return
null
;
}
return
sw
.
toString
(
)
;
}
public
Enumeration
getWarnings
(
)
{
Vector
warnings
=
new
Vector
(
)
;
for
(
Enumeration
e2
=
mainSection
.
getWarnings
(
)
;
e2
.
hasMoreElements
(
)
;
)
{
warnings
.
addElement
(
e2
.
nextElement
(
)
)
;
}
for
(
Enumeration
e
=
sections
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
Section
section
=
(
Section
)
e
.
nextElement
(
)
;
for
(
Enumeration
e2
=
section
.
getWarnings
(
)
;
e2
.
hasMoreElements
(
)
;
)
{
warnings
.
addElement
(
e2
.
nextElement
(
)
)
;
}
}
return
warnings
.
elements
(
)
;
}
public
boolean
equals
(
Object
rhs
)
{
if
(
!
(
rhs
instanceof
Manifest
)
)
{
return
false
;
}
Manifest
rhsManifest
=
(
Manifest
)
rhs
;
if
(
!
manifestVersion
.
equals
(
rhsManifest
.
manifestVersion
)
)
{
return
false
;
}
if
(
sections
.
size
(
)
!=
rhsManifest
.
sections
.
size
(
)
)
{
return
false
;
}
if
(
!
mainSection
.
equals
(
rhsManifest
.
mainSection
)
)
{
return
false
;
}
for
(
Enumeration
e
=
sections
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
Section
section
=
(
Section
)
e
.
nextElement
(
)
;
Section
rhsSection
=
(
Section
)
rhsManifest
.
sections
.
get
(
section
.
getName
(
)
.
toLowerCase
(
)
)
;
if
(
!
section
.
equals
(
rhsSection
)
)
{
return
false
;
}
}
return
true
;
}
}
