package
org
.
apache
.
tools
.
ant
.
types
.
resources
;
import
java
.
io
.
File
;
import
java
.
util
.
Stack
;
import
java
.
util
.
Iterator
;
import
java
.
util
.
Collection
;
import
org
.
apache
.
tools
.
ant
.
Project
;
import
org
.
apache
.
tools
.
ant
.
BuildException
;
import
org
.
apache
.
tools
.
ant
.
types
.
DataType
;
import
org
.
apache
.
tools
.
ant
.
types
.
ResourceCollection
;
public
abstract
class
BaseResourceCollectionWrapper
extends
DataType
implements
ResourceCollection
,
Cloneable
{
private
static
final
String
ONE_NESTED_MESSAGE
=
" expects exactly one nested resource collection."
;
private
ResourceCollection
rc
;
private
Collection
coll
=
null
;
private
boolean
cache
=
true
;
public
synchronized
void
setCache
(
boolean
b
)
{
cache
=
b
;
}
public
synchronized
boolean
isCache
(
)
{
return
cache
;
}
public
synchronized
void
add
(
ResourceCollection
c
)
throws
BuildException
{
if
(
isReference
(
)
)
{
throw
noChildrenAllowed
(
)
;
}
if
(
c
==
null
)
{
return
;
}
if
(
rc
!=
null
)
{
throw
oneNested
(
)
;
}
rc
=
c
;
setChecked
(
false
)
;
}
public
final
synchronized
Iterator
iterator
(
)
{
if
(
isReference
(
)
)
{
return
(
(
BaseResourceCollectionWrapper
)
getCheckedRef
(
)
)
.
iterator
(
)
;
}
dieOnCircularReference
(
)
;
return
new
FailFast
(
this
,
cacheCollection
(
)
.
iterator
(
)
)
;
}
public
synchronized
int
size
(
)
{
if
(
isReference
(
)
)
{
return
(
(
BaseResourceCollectionWrapper
)
getCheckedRef
(
)
)
.
size
(
)
;
}
dieOnCircularReference
(
)
;
return
cacheCollection
(
)
.
size
(
)
;
}
public
synchronized
boolean
isFilesystemOnly
(
)
{
if
(
isReference
(
)
)
{
return
(
(
BaseResourceCollectionContainer
)
getCheckedRef
(
)
)
.
isFilesystemOnly
(
)
;
}
dieOnCircularReference
(
)
;
if
(
rc
==
null
||
rc
.
isFilesystemOnly
(
)
)
{
return
true
;
}
for
(
Iterator
i
=
cacheCollection
(
)
.
iterator
(
)
;
i
.
hasNext
(
)
;
)
{
if
(
!
(
i
.
next
(
)
instanceof
FileResource
)
)
{
return
false
;
}
}
return
true
;
}
protected
synchronized
void
dieOnCircularReference
(
Stack
stk
,
Project
p
)
throws
BuildException
{
if
(
isChecked
(
)
)
{
return
;
}
if
(
isReference
(
)
)
{
super
.
dieOnCircularReference
(
stk
,
p
)
;
}
else
{
if
(
rc
instanceof
DataType
)
{
stk
.
push
(
rc
)
;
invokeCircularReferenceCheck
(
(
DataType
)
rc
,
stk
,
p
)
;
stk
.
pop
(
)
;
}
setChecked
(
true
)
;
}
}
protected
final
synchronized
ResourceCollection
getResourceCollection
(
)
{
dieOnCircularReference
(
)
;
if
(
rc
==
null
)
{
throw
oneNested
(
)
;
}
return
rc
;
}
protected
abstract
Collection
getCollection
(
)
;
public
synchronized
String
toString
(
)
{
if
(
isReference
(
)
)
{
return
getCheckedRef
(
)
.
toString
(
)
;
}
if
(
cacheCollection
(
)
.
size
(
)
==
0
)
{
return
""
;
}
StringBuffer
sb
=
new
StringBuffer
(
)
;
for
(
Iterator
i
=
coll
.
iterator
(
)
;
i
.
hasNext
(
)
;
)
{
if
(
sb
.
length
(
)
>
0
)
{
sb
.
append
(
File
.
pathSeparatorChar
)
;
}
sb
.
append
(
i
.
next
(
)
)
;
}
return
sb
.
toString
(
)
;
}
private
synchronized
Collection
cacheCollection
(
)
{
if
(
coll
==
null
||
!
isCache
(
)
)
{
coll
=
getCollection
(
)
;
}
return
coll
;
}
private
BuildException
oneNested
(
)
{
return
new
BuildException
(
super
.
toString
(
)
+
ONE_NESTED_MESSAGE
)
;
}
}
