package
org
.
apache
.
tools
.
ant
;
import
java
.
io
.
BufferedReader
;
import
java
.
io
.
File
;
import
java
.
io
.
InputStream
;
import
java
.
io
.
InputStreamReader
;
import
java
.
util
.
Hashtable
;
import
java
.
util
.
Locale
;
import
java
.
util
.
Vector
;
import
org
.
apache
.
tools
.
ant
.
helper
.
ProjectHelper2
;
import
org
.
apache
.
tools
.
ant
.
util
.
LoaderUtils
;
import
org
.
xml
.
sax
.
AttributeList
;
public
class
ProjectHelper
{
public
static
final
String
ANT_CORE_URI
=
"antlib:org.apache.tools.ant"
;
public
static
final
String
ANT_CURRENT_URI
=
"ant:current"
;
public
static
final
String
ANTLIB_URI
=
"antlib:"
;
public
static
final
String
ANT_TYPE
=
"ant-type"
;
public
static
final
String
HELPER_PROPERTY
=
"org.apache.tools.ant.ProjectHelper"
;
public
static
final
String
SERVICE_ID
=
"META-INF/services/org.apache.tools.ant.ProjectHelper"
;
public
static
final
String
PROJECTHELPER_REFERENCE
=
"ant.projectHelper"
;
public
static
void
configureProject
(
Project
project
,
File
buildFile
)
throws
BuildException
{
ProjectHelper
helper
=
ProjectHelper
.
getProjectHelper
(
)
;
project
.
addReference
(
PROJECTHELPER_REFERENCE
,
helper
)
;
helper
.
parse
(
project
,
buildFile
)
;
}
public
ProjectHelper
(
)
{
}
private
Vector
importStack
=
new
Vector
(
)
;
public
Vector
getImportStack
(
)
{
return
importStack
;
}
public
void
parse
(
Project
project
,
Object
source
)
throws
BuildException
{
throw
new
BuildException
(
"ProjectHelper.parse() must be implemented "
+
"in a helper plugin "
+
this
.
getClass
(
)
.
getName
(
)
)
;
}
public
static
ProjectHelper
getProjectHelper
(
)
throws
BuildException
{
ProjectHelper
helper
=
null
;
String
helperClass
=
System
.
getProperty
(
HELPER_PROPERTY
)
;
try
{
if
(
helperClass
!=
null
)
{
helper
=
newHelper
(
helperClass
)
;
}
}
catch
(
SecurityException
e
)
{
System
.
out
.
println
(
"Unable to load ProjectHelper class \""
+
helperClass
+
" specified in system property "
+
HELPER_PROPERTY
)
;
}
if
(
helper
==
null
)
{
try
{
ClassLoader
classLoader
=
LoaderUtils
.
getContextClassLoader
(
)
;
InputStream
is
=
null
;
if
(
classLoader
!=
null
)
{
is
=
classLoader
.
getResourceAsStream
(
SERVICE_ID
)
;
}
if
(
is
==
null
)
{
is
=
ClassLoader
.
getSystemResourceAsStream
(
SERVICE_ID
)
;
}
if
(
is
!=
null
)
{
InputStreamReader
isr
;
try
{
isr
=
new
InputStreamReader
(
is
,
"UTF-8"
)
;
}
catch
(
java
.
io
.
UnsupportedEncodingException
e
)
{
isr
=
new
InputStreamReader
(
is
)
;
}
BufferedReader
rd
=
new
BufferedReader
(
isr
)
;
String
helperClassName
=
rd
.
readLine
(
)
;
rd
.
close
(
)
;
if
(
helperClassName
!=
null
&&
!
""
.
equals
(
helperClassName
)
)
{
helper
=
newHelper
(
helperClassName
)
;
}
}
}
catch
(
Exception
ex
)
{
System
.
out
.
println
(
"Unable to load ProjectHelper "
+
"from service \""
+
SERVICE_ID
)
;
}
}
if
(
helper
!=
null
)
{
return
helper
;
}
else
{
return
new
ProjectHelper2
(
)
;
}
}
private
static
ProjectHelper
newHelper
(
String
helperClass
)
throws
BuildException
{
ClassLoader
classLoader
=
LoaderUtils
.
getContextClassLoader
(
)
;
try
{
Class
clazz
=
null
;
if
(
classLoader
!=
null
)
{
try
{
clazz
=
classLoader
.
loadClass
(
helperClass
)
;
}
catch
(
ClassNotFoundException
ex
)
{
}
}
if
(
clazz
==
null
)
{
clazz
=
Class
.
forName
(
helperClass
)
;
}
return
(
(
ProjectHelper
)
clazz
.
newInstance
(
)
)
;
}
catch
(
Exception
e
)
{
throw
new
BuildException
(
e
)
;
}
}
public
static
ClassLoader
getContextClassLoader
(
)
{
if
(
!
LoaderUtils
.
isContextLoaderAvailable
(
)
)
{
return
null
;
}
return
LoaderUtils
.
getContextClassLoader
(
)
;
}
public
static
void
configure
(
Object
target
,
AttributeList
attrs
,
Project
project
)
throws
BuildException
{
if
(
target
instanceof
TypeAdapter
)
{
target
=
(
(
TypeAdapter
)
target
)
.
getProxy
(
)
;
}
IntrospectionHelper
ih
=
IntrospectionHelper
.
getHelper
(
project
,
target
.
getClass
(
)
)
;
for
(
int
i
=
0
;
i
<
attrs
.
getLength
(
)
;
i
++
)
{
String
value
=
replaceProperties
(
project
,
attrs
.
getValue
(
i
)
,
project
.
getProperties
(
)
)
;
try
{
ih
.
setAttribute
(
project
,
target
,
attrs
.
getName
(
i
)
.
toLowerCase
(
Locale
.
US
)
,
value
)
;
}
catch
(
BuildException
be
)
{
if
(
!
attrs
.
getName
(
i
)
.
equals
(
"id"
)
)
{
throw
be
;
}
}
}
}
public
static
void
addText
(
Project
project
,
Object
target
,
char
[
]
buf
,
int
start
,
int
count
)
throws
BuildException
{
addText
(
project
,
target
,
new
String
(
buf
,
start
,
count
)
)
;
}
public
static
void
addText
(
Project
project
,
Object
target
,
String
text
)
throws
BuildException
{
if
(
text
==
null
)
{
return
;
}
if
(
target
instanceof
TypeAdapter
)
{
target
=
(
(
TypeAdapter
)
target
)
.
getProxy
(
)
;
}
IntrospectionHelper
.
getHelper
(
project
,
target
.
getClass
(
)
)
.
addText
(
project
,
target
,
text
)
;
}
public
static
void
storeChild
(
Project
project
,
Object
parent
,
Object
child
,
String
tag
)
{
IntrospectionHelper
ih
=
IntrospectionHelper
.
getHelper
(
project
,
parent
.
getClass
(
)
)
;
ih
.
storeElement
(
project
,
parent
,
child
,
tag
)
;
}
public
static
String
replaceProperties
(
Project
project
,
String
value
)
throws
BuildException
{
return
project
.
replaceProperties
(
value
)
;
}
public
static
String
replaceProperties
(
Project
project
,
String
value
,
Hashtable
keys
)
throws
BuildException
{
PropertyHelper
ph
=
PropertyHelper
.
getPropertyHelper
(
project
)
;
return
ph
.
replaceProperties
(
null
,
value
,
keys
)
;
}
public
static
void
parsePropertyString
(
String
value
,
Vector
fragments
,
Vector
propertyRefs
)
throws
BuildException
{
PropertyHelper
.
parsePropertyStringDefault
(
value
,
fragments
,
propertyRefs
)
;
}
public
static
String
genComponentName
(
String
uri
,
String
name
)
{
if
(
uri
==
null
||
uri
.
equals
(
""
)
||
uri
.
equals
(
ANT_CORE_URI
)
)
{
return
name
;
}
return
uri
+
":"
+
name
;
}
public
static
String
extractUriFromComponentName
(
String
componentName
)
{
if
(
componentName
==
null
)
{
return
""
;
}
int
index
=
componentName
.
lastIndexOf
(
':'
)
;
if
(
index
==
-
1
)
{
return
""
;
}
return
componentName
.
substring
(
0
,
index
)
;
}
public
static
String
extractNameFromComponentName
(
String
componentName
)
{
int
index
=
componentName
.
lastIndexOf
(
':'
)
;
if
(
index
==
-
1
)
{
return
componentName
;
}
return
componentName
.
substring
(
index
+
1
)
;
}
public
static
BuildException
addLocationToBuildException
(
BuildException
ex
,
Location
newLocation
)
{
if
(
ex
.
getLocation
(
)
==
null
||
ex
.
getMessage
(
)
==
null
)
{
return
ex
;
}
String
errorMessage
=
"The following error occurred while executing this line:"
+
System
.
getProperty
(
"line.separator"
)
+
ex
.
getLocation
(
)
.
toString
(
)
+
ex
.
getMessage
(
)
;
if
(
newLocation
==
null
)
{
return
new
BuildException
(
errorMessage
,
ex
)
;
}
else
{
return
new
BuildException
(
errorMessage
,
ex
,
newLocation
)
;
}
}
}
