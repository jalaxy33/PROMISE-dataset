package
org
.
apache
.
tools
.
ant
.
taskdefs
;
import
org
.
apache
.
tools
.
ant
.
*
;
import
org
.
apache
.
tools
.
ant
.
types
.
*
;
import
org
.
apache
.
tools
.
ant
.
util
.
*
;
import
java
.
io
.
*
;
import
java
.
util
.
*
;
public
class
Copy
extends
Task
{
protected
File
file
=
null
;
protected
File
destFile
=
null
;
protected
File
destDir
=
null
;
protected
Vector
filesets
=
new
Vector
(
)
;
protected
boolean
filtering
=
false
;
protected
boolean
preserveLastModified
=
false
;
protected
boolean
forceOverwrite
=
false
;
protected
boolean
flatten
=
false
;
protected
int
verbosity
=
Project
.
MSG_VERBOSE
;
protected
boolean
includeEmpty
=
true
;
protected
Hashtable
fileCopyMap
=
new
Hashtable
(
)
;
protected
Hashtable
dirCopyMap
=
new
Hashtable
(
)
;
protected
Mapper
mapperElement
=
null
;
public
void
setFile
(
File
file
)
{
this
.
file
=
file
;
}
public
void
setTofile
(
File
destFile
)
{
this
.
destFile
=
destFile
;
}
public
void
setTodir
(
File
destDir
)
{
this
.
destDir
=
destDir
;
}
public
void
setPreserveLastModified
(
String
preserve
)
{
preserveLastModified
=
Project
.
toBoolean
(
preserve
)
;
}
public
void
setFiltering
(
boolean
filtering
)
{
this
.
filtering
=
filtering
;
}
public
void
setOverwrite
(
boolean
overwrite
)
{
this
.
forceOverwrite
=
overwrite
;
}
public
void
setFlatten
(
boolean
flatten
)
{
this
.
flatten
=
flatten
;
}
public
void
setVerbose
(
boolean
verbose
)
{
if
(
verbose
)
{
this
.
verbosity
=
Project
.
MSG_INFO
;
}
else
{
this
.
verbosity
=
Project
.
MSG_VERBOSE
;
}
}
public
void
setIncludeEmptyDirs
(
boolean
includeEmpty
)
{
this
.
includeEmpty
=
includeEmpty
;
}
public
void
addFileset
(
FileSet
set
)
{
filesets
.
addElement
(
set
)
;
}
public
Mapper
createMapper
(
)
throws
BuildException
{
if
(
mapperElement
!=
null
)
{
throw
new
BuildException
(
"Cannot define more than one mapper"
,
location
)
;
}
mapperElement
=
new
Mapper
(
project
)
;
return
mapperElement
;
}
public
void
execute
(
)
throws
BuildException
{
validateAttributes
(
)
;
if
(
file
!=
null
)
{
if
(
file
.
exists
(
)
)
{
if
(
destFile
==
null
)
{
destFile
=
new
File
(
destDir
,
file
.
getName
(
)
)
;
}
if
(
forceOverwrite
||
(
file
.
lastModified
(
)
>
destFile
.
lastModified
(
)
)
)
{
fileCopyMap
.
put
(
file
.
getAbsolutePath
(
)
,
destFile
.
getAbsolutePath
(
)
)
;
}
}
else
{
log
(
"Could not find file "
+
file
.
getAbsolutePath
(
)
+
" to copy."
)
;
}
}
for
(
int
i
=
0
;
i
<
filesets
.
size
(
)
;
i
++
)
{
FileSet
fs
=
(
FileSet
)
filesets
.
elementAt
(
i
)
;
DirectoryScanner
ds
=
fs
.
getDirectoryScanner
(
project
)
;
File
fromDir
=
fs
.
getDir
(
project
)
;
String
[
]
srcFiles
=
ds
.
getIncludedFiles
(
)
;
String
[
]
srcDirs
=
ds
.
getIncludedDirectories
(
)
;
scan
(
fromDir
,
destDir
,
srcFiles
,
srcDirs
)
;
}
doFileOperations
(
)
;
if
(
destFile
!=
null
)
{
destDir
=
null
;
}
}
protected
void
validateAttributes
(
)
throws
BuildException
{
if
(
file
==
null
&&
filesets
.
size
(
)
==
0
)
{
throw
new
BuildException
(
"Specify at least one source - a file or a fileset."
)
;
}
if
(
destFile
!=
null
&&
destDir
!=
null
)
{
throw
new
BuildException
(
"Only one of destfile and destdir may be set."
)
;
}
if
(
destFile
==
null
&&
destDir
==
null
)
{
throw
new
BuildException
(
"One of destfile or destdir must be set."
)
;
}
if
(
file
!=
null
&&
file
.
exists
(
)
&&
file
.
isDirectory
(
)
)
{
throw
new
BuildException
(
"Use a fileset to copy directories."
)
;
}
if
(
destFile
!=
null
&&
filesets
.
size
(
)
>
0
)
{
throw
new
BuildException
(
"Cannot concatenate multple files into a single file."
)
;
}
if
(
destFile
!=
null
)
{
destDir
=
new
File
(
destFile
.
getParent
(
)
)
;
}
}
protected
void
scan
(
File
fromDir
,
File
toDir
,
String
[
]
files
,
String
[
]
dirs
)
{
FileNameMapper
mapper
=
null
;
if
(
mapperElement
!=
null
)
{
mapper
=
mapperElement
.
getImplementation
(
)
;
}
else
if
(
flatten
)
{
mapper
=
new
FlatFileNameMapper
(
)
;
}
else
{
mapper
=
new
IdentityMapper
(
)
;
}
buildMap
(
fromDir
,
toDir
,
files
,
mapper
,
fileCopyMap
)
;
if
(
includeEmpty
)
{
buildMap
(
fromDir
,
toDir
,
dirs
,
mapper
,
dirCopyMap
)
;
}
}
protected
void
buildMap
(
File
fromDir
,
File
toDir
,
String
[
]
names
,
FileNameMapper
mapper
,
Hashtable
map
)
{
String
[
]
toCopy
=
null
;
if
(
forceOverwrite
)
{
Vector
v
=
new
Vector
(
)
;
for
(
int
i
=
0
;
i
<
names
.
length
;
i
++
)
{
if
(
mapper
.
mapFileName
(
names
[
i
]
)
!=
null
)
{
v
.
addElement
(
names
[
i
]
)
;
}
}
toCopy
=
new
String
[
v
.
size
(
)
]
;
v
.
copyInto
(
toCopy
)
;
}
else
{
SourceFileScanner
ds
=
new
SourceFileScanner
(
this
)
;
toCopy
=
ds
.
restrict
(
names
,
fromDir
,
toDir
,
mapper
)
;
}
for
(
int
i
=
0
;
i
<
toCopy
.
length
;
i
++
)
{
File
src
=
new
File
(
fromDir
,
toCopy
[
i
]
)
;
File
dest
=
new
File
(
toDir
,
mapper
.
mapFileName
(
toCopy
[
i
]
)
[
0
]
)
;
map
.
put
(
src
.
getAbsolutePath
(
)
,
dest
.
getAbsolutePath
(
)
)
;
}
}
protected
void
doFileOperations
(
)
{
if
(
fileCopyMap
.
size
(
)
>
0
)
{
log
(
"Copying "
+
fileCopyMap
.
size
(
)
+
" file"
+
(
fileCopyMap
.
size
(
)
==
1
?
""
:
"s"
)
+
" to "
+
destDir
.
getAbsolutePath
(
)
)
;
Enumeration
e
=
fileCopyMap
.
keys
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
String
fromFile
=
(
String
)
e
.
nextElement
(
)
;
String
toFile
=
(
String
)
fileCopyMap
.
get
(
fromFile
)
;
if
(
fromFile
.
equals
(
toFile
)
)
{
log
(
"Skipping self-copy of "
+
fromFile
,
verbosity
)
;
continue
;
}
try
{
log
(
"Copying "
+
fromFile
+
" to "
+
toFile
,
verbosity
)
;
project
.
copyFile
(
fromFile
,
toFile
,
filtering
,
forceOverwrite
,
preserveLastModified
)
;
}
catch
(
IOException
ioe
)
{
String
msg
=
"Failed to copy "
+
fromFile
+
" to "
+
toFile
+
" due to "
+
ioe
.
getMessage
(
)
;
throw
new
BuildException
(
msg
,
ioe
,
location
)
;
}
}
}
if
(
includeEmpty
)
{
Enumeration
e
=
dirCopyMap
.
elements
(
)
;
int
count
=
0
;
while
(
e
.
hasMoreElements
(
)
)
{
File
d
=
new
File
(
(
String
)
e
.
nextElement
(
)
)
;
if
(
!
d
.
exists
(
)
)
{
if
(
!
d
.
mkdirs
(
)
)
{
log
(
"Unable to create directory "
+
d
.
getAbsolutePath
(
)
,
Project
.
MSG_ERR
)
;
}
else
{
count
++
;
}
}
}
if
(
count
>
0
)
{
log
(
"Copied "
+
count
+
" empty director"
+
(
count
==
1
?
"y"
:
"ies"
)
+
" to "
+
destDir
.
getAbsolutePath
(
)
)
;
}
}
}
}
