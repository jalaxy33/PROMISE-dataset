package
org
.
apache
.
tools
.
ant
;
import
java
.
io
.
File
;
import
java
.
io
.
IOException
;
import
java
.
util
.
Vector
;
import
java
.
util
.
StringTokenizer
;
import
org
.
apache
.
tools
.
ant
.
types
.
selectors
.
SelectorScanner
;
import
org
.
apache
.
tools
.
ant
.
types
.
selectors
.
FileSelector
;
import
org
.
apache
.
tools
.
ant
.
types
.
selectors
.
SelectorUtils
;
import
org
.
apache
.
tools
.
ant
.
util
.
FileUtils
;
public
class
DirectoryScanner
implements
FileScanner
,
SelectorScanner
{
protected
static
final
String
[
]
DEFAULTEXCLUDES
=
{
"**/*~"
,
"**/#*#"
,
"**/.#*"
,
"**/%*%"
,
"**/._*"
,
"**/CVS"
,
"**/CVS/**"
,
"**/.cvsignore"
,
"**/SCCS"
,
"**/SCCS/**"
,
"**/vssver.scc"
,
"**/.svn"
,
"**/.svn/**"
}
;
protected
File
basedir
;
protected
String
[
]
includes
;
protected
String
[
]
excludes
;
protected
FileSelector
[
]
selectors
=
null
;
protected
Vector
filesIncluded
;
protected
Vector
filesNotIncluded
;
protected
Vector
filesExcluded
;
protected
Vector
dirsIncluded
;
protected
Vector
dirsNotIncluded
;
protected
Vector
dirsExcluded
;
protected
Vector
filesDeselected
;
protected
Vector
dirsDeselected
;
protected
boolean
haveSlowResults
=
false
;
protected
boolean
isCaseSensitive
=
true
;
private
boolean
followSymlinks
=
true
;
private
static
final
FileUtils
fileUtils
=
FileUtils
.
newFileUtils
(
)
;
protected
boolean
everythingIncluded
=
true
;
public
DirectoryScanner
(
)
{
}
protected
static
boolean
matchPatternStart
(
String
pattern
,
String
str
)
{
return
SelectorUtils
.
matchPatternStart
(
pattern
,
str
)
;
}
protected
static
boolean
matchPatternStart
(
String
pattern
,
String
str
,
boolean
isCaseSensitive
)
{
return
SelectorUtils
.
matchPatternStart
(
pattern
,
str
,
isCaseSensitive
)
;
}
protected
static
boolean
matchPath
(
String
pattern
,
String
str
)
{
return
SelectorUtils
.
matchPath
(
pattern
,
str
)
;
}
protected
static
boolean
matchPath
(
String
pattern
,
String
str
,
boolean
isCaseSensitive
)
{
return
SelectorUtils
.
matchPath
(
pattern
,
str
,
isCaseSensitive
)
;
}
public
static
boolean
match
(
String
pattern
,
String
str
)
{
return
SelectorUtils
.
match
(
pattern
,
str
)
;
}
protected
static
boolean
match
(
String
pattern
,
String
str
,
boolean
isCaseSensitive
)
{
return
SelectorUtils
.
match
(
pattern
,
str
,
isCaseSensitive
)
;
}
private
static
Vector
tokenizePath
(
String
path
)
{
return
SelectorUtils
.
tokenizePath
(
path
)
;
}
public
void
setBasedir
(
String
basedir
)
{
setBasedir
(
new
File
(
basedir
.
replace
(
'/'
,
File
.
separatorChar
)
.
replace
(
'\\'
,
File
.
separatorChar
)
)
)
;
}
public
void
setBasedir
(
File
basedir
)
{
this
.
basedir
=
basedir
;
}
public
File
getBasedir
(
)
{
return
basedir
;
}
public
void
setCaseSensitive
(
boolean
isCaseSensitive
)
{
this
.
isCaseSensitive
=
isCaseSensitive
;
}
public
void
setFollowSymlinks
(
boolean
followSymlinks
)
{
this
.
followSymlinks
=
followSymlinks
;
}
public
void
setIncludes
(
String
[
]
includes
)
{
if
(
includes
==
null
)
{
this
.
includes
=
null
;
}
else
{
this
.
includes
=
new
String
[
includes
.
length
]
;
for
(
int
i
=
0
;
i
<
includes
.
length
;
i
++
)
{
String
pattern
;
pattern
=
includes
[
i
]
.
replace
(
'/'
,
File
.
separatorChar
)
.
replace
(
'\\'
,
File
.
separatorChar
)
;
if
(
pattern
.
endsWith
(
File
.
separator
)
)
{
pattern
+=
"**"
;
}
this
.
includes
[
i
]
=
pattern
;
}
}
}
public
void
setExcludes
(
String
[
]
excludes
)
{
if
(
excludes
==
null
)
{
this
.
excludes
=
null
;
}
else
{
this
.
excludes
=
new
String
[
excludes
.
length
]
;
for
(
int
i
=
0
;
i
<
excludes
.
length
;
i
++
)
{
String
pattern
;
pattern
=
excludes
[
i
]
.
replace
(
'/'
,
File
.
separatorChar
)
.
replace
(
'\\'
,
File
.
separatorChar
)
;
if
(
pattern
.
endsWith
(
File
.
separator
)
)
{
pattern
+=
"**"
;
}
this
.
excludes
[
i
]
=
pattern
;
}
}
}
public
void
setSelectors
(
FileSelector
[
]
selectors
)
{
this
.
selectors
=
selectors
;
}
public
boolean
isEverythingIncluded
(
)
{
return
everythingIncluded
;
}
public
void
scan
(
)
throws
IllegalStateException
{
if
(
basedir
==
null
)
{
throw
new
IllegalStateException
(
"No basedir set"
)
;
}
if
(
!
basedir
.
exists
(
)
)
{
throw
new
IllegalStateException
(
"basedir "
+
basedir
+
" does not exist"
)
;
}
if
(
!
basedir
.
isDirectory
(
)
)
{
throw
new
IllegalStateException
(
"basedir "
+
basedir
+
" is not a directory"
)
;
}
if
(
includes
==
null
)
{
includes
=
new
String
[
1
]
;
includes
[
0
]
=
"**"
;
}
if
(
excludes
==
null
)
{
excludes
=
new
String
[
0
]
;
}
filesIncluded
=
new
Vector
(
)
;
filesNotIncluded
=
new
Vector
(
)
;
filesExcluded
=
new
Vector
(
)
;
filesDeselected
=
new
Vector
(
)
;
dirsIncluded
=
new
Vector
(
)
;
dirsNotIncluded
=
new
Vector
(
)
;
dirsExcluded
=
new
Vector
(
)
;
dirsDeselected
=
new
Vector
(
)
;
if
(
isIncluded
(
""
)
)
{
if
(
!
isExcluded
(
""
)
)
{
if
(
isSelected
(
""
,
basedir
)
)
{
dirsIncluded
.
addElement
(
""
)
;
}
else
{
dirsDeselected
.
addElement
(
""
)
;
}
}
else
{
dirsExcluded
.
addElement
(
""
)
;
}
}
else
{
dirsNotIncluded
.
addElement
(
""
)
;
}
scandir
(
basedir
,
""
,
true
)
;
}
protected
void
slowScan
(
)
{
if
(
haveSlowResults
)
{
return
;
}
String
[
]
excl
=
new
String
[
dirsExcluded
.
size
(
)
]
;
dirsExcluded
.
copyInto
(
excl
)
;
String
[
]
notIncl
=
new
String
[
dirsNotIncluded
.
size
(
)
]
;
dirsNotIncluded
.
copyInto
(
notIncl
)
;
for
(
int
i
=
0
;
i
<
excl
.
length
;
i
++
)
{
if
(
!
couldHoldIncluded
(
excl
[
i
]
)
)
{
scandir
(
new
File
(
basedir
,
excl
[
i
]
)
,
excl
[
i
]
+
File
.
separator
,
false
)
;
}
}
for
(
int
i
=
0
;
i
<
notIncl
.
length
;
i
++
)
{
if
(
!
couldHoldIncluded
(
notIncl
[
i
]
)
)
{
scandir
(
new
File
(
basedir
,
notIncl
[
i
]
)
,
notIncl
[
i
]
+
File
.
separator
,
false
)
;
}
}
haveSlowResults
=
true
;
}
protected
void
scandir
(
File
dir
,
String
vpath
,
boolean
fast
)
{
String
[
]
newfiles
=
dir
.
list
(
)
;
if
(
newfiles
==
null
)
{
throw
new
BuildException
(
"IO error scanning directory "
+
dir
.
getAbsolutePath
(
)
)
;
}
if
(
!
followSymlinks
)
{
Vector
noLinks
=
new
Vector
(
)
;
for
(
int
i
=
0
;
i
<
newfiles
.
length
;
i
++
)
{
try
{
if
(
fileUtils
.
isSymbolicLink
(
dir
,
newfiles
[
i
]
)
)
{
String
name
=
vpath
+
newfiles
[
i
]
;
File
file
=
new
File
(
dir
,
newfiles
[
i
]
)
;
if
(
file
.
isDirectory
(
)
)
{
dirsExcluded
.
addElement
(
name
)
;
}
else
{
filesExcluded
.
addElement
(
name
)
;
}
}
else
{
noLinks
.
addElement
(
newfiles
[
i
]
)
;
}
}
catch
(
IOException
ioe
)
{
String
msg
=
"IOException caught while checking "
+
"for links, couldn't get cannonical path!"
;
System
.
err
.
println
(
msg
)
;
noLinks
.
addElement
(
newfiles
[
i
]
)
;
}
}
newfiles
=
new
String
[
noLinks
.
size
(
)
]
;
noLinks
.
copyInto
(
newfiles
)
;
}
for
(
int
i
=
0
;
i
<
newfiles
.
length
;
i
++
)
{
String
name
=
vpath
+
newfiles
[
i
]
;
File
file
=
new
File
(
dir
,
newfiles
[
i
]
)
;
if
(
file
.
isDirectory
(
)
)
{
if
(
isIncluded
(
name
)
)
{
if
(
!
isExcluded
(
name
)
)
{
if
(
isSelected
(
name
,
file
)
)
{
dirsIncluded
.
addElement
(
name
)
;
if
(
fast
)
{
scandir
(
file
,
name
+
File
.
separator
,
fast
)
;
}
}
else
{
everythingIncluded
=
false
;
dirsDeselected
.
addElement
(
name
)
;
if
(
fast
&&
couldHoldIncluded
(
name
)
)
{
scandir
(
file
,
name
+
File
.
separator
,
fast
)
;
}
}
}
else
{
everythingIncluded
=
false
;
dirsExcluded
.
addElement
(
name
)
;
if
(
fast
&&
couldHoldIncluded
(
name
)
)
{
scandir
(
file
,
name
+
File
.
separator
,
fast
)
;
}
}
}
else
{
everythingIncluded
=
false
;
dirsNotIncluded
.
addElement
(
name
)
;
if
(
fast
&&
couldHoldIncluded
(
name
)
)
{
scandir
(
file
,
name
+
File
.
separator
,
fast
)
;
}
}
if
(
!
fast
)
{
scandir
(
file
,
name
+
File
.
separator
,
fast
)
;
}
}
else
if
(
file
.
isFile
(
)
)
{
if
(
isIncluded
(
name
)
)
{
if
(
!
isExcluded
(
name
)
)
{
if
(
isSelected
(
name
,
file
)
)
{
filesIncluded
.
addElement
(
name
)
;
}
else
{
everythingIncluded
=
false
;
filesDeselected
.
addElement
(
name
)
;
}
}
else
{
everythingIncluded
=
false
;
filesExcluded
.
addElement
(
name
)
;
}
}
else
{
everythingIncluded
=
false
;
filesNotIncluded
.
addElement
(
name
)
;
}
}
}
}
protected
boolean
isIncluded
(
String
name
)
{
for
(
int
i
=
0
;
i
<
includes
.
length
;
i
++
)
{
if
(
matchPath
(
includes
[
i
]
,
name
,
isCaseSensitive
)
)
{
return
true
;
}
}
return
false
;
}
protected
boolean
couldHoldIncluded
(
String
name
)
{
for
(
int
i
=
0
;
i
<
includes
.
length
;
i
++
)
{
if
(
matchPatternStart
(
includes
[
i
]
,
name
,
isCaseSensitive
)
)
{
return
true
;
}
}
return
false
;
}
protected
boolean
isExcluded
(
String
name
)
{
for
(
int
i
=
0
;
i
<
excludes
.
length
;
i
++
)
{
if
(
matchPath
(
excludes
[
i
]
,
name
,
isCaseSensitive
)
)
{
return
true
;
}
}
return
false
;
}
protected
boolean
isSelected
(
String
name
,
File
file
)
{
if
(
selectors
!=
null
)
{
for
(
int
i
=
0
;
i
<
selectors
.
length
;
i
++
)
{
if
(
(
selectors
[
i
]
.
isSelected
(
basedir
,
name
,
file
)
)
==
false
)
{
return
false
;
}
}
}
return
true
;
}
public
String
[
]
getIncludedFiles
(
)
{
int
count
=
filesIncluded
.
size
(
)
;
String
[
]
files
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
files
[
i
]
=
(
String
)
filesIncluded
.
elementAt
(
i
)
;
}
return
files
;
}
public
String
[
]
getNotIncludedFiles
(
)
{
slowScan
(
)
;
int
count
=
filesNotIncluded
.
size
(
)
;
String
[
]
files
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
files
[
i
]
=
(
String
)
filesNotIncluded
.
elementAt
(
i
)
;
}
return
files
;
}
public
String
[
]
getExcludedFiles
(
)
{
slowScan
(
)
;
int
count
=
filesExcluded
.
size
(
)
;
String
[
]
files
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
files
[
i
]
=
(
String
)
filesExcluded
.
elementAt
(
i
)
;
}
return
files
;
}
public
String
[
]
getDeselectedFiles
(
)
{
slowScan
(
)
;
int
count
=
filesDeselected
.
size
(
)
;
String
[
]
files
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
files
[
i
]
=
(
String
)
filesDeselected
.
elementAt
(
i
)
;
}
return
files
;
}
public
String
[
]
getIncludedDirectories
(
)
{
int
count
=
dirsIncluded
.
size
(
)
;
String
[
]
directories
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
directories
[
i
]
=
(
String
)
dirsIncluded
.
elementAt
(
i
)
;
}
return
directories
;
}
public
String
[
]
getNotIncludedDirectories
(
)
{
slowScan
(
)
;
int
count
=
dirsNotIncluded
.
size
(
)
;
String
[
]
directories
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
directories
[
i
]
=
(
String
)
dirsNotIncluded
.
elementAt
(
i
)
;
}
return
directories
;
}
public
String
[
]
getExcludedDirectories
(
)
{
slowScan
(
)
;
int
count
=
dirsExcluded
.
size
(
)
;
String
[
]
directories
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
directories
[
i
]
=
(
String
)
dirsExcluded
.
elementAt
(
i
)
;
}
return
directories
;
}
public
String
[
]
getDeselectedDirectories
(
)
{
slowScan
(
)
;
int
count
=
dirsDeselected
.
size
(
)
;
String
[
]
directories
=
new
String
[
count
]
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
directories
[
i
]
=
(
String
)
dirsDeselected
.
elementAt
(
i
)
;
}
return
directories
;
}
public
void
addDefaultExcludes
(
)
{
int
excludesLength
=
excludes
==
null
?
0
:
excludes
.
length
;
String
[
]
newExcludes
;
newExcludes
=
new
String
[
excludesLength
+
DEFAULTEXCLUDES
.
length
]
;
if
(
excludesLength
>
0
)
{
System
.
arraycopy
(
excludes
,
0
,
newExcludes
,
0
,
excludesLength
)
;
}
for
(
int
i
=
0
;
i
<
DEFAULTEXCLUDES
.
length
;
i
++
)
{
newExcludes
[
i
+
excludesLength
]
=
DEFAULTEXCLUDES
[
i
]
.
replace
(
'/'
,
File
.
separatorChar
)
.
replace
(
'\\'
,
File
.
separatorChar
)
;
}
excludes
=
newExcludes
;
}
}
