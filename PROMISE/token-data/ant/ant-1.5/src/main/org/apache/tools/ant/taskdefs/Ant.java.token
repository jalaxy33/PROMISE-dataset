package
org
.
apache
.
tools
.
ant
.
taskdefs
;
import
org
.
apache
.
tools
.
ant
.
Task
;
import
org
.
apache
.
tools
.
ant
.
Project
;
import
org
.
apache
.
tools
.
ant
.
ProjectComponent
;
import
org
.
apache
.
tools
.
ant
.
BuildListener
;
import
org
.
apache
.
tools
.
ant
.
DefaultLogger
;
import
org
.
apache
.
tools
.
ant
.
BuildException
;
import
org
.
apache
.
tools
.
ant
.
ProjectHelper
;
import
org
.
apache
.
tools
.
ant
.
util
.
FileUtils
;
import
java
.
io
.
File
;
import
java
.
io
.
PrintStream
;
import
java
.
io
.
FileOutputStream
;
import
java
.
io
.
IOException
;
import
java
.
lang
.
reflect
.
Method
;
import
java
.
util
.
Vector
;
import
java
.
util
.
Hashtable
;
import
java
.
util
.
Enumeration
;
public
class
Ant
extends
Task
{
private
File
dir
=
null
;
private
String
antFile
=
null
;
private
String
target
=
null
;
private
String
output
=
null
;
private
boolean
inheritAll
=
true
;
private
boolean
inheritRefs
=
false
;
private
Vector
properties
=
new
Vector
(
)
;
private
Vector
references
=
new
Vector
(
)
;
private
Project
newProject
;
private
PrintStream
out
=
null
;
public
void
setInheritAll
(
boolean
value
)
{
inheritAll
=
value
;
}
public
void
setInheritRefs
(
boolean
value
)
{
inheritRefs
=
value
;
}
public
void
init
(
)
{
newProject
=
new
Project
(
)
;
newProject
.
setJavaVersionProperty
(
)
;
newProject
.
addTaskDefinition
(
"property"
,
(
Class
)
project
.
getTaskDefinitions
(
)
.
get
(
"property"
)
)
;
}
private
void
reinit
(
)
{
init
(
)
;
final
int
count
=
properties
.
size
(
)
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
Property
p
=
(
Property
)
properties
.
elementAt
(
i
)
;
Property
newP
=
(
Property
)
newProject
.
createTask
(
"property"
)
;
newP
.
setName
(
p
.
getName
(
)
)
;
if
(
p
.
getValue
(
)
!=
null
)
{
newP
.
setValue
(
p
.
getValue
(
)
)
;
}
if
(
p
.
getFile
(
)
!=
null
)
{
newP
.
setFile
(
p
.
getFile
(
)
)
;
}
if
(
p
.
getResource
(
)
!=
null
)
{
newP
.
setResource
(
p
.
getResource
(
)
)
;
}
if
(
p
.
getPrefix
(
)
!=
null
)
{
newP
.
setPrefix
(
p
.
getPrefix
(
)
)
;
}
if
(
p
.
getRefid
(
)
!=
null
)
{
newP
.
setRefid
(
p
.
getRefid
(
)
)
;
}
if
(
p
.
getEnvironment
(
)
!=
null
)
{
newP
.
setEnvironment
(
p
.
getEnvironment
(
)
)
;
}
if
(
p
.
getClasspath
(
)
!=
null
)
{
newP
.
setClasspath
(
p
.
getClasspath
(
)
)
;
}
properties
.
setElementAt
(
newP
,
i
)
;
}
}
private
void
initializeProject
(
)
{
newProject
.
setInputHandler
(
getProject
(
)
.
getInputHandler
(
)
)
;
Vector
listeners
=
project
.
getBuildListeners
(
)
;
final
int
count
=
listeners
.
size
(
)
;
for
(
int
i
=
0
;
i
<
count
;
i
++
)
{
newProject
.
addBuildListener
(
(
BuildListener
)
listeners
.
elementAt
(
i
)
)
;
}
if
(
output
!=
null
)
{
File
outfile
=
null
;
if
(
dir
!=
null
)
{
outfile
=
FileUtils
.
newFileUtils
(
)
.
resolveFile
(
dir
,
output
)
;
}
else
{
outfile
=
getProject
(
)
.
resolveFile
(
output
)
;
}
try
{
out
=
new
PrintStream
(
new
FileOutputStream
(
outfile
)
)
;
DefaultLogger
logger
=
new
DefaultLogger
(
)
;
logger
.
setMessageOutputLevel
(
Project
.
MSG_INFO
)
;
logger
.
setOutputPrintStream
(
out
)
;
logger
.
setErrorPrintStream
(
out
)
;
newProject
.
addBuildListener
(
logger
)
;
}
catch
(
IOException
ex
)
{
log
(
"Ant: Can't set output to "
+
output
)
;
}
}
Hashtable
taskdefs
=
project
.
getTaskDefinitions
(
)
;
Enumeration
et
=
taskdefs
.
keys
(
)
;
while
(
et
.
hasMoreElements
(
)
)
{
String
taskName
=
(
String
)
et
.
nextElement
(
)
;
if
(
taskName
.
equals
(
"property"
)
)
{
continue
;
}
Class
taskClass
=
(
Class
)
taskdefs
.
get
(
taskName
)
;
newProject
.
addTaskDefinition
(
taskName
,
taskClass
)
;
}
Hashtable
typedefs
=
project
.
getDataTypeDefinitions
(
)
;
Enumeration
e
=
typedefs
.
keys
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
String
typeName
=
(
String
)
e
.
nextElement
(
)
;
Class
typeClass
=
(
Class
)
typedefs
.
get
(
typeName
)
;
newProject
.
addDataTypeDefinition
(
typeName
,
typeClass
)
;
}
getProject
(
)
.
copyUserProperties
(
newProject
)
;
if
(
!
inheritAll
)
{
newProject
.
setSystemProperties
(
)
;
}
else
{
Hashtable
props
=
getProject
(
)
.
getProperties
(
)
;
e
=
props
.
keys
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
String
arg
=
e
.
nextElement
(
)
.
toString
(
)
;
if
(
"basedir"
.
equals
(
arg
)
||
"ant.file"
.
equals
(
arg
)
)
{
continue
;
}
String
value
=
props
.
get
(
arg
)
.
toString
(
)
;
if
(
newProject
.
getProperty
(
arg
)
==
null
)
{
newProject
.
setNewProperty
(
arg
,
value
)
;
}
}
}
}
protected
void
handleOutput
(
String
line
)
{
if
(
newProject
!=
null
)
{
newProject
.
demuxOutput
(
line
,
false
)
;
}
else
{
super
.
handleOutput
(
line
)
;
}
}
protected
void
handleErrorOutput
(
String
line
)
{
if
(
newProject
!=
null
)
{
newProject
.
demuxOutput
(
line
,
true
)
;
}
else
{
super
.
handleErrorOutput
(
line
)
;
}
}
public
void
execute
(
)
throws
BuildException
{
File
savedDir
=
dir
;
String
savedAntFile
=
antFile
;
String
savedTarget
=
target
;
try
{
if
(
newProject
==
null
)
{
reinit
(
)
;
}
if
(
(
dir
==
null
)
&&
(
inheritAll
)
)
{
dir
=
project
.
getBaseDir
(
)
;
}
initializeProject
(
)
;
if
(
dir
!=
null
)
{
newProject
.
setBaseDir
(
dir
)
;
if
(
savedDir
!=
null
)
{
newProject
.
setInheritedProperty
(
"basedir"
,
dir
.
getAbsolutePath
(
)
)
;
}
}
else
{
dir
=
project
.
getBaseDir
(
)
;
}
overrideProperties
(
)
;
if
(
antFile
==
null
)
{
antFile
=
"build.xml"
;
}
File
file
=
FileUtils
.
newFileUtils
(
)
.
resolveFile
(
dir
,
antFile
)
;
antFile
=
file
.
getAbsolutePath
(
)
;
log
(
"calling target "
+
(
target
!=
null
?
target
:
"[default]"
)
+
" in build file "
+
antFile
.
toString
(
)
,
Project
.
MSG_VERBOSE
)
;
newProject
.
setUserProperty
(
"ant.file"
,
antFile
)
;
ProjectHelper
.
configureProject
(
newProject
,
new
File
(
antFile
)
)
;
if
(
target
==
null
)
{
target
=
newProject
.
getDefaultTarget
(
)
;
}
addReferences
(
)
;
if
(
newProject
.
getBaseDir
(
)
.
equals
(
project
.
getBaseDir
(
)
)
&&
newProject
.
getProperty
(
"ant.file"
)
.
equals
(
project
.
getProperty
(
"ant.file"
)
)
&&
getOwningTarget
(
)
!=
null
&&
target
.
equals
(
this
.
getOwningTarget
(
)
.
getName
(
)
)
)
{
throw
new
BuildException
(
"ant task calling its own parent "
+
"target"
)
;
}
newProject
.
executeTarget
(
target
)
;
}
finally
{
newProject
=
null
;
if
(
output
!=
null
&&
out
!=
null
)
{
try
{
out
.
close
(
)
;
}
catch
(
final
Exception
e
)
{
}
}
dir
=
savedDir
;
antFile
=
savedAntFile
;
target
=
savedTarget
;
}
}
private
void
overrideProperties
(
)
throws
BuildException
{
Enumeration
e
=
properties
.
elements
(
)
;
while
(
e
.
hasMoreElements
(
)
)
{
Property
p
=
(
Property
)
e
.
nextElement
(
)
;
p
.
setProject
(
newProject
)
;
p
.
execute
(
)
;
}
getProject
(
)
.
copyInheritedProperties
(
newProject
)
;
}
private
void
addReferences
(
)
throws
BuildException
{
Hashtable
thisReferences
=
(
Hashtable
)
project
.
getReferences
(
)
.
clone
(
)
;
Hashtable
newReferences
=
newProject
.
getReferences
(
)
;
Enumeration
e
;
if
(
references
.
size
(
)
>
0
)
{
for
(
e
=
references
.
elements
(
)
;
e
.
hasMoreElements
(
)
;
)
{
Reference
ref
=
(
Reference
)
e
.
nextElement
(
)
;
String
refid
=
ref
.
getRefId
(
)
;
if
(
refid
==
null
)
{
throw
new
BuildException
(
"the refid attribute is required"
+
" for reference elements"
)
;
}
if
(
!
thisReferences
.
containsKey
(
refid
)
)
{
log
(
"Parent project doesn't contain any reference '"
+
refid
+
"'"
,
Project
.
MSG_WARN
)
;
continue
;
}
thisReferences
.
remove
(
refid
)
;
String
toRefid
=
ref
.
getToRefid
(
)
;
if
(
toRefid
==
null
)
{
toRefid
=
refid
;
}
copyReference
(
refid
,
toRefid
)
;
}
}
if
(
inheritRefs
)
{
for
(
e
=
thisReferences
.
keys
(
)
;
e
.
hasMoreElements
(
)
;
)
{
String
key
=
(
String
)
e
.
nextElement
(
)
;
if
(
newReferences
.
containsKey
(
key
)
)
{
continue
;
}
copyReference
(
key
,
key
)
;
}
}
}
private
void
copyReference
(
String
oldKey
,
String
newKey
)
{
Object
orig
=
project
.
getReference
(
oldKey
)
;
Class
c
=
orig
.
getClass
(
)
;
Object
copy
=
orig
;
try
{
Method
cloneM
=
c
.
getMethod
(
"clone"
,
new
Class
[
0
]
)
;
if
(
cloneM
!=
null
)
{
copy
=
cloneM
.
invoke
(
orig
,
new
Object
[
0
]
)
;
}
}
catch
(
Exception
e
)
{
}
if
(
copy
instanceof
ProjectComponent
)
{
(
(
ProjectComponent
)
copy
)
.
setProject
(
newProject
)
;
}
else
{
try
{
Method
setProjectM
=
c
.
getMethod
(
"setProject"
,
new
Class
[
]
{
Project
.
class
}
)
;
if
(
setProjectM
!=
null
)
{
setProjectM
.
invoke
(
copy
,
new
Object
[
]
{
newProject
}
)
;
}
}
catch
(
NoSuchMethodException
e
)
{
}
catch
(
Exception
e2
)
{
String
msg
=
"Error setting new project instance for "
+
"reference with id "
+
oldKey
;
throw
new
BuildException
(
msg
,
e2
,
location
)
;
}
}
newProject
.
addReference
(
newKey
,
copy
)
;
}
public
void
setDir
(
File
d
)
{
this
.
dir
=
d
;
}
public
void
setAntfile
(
String
s
)
{
this
.
antFile
=
s
;
}
public
void
setTarget
(
String
s
)
{
this
.
target
=
s
;
}
public
void
setOutput
(
String
s
)
{
this
.
output
=
s
;
}
public
Property
createProperty
(
)
{
if
(
newProject
==
null
)
{
reinit
(
)
;
}
Property
p
=
new
Property
(
true
,
getProject
(
)
)
;
p
.
setProject
(
newProject
)
;
p
.
setTaskName
(
"property"
)
;
properties
.
addElement
(
p
)
;
return
p
;
}
public
void
addReference
(
Reference
r
)
{
references
.
addElement
(
r
)
;
}
public
static
class
Reference
extends
org
.
apache
.
tools
.
ant
.
types
.
Reference
{
public
Reference
(
)
{
super
(
)
;
}
private
String
targetid
=
null
;
public
void
setToRefid
(
String
targetid
)
{
this
.
targetid
=
targetid
;
}
public
String
getToRefid
(
)
{
return
targetid
;
}
}
}
