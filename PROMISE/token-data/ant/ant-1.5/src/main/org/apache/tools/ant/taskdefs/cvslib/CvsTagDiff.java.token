package
org
.
apache
.
tools
.
ant
.
taskdefs
.
cvslib
;
import
org
.
apache
.
tools
.
ant
.
BuildException
;
import
org
.
apache
.
tools
.
ant
.
Project
;
import
org
.
apache
.
tools
.
ant
.
Task
;
import
org
.
apache
.
tools
.
ant
.
taskdefs
.
Cvs
;
import
org
.
apache
.
tools
.
ant
.
util
.
FileUtils
;
import
java
.
io
.
BufferedReader
;
import
java
.
io
.
File
;
import
java
.
io
.
FileOutputStream
;
import
java
.
io
.
FileReader
;
import
java
.
io
.
IOException
;
import
java
.
io
.
OutputStreamWriter
;
import
java
.
io
.
PrintWriter
;
import
java
.
io
.
UnsupportedEncodingException
;
import
java
.
util
.
Vector
;
public
class
CvsTagDiff
extends
Task
{
static
final
String
FILE_IS_NEW
=
" is new; current revision "
;
static
final
String
FILE_HAS_CHANGED
=
" changed from revision "
;
static
final
String
FILE_WAS_REMOVED
=
" is removed"
;
private
Cvs
m_cvs
;
private
String
m_package
;
private
String
m_startTag
;
private
String
m_endTag
;
private
String
m_startDate
;
private
String
m_endDate
;
private
File
m_destfile
;
private
FileUtils
m_fileUtils
=
FileUtils
.
newFileUtils
(
)
;
public
void
init
(
)
throws
BuildException
{
m_cvs
=
(
Cvs
)
getProject
(
)
.
createTask
(
"cvs"
)
;
}
public
void
setCompressionLevel
(
int
level
)
{
m_cvs
.
setCompressionLevel
(
level
)
;
}
public
void
setCompression
(
boolean
usecomp
)
{
m_cvs
.
setCompression
(
usecomp
)
;
}
public
void
setCvsRoot
(
String
cvsRoot
)
{
m_cvs
.
setCvsRoot
(
cvsRoot
)
;
}
public
void
setCvsRsh
(
String
rsh
)
{
m_cvs
.
setCvsRsh
(
rsh
)
;
}
public
void
setPackage
(
String
p
)
{
m_package
=
p
;
}
public
void
setQuiet
(
boolean
quiet
)
{
m_cvs
.
setQuiet
(
quiet
)
;
}
public
void
setPort
(
int
port
)
{
m_cvs
.
setPort
(
port
)
;
}
public
void
setPassfile
(
File
f
)
{
m_cvs
.
setPassfile
(
f
)
;
}
public
void
setFailOnError
(
boolean
b
)
{
m_cvs
.
setFailOnError
(
b
)
;
}
public
void
setStartTag
(
String
s
)
{
m_startTag
=
s
;
}
public
void
setStartDate
(
String
s
)
{
m_startDate
=
s
;
}
public
void
setEndTag
(
String
s
)
{
m_endTag
=
s
;
}
public
void
setEndDate
(
String
s
)
{
m_endDate
=
s
;
}
public
void
setDestFile
(
File
f
)
{
m_destfile
=
f
;
}
public
void
execute
(
)
throws
BuildException
{
validate
(
)
;
String
rdiff
=
"rdiff -s "
+
(
m_startTag
!=
null
?
(
"-r "
+
m_startTag
)
:
(
"-D "
+
m_startDate
)
)
+
" "
+
(
m_endTag
!=
null
?
(
"-r "
+
m_endTag
)
:
(
"-D "
+
m_endDate
)
)
+
" "
+
m_package
;
log
(
"Cvs command is "
+
rdiff
,
Project
.
MSG_VERBOSE
)
;
m_cvs
.
setCommand
(
rdiff
)
;
File
tmpFile
=
null
;
try
{
tmpFile
=
m_fileUtils
.
createTempFile
(
"cvstagdiff"
,
".log"
,
null
)
;
m_cvs
.
setOutput
(
tmpFile
)
;
m_cvs
.
execute
(
)
;
CvsTagEntry
[
]
entries
=
parseRDiff
(
tmpFile
)
;
writeTagDiff
(
entries
)
;
}
finally
{
if
(
tmpFile
!=
null
)
{
tmpFile
.
delete
(
)
;
}
}
}
private
CvsTagEntry
[
]
parseRDiff
(
File
tmpFile
)
throws
BuildException
{
BufferedReader
reader
=
null
;
try
{
reader
=
new
BufferedReader
(
new
FileReader
(
tmpFile
)
)
;
int
headerLength
=
5
+
m_package
.
length
(
)
+
1
;
Vector
entries
=
new
Vector
(
)
;
String
line
=
reader
.
readLine
(
)
;
int
index
;
CvsTagEntry
entry
=
null
;
while
(
null
!=
line
)
{
line
=
line
.
substring
(
headerLength
)
;
if
(
(
index
=
line
.
indexOf
(
FILE_IS_NEW
)
)
!=
-
1
)
{
String
filename
=
line
.
substring
(
0
,
index
)
;
String
rev
=
line
.
substring
(
index
+
FILE_IS_NEW
.
length
(
)
)
;
entries
.
addElement
(
entry
=
new
CvsTagEntry
(
filename
,
rev
)
)
;
log
(
entry
.
toString
(
)
,
Project
.
MSG_VERBOSE
)
;
}
else
if
(
(
index
=
line
.
indexOf
(
FILE_HAS_CHANGED
)
)
!=
-
1
)
{
String
filename
=
line
.
substring
(
0
,
index
)
;
int
revSeparator
=
line
.
indexOf
(
" to "
,
index
)
;
String
prevRevision
=
line
.
substring
(
index
+
FILE_HAS_CHANGED
.
length
(
)
,
revSeparator
)
;
String
revision
=
line
.
substring
(
revSeparator
+
4
)
;
entries
.
addElement
(
entry
=
new
CvsTagEntry
(
filename
,
revision
,
prevRevision
)
)
;
log
(
entry
.
toString
(
)
,
Project
.
MSG_VERBOSE
)
;
}
else
if
(
(
index
=
line
.
indexOf
(
FILE_WAS_REMOVED
)
)
!=
-
1
)
{
String
filename
=
line
.
substring
(
0
,
index
)
;
entries
.
addElement
(
entry
=
new
CvsTagEntry
(
filename
)
)
;
log
(
entry
.
toString
(
)
,
Project
.
MSG_VERBOSE
)
;
}
line
=
reader
.
readLine
(
)
;
}
CvsTagEntry
[
]
array
=
new
CvsTagEntry
[
entries
.
size
(
)
]
;
entries
.
copyInto
(
array
)
;
return
array
;
}
catch
(
IOException
e
)
{
throw
new
BuildException
(
"Error in parsing"
,
e
)
;
}
finally
{
if
(
reader
!=
null
)
{
try
{
reader
.
close
(
)
;
}
catch
(
IOException
e
)
{
}
}
}
}
private
void
writeTagDiff
(
CvsTagEntry
[
]
entries
)
throws
BuildException
{
FileOutputStream
output
=
null
;
try
{
output
=
new
FileOutputStream
(
m_destfile
)
;
PrintWriter
writer
=
new
PrintWriter
(
new
OutputStreamWriter
(
output
,
"UTF-8"
)
)
;
writer
.
println
(
"<?xml version=\"1.0\" encoding=\"UTF-8\"?>"
)
;
writer
.
print
(
"<tagdiff "
)
;
if
(
m_startTag
!=
null
)
{
writer
.
print
(
"startTag=\""
+
m_startTag
+
"\" "
)
;
}
else
{
writer
.
print
(
"startDate=\""
+
m_startDate
+
"\" "
)
;
}
if
(
m_endTag
!=
null
)
{
writer
.
print
(
"endTag=\""
+
m_endTag
+
"\" "
)
;
}
else
{
writer
.
print
(
"endDate=\""
+
m_endDate
+
"\" "
)
;
}
writer
.
println
(
">"
)
;
for
(
int
i
=
0
,
c
=
entries
.
length
;
i
<
c
;
i
++
)
{
writeTagEntry
(
writer
,
entries
[
i
]
)
;
}
writer
.
println
(
"</tagdiff>"
)
;
writer
.
flush
(
)
;
writer
.
close
(
)
;
}
catch
(
UnsupportedEncodingException
uee
)
{
log
(
uee
.
toString
(
)
,
Project
.
MSG_ERR
)
;
}
catch
(
IOException
ioe
)
{
throw
new
BuildException
(
ioe
.
toString
(
)
,
ioe
)
;
}
finally
{
if
(
null
!=
output
)
{
try
{
output
.
close
(
)
;
}
catch
(
IOException
ioe
)
{
}
}
}
}
private
void
writeTagEntry
(
PrintWriter
writer
,
CvsTagEntry
entry
)
{
writer
.
println
(
"\t<entry>"
)
;
writer
.
println
(
"\t\t<file>"
)
;
writer
.
println
(
"\t\t\t<name>"
+
entry
.
getFile
(
)
+
"</name>"
)
;
if
(
entry
.
getRevision
(
)
!=
null
)
{
writer
.
println
(
"\t\t\t<revision>"
+
entry
.
getRevision
(
)
+
"</revision>"
)
;
}
if
(
entry
.
getPreviousRevision
(
)
!=
null
)
{
writer
.
println
(
"\t\t\t<prevrevision>"
+
entry
.
getPreviousRevision
(
)
+
"</prevrevision>"
)
;
}
writer
.
println
(
"\t\t</file>"
)
;
writer
.
println
(
"\t</entry>"
)
;
}
private
void
validate
(
)
throws
BuildException
{
if
(
null
==
m_package
)
{
throw
new
BuildException
(
"Package/module must be set."
)
;
}
if
(
null
==
m_destfile
)
{
throw
new
BuildException
(
"Destfile must be set."
)
;
}
if
(
null
==
m_startTag
&&
null
==
m_startDate
)
{
throw
new
BuildException
(
"Start tag or start date must be set."
)
;
}
if
(
null
!=
m_startTag
&&
null
!=
m_startDate
)
{
throw
new
BuildException
(
"Only one of start tag and start date "
+
"must be set."
)
;
}
if
(
null
==
m_endTag
&&
null
==
m_endDate
)
{
throw
new
BuildException
(
"End tag or end date must be set."
)
;
}
if
(
null
!=
m_endTag
&&
null
!=
m_endDate
)
{
throw
new
BuildException
(
"Only one of end tag and end date must "
+
"be set."
)
;
}
}
}
