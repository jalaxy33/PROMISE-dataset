package
org
.
gjt
.
sp
.
jedit
;
import
javax
.
swing
.
SwingUtilities
;
import
java
.
io
.
*
;
import
java
.
net
.
*
;
import
java
.
util
.
Random
;
import
org
.
gjt
.
sp
.
jedit
.
io
.
FileVFS
;
import
org
.
gjt
.
sp
.
util
.
Log
;
public
class
EditServer
extends
Thread
{
EditServer
(
String
portFile
)
{
super
(
"jEdit server daemon ["
+
portFile
+
"]"
)
;
setDaemon
(
true
)
;
this
.
portFile
=
portFile
;
try
{
if
(
OperatingSystem
.
isUnix
(
)
)
{
new
File
(
portFile
)
.
createNewFile
(
)
;
FileVFS
.
setPermissions
(
portFile
,
0600
)
;
}
socket
=
new
ServerSocket
(
0
,
2
,
InetAddress
.
getByName
(
"127.0.0.1"
)
)
;
authKey
=
Math
.
abs
(
new
Random
(
)
.
nextInt
(
)
)
;
int
port
=
socket
.
getLocalPort
(
)
;
FileWriter
out
=
new
FileWriter
(
portFile
)
;
out
.
write
(
"b\n"
)
;
out
.
write
(
String
.
valueOf
(
port
)
)
;
out
.
write
(
"\n"
)
;
out
.
write
(
String
.
valueOf
(
authKey
)
)
;
out
.
write
(
"\n"
)
;
out
.
close
(
)
;
Log
.
log
(
Log
.
DEBUG
,
this
,
"jEdit server started on port "
+
socket
.
getLocalPort
(
)
)
;
Log
.
log
(
Log
.
DEBUG
,
this
,
"Authorization key is "
+
authKey
)
;
ok
=
true
;
}
catch
(
IOException
io
)
{
Log
.
log
(
Log
.
NOTICE
,
this
,
io
)
;
}
}
public
boolean
isOK
(
)
{
return
ok
;
}
public
void
run
(
)
{
boolean
abort
=
false
;
for
(
;
;
)
{
if
(
abort
)
return
;
Socket
client
=
null
;
try
{
client
=
socket
.
accept
(
)
;
client
.
setSoTimeout
(
1000
)
;
Log
.
log
(
Log
.
MESSAGE
,
this
,
client
+
": connected"
)
;
DataInputStream
in
=
new
DataInputStream
(
client
.
getInputStream
(
)
)
;
if
(
!
handleClient
(
client
,
in
)
)
abort
=
true
;
}
catch
(
Exception
e
)
{
Log
.
log
(
Log
.
ERROR
,
this
,
e
)
;
abort
=
true
;
}
finally
{
if
(
client
!=
null
)
{
try
{
client
.
close
(
)
;
}
catch
(
Exception
e
)
{
Log
.
log
(
Log
.
ERROR
,
this
,
e
)
;
}
client
=
null
;
}
}
}
}
public
static
void
handleClient
(
boolean
restore
,
String
parent
,
String
[
]
args
)
{
String
splitConfig
=
null
;
boolean
newView
=
jEdit
.
getBooleanProperty
(
"client.newView"
)
;
if
(
jEdit
.
getFirstView
(
)
==
null
||
newView
)
{
Buffer
buffer
=
jEdit
.
openFiles
(
null
,
parent
,
args
)
;
if
(
restore
)
{
if
(
jEdit
.
getFirstBuffer
(
)
==
null
||
(
jEdit
.
getFirstBuffer
(
)
.
isUntitled
(
)
&&
jEdit
.
getBufferCount
(
)
==
1
)
)
splitConfig
=
jEdit
.
restoreOpenFiles
(
)
;
else
if
(
jEdit
.
getBooleanProperty
(
"restore.cli"
)
)
{
jEdit
.
restoreOpenFiles
(
)
;
}
}
if
(
jEdit
.
getFirstBuffer
(
)
==
null
||
(
jEdit
.
getFirstBuffer
(
)
.
isUntitled
(
)
&&
jEdit
.
getBufferCount
(
)
==
1
)
)
buffer
=
jEdit
.
newFile
(
null
)
;
if
(
splitConfig
!=
null
)
jEdit
.
newView
(
null
,
splitConfig
)
;
else
jEdit
.
newView
(
null
,
buffer
)
;
}
else
{
View
view
=
jEdit
.
getFirstView
(
)
;
jEdit
.
openFiles
(
view
,
parent
,
args
)
;
view
.
setState
(
java
.
awt
.
Frame
.
NORMAL
)
;
view
.
requestFocus
(
)
;
view
.
toFront
(
)
;
return
;
}
}
void
stopServer
(
)
{
stop
(
)
;
new
File
(
portFile
)
.
delete
(
)
;
}
private
String
portFile
;
private
ServerSocket
socket
;
private
int
authKey
;
private
boolean
ok
;
private
boolean
handleClient
(
Socket
client
,
DataInputStream
in
)
throws
Exception
{
int
key
=
in
.
readInt
(
)
;
if
(
key
!=
authKey
)
{
Log
.
log
(
Log
.
ERROR
,
this
,
client
+
": wrong"
+
" authorization key (got "
+
key
+
", expected "
+
authKey
+
")"
)
;
in
.
close
(
)
;
client
.
close
(
)
;
return
false
;
}
else
{
client
.
setSoTimeout
(
0
)
;
Log
.
log
(
Log
.
DEBUG
,
this
,
client
+
": authenticated"
+
" successfully"
)
;
final
String
script
=
in
.
readUTF
(
)
;
Log
.
log
(
Log
.
DEBUG
,
this
,
script
)
;
SwingUtilities
.
invokeLater
(
new
Runnable
(
)
{
public
void
run
(
)
{
BeanShell
.
eval
(
null
,
BeanShell
.
getNameSpace
(
)
,
script
)
;
}
}
)
;
return
true
;
}
}
}
