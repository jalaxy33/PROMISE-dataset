package
org
.
gjt
.
sp
.
jedit
;
import
bsh
.
*
;
import
javax
.
swing
.
text
.
BadLocationException
;
import
javax
.
swing
.
text
.
Segment
;
import
javax
.
swing
.
JFileChooser
;
import
java
.
lang
.
reflect
.
InvocationTargetException
;
import
java
.
io
.
*
;
import
org
.
gjt
.
sp
.
jedit
.
io
.
*
;
import
org
.
gjt
.
sp
.
jedit
.
gui
.
BeanShellErrorDialog
;
import
org
.
gjt
.
sp
.
jedit
.
textarea
.
JEditTextArea
;
import
org
.
gjt
.
sp
.
util
.
Log
;
public
class
BeanShell
{
public
static
void
evalSelection
(
View
view
,
JEditTextArea
textArea
)
{
String
command
=
textArea
.
getSelectedText
(
)
;
if
(
command
==
null
)
{
view
.
getToolkit
(
)
.
beep
(
)
;
return
;
}
Object
returnValue
=
eval
(
view
,
command
,
false
)
;
if
(
returnValue
!=
null
)
textArea
.
setSelectedText
(
returnValue
.
toString
(
)
)
;
}
public
static
void
showEvaluateDialog
(
View
view
)
{
String
command
=
GUIUtilities
.
input
(
view
,
"beanshell-eval-input"
,
null
)
;
if
(
command
!=
null
)
{
if
(
!
command
.
endsWith
(
";"
)
)
command
=
command
+
";"
;
int
repeat
=
view
.
getInputHandler
(
)
.
getRepeatCount
(
)
;
if
(
view
.
getMacroRecorder
(
)
!=
null
)
{
view
.
getMacroRecorder
(
)
.
record
(
repeat
,
command
)
;
}
Object
returnValue
=
null
;
try
{
for
(
int
i
=
0
;
i
<
repeat
;
i
++
)
{
returnValue
=
eval
(
view
,
command
,
true
)
;
}
}
catch
(
Error
t
)
{
}
if
(
returnValue
!=
null
)
{
String
[
]
args
=
{
returnValue
.
toString
(
)
}
;
GUIUtilities
.
message
(
view
,
"beanshell-eval"
,
args
)
;
}
}
}
public
static
void
showRunScriptDialog
(
View
view
)
{
String
[
]
paths
=
GUIUtilities
.
showVFSFileDialog
(
view
,
null
,
JFileChooser
.
OPEN_DIALOG
,
true
)
;
if
(
paths
!=
null
)
{
Buffer
buffer
=
view
.
getBuffer
(
)
;
try
{
buffer
.
beginCompoundEdit
(
)
;
for
(
int
i
=
0
;
i
<
paths
.
length
;
i
++
)
runScript
(
view
,
paths
[
i
]
,
true
,
false
)
;
}
finally
{
buffer
.
endCompoundEdit
(
)
;
}
}
}
public
static
void
runScript
(
View
view
,
String
path
,
boolean
ownNamespace
,
boolean
rethrowBshErrors
)
{
Reader
in
;
Buffer
buffer
=
jEdit
.
getBuffer
(
path
)
;
VFS
vfs
=
VFSManager
.
getVFSForPath
(
path
)
;
Object
session
=
vfs
.
createVFSSession
(
path
,
view
)
;
if
(
session
==
null
)
{
return
;
}
try
{
if
(
buffer
!=
null
&&
buffer
.
isLoaded
(
)
)
{
StringBuffer
buf
=
new
StringBuffer
(
)
;
try
{
buf
.
append
(
buffer
.
getText
(
0
,
buffer
.
getLength
(
)
)
)
;
}
catch
(
BadLocationException
e
)
{
throw
new
InternalError
(
)
;
}
buf
.
append
(
"\n"
)
;
in
=
new
StringReader
(
buf
.
toString
(
)
)
;
}
else
{
in
=
new
BufferedReader
(
new
InputStreamReader
(
vfs
.
_createInputStream
(
session
,
path
,
true
,
view
)
)
)
;
}
runScript
(
view
,
path
,
in
,
ownNamespace
,
rethrowBshErrors
)
;
}
catch
(
IOException
e
)
{
Log
.
log
(
Log
.
ERROR
,
BeanShell
.
class
,
e
)
;
GUIUtilities
.
error
(
view
,
"read-error"
,
new
String
[
]
{
path
,
e
.
toString
(
)
}
)
;
return
;
}
finally
{
try
{
vfs
.
_endVFSSession
(
session
,
view
)
;
}
catch
(
IOException
io
)
{
Log
.
log
(
Log
.
ERROR
,
BeanShell
.
class
,
io
)
;
GUIUtilities
.
error
(
view
,
"read-error"
,
new
String
[
]
{
path
,
io
.
toString
(
)
}
)
;
}
}
}
public
static
void
runScript
(
View
view
,
String
path
,
Reader
in
,
boolean
ownNamespace
,
boolean
rethrowBshErrors
)
{
Log
.
log
(
Log
.
MESSAGE
,
BeanShell
.
class
,
"Running script "
+
path
)
;
NameSpace
namespace
;
if
(
ownNamespace
)
namespace
=
new
NameSpace
(
global
,
"script namespace"
)
;
else
namespace
=
global
;
Interpreter
interp
=
createInterpreter
(
namespace
)
;
try
{
if
(
view
!=
null
)
{
EditPane
editPane
=
view
.
getEditPane
(
)
;
interp
.
set
(
"view"
,
view
)
;
interp
.
set
(
"editPane"
,
editPane
)
;
interp
.
set
(
"buffer"
,
editPane
.
getBuffer
(
)
)
;
interp
.
set
(
"textArea"
,
editPane
.
getTextArea
(
)
)
;
}
running
=
true
;
interp
.
eval
(
in
,
namespace
,
path
)
;
}
catch
(
Throwable
e
)
{
if
(
e
instanceof
TargetError
)
e
=
(
(
TargetError
)
e
)
.
getTarget
(
)
;
if
(
e
instanceof
InvocationTargetException
)
e
=
(
(
InvocationTargetException
)
e
)
.
getTargetException
(
)
;
Log
.
log
(
Log
.
ERROR
,
BeanShell
.
class
,
e
)
;
new
BeanShellErrorDialog
(
view
,
e
.
toString
(
)
)
;
if
(
e
instanceof
Error
&&
rethrowBshErrors
)
throw
(
Error
)
e
;
}
finally
{
running
=
false
;
}
}
public
static
Object
eval
(
View
view
,
String
command
,
boolean
rethrowBshErrors
)
{
return
eval
(
view
,
global
,
command
,
rethrowBshErrors
)
;
}
public
static
Object
eval
(
View
view
,
NameSpace
namespace
,
String
command
,
boolean
rethrowBshErrors
)
{
Interpreter
interp
=
createInterpreter
(
namespace
)
;
try
{
if
(
view
!=
null
)
{
EditPane
editPane
=
view
.
getEditPane
(
)
;
interp
.
set
(
"view"
,
view
)
;
interp
.
set
(
"editPane"
,
editPane
)
;
interp
.
set
(
"buffer"
,
editPane
.
getBuffer
(
)
)
;
interp
.
set
(
"textArea"
,
editPane
.
getTextArea
(
)
)
;
}
return
interp
.
eval
(
command
)
;
}
catch
(
Throwable
e
)
{
if
(
e
instanceof
TargetError
)
e
=
(
(
TargetError
)
e
)
.
getTarget
(
)
;
if
(
e
instanceof
InvocationTargetException
)
e
=
(
(
InvocationTargetException
)
e
)
.
getTargetException
(
)
;
Log
.
log
(
Log
.
ERROR
,
BeanShell
.
class
,
e
)
;
new
BeanShellErrorDialog
(
view
,
e
.
toString
(
)
)
;
if
(
e
instanceof
Error
&&
rethrowBshErrors
)
throw
(
Error
)
e
;
}
return
null
;
}
public
static
String
cacheBlock
(
String
id
,
String
code
,
boolean
childNamespace
)
{
String
name
;
if
(
id
==
null
)
name
=
"b_"
+
(
cachedBlockCounter
++
)
;
else
name
=
"b_"
+
id
;
code
=
"setNameSpace(__cruft.namespace);\n"
+
name
+
"(ns) {\n"
+
"setNameSpace(ns);"
+
code
+
"\n}"
;
eval
(
null
,
code
,
false
)
;
return
name
;
}
public
static
Object
runCachedBlock
(
String
id
,
View
view
,
NameSpace
namespace
)
{
if
(
namespace
==
null
)
namespace
=
internal
;
Object
[
]
args
=
{
namespace
}
;
try
{
if
(
view
!=
null
)
{
namespace
.
setVariable
(
"view"
,
view
)
;
EditPane
editPane
=
view
.
getEditPane
(
)
;
namespace
.
setVariable
(
"editPane"
,
editPane
)
;
namespace
.
setVariable
(
"buffer"
,
editPane
.
getBuffer
(
)
)
;
namespace
.
setVariable
(
"textArea"
,
editPane
.
getTextArea
(
)
)
;
}
Object
retVal
=
internal
.
invokeMethod
(
id
,
args
,
interpForMethods
)
;
if
(
retVal
instanceof
Primitive
)
{
if
(
retVal
==
Primitive
.
VOID
)
return
null
;
else
return
(
(
Primitive
)
retVal
)
.
getValue
(
)
;
}
else
return
retVal
;
}
catch
(
Throwable
e
)
{
if
(
e
instanceof
TargetError
)
e
=
(
(
TargetError
)
e
)
.
getTarget
(
)
;
if
(
e
instanceof
InvocationTargetException
)
e
=
(
(
InvocationTargetException
)
e
)
.
getTargetException
(
)
;
Log
.
log
(
Log
.
ERROR
,
BeanShell
.
class
,
e
)
;
new
BeanShellErrorDialog
(
view
,
e
.
toString
(
)
)
;
}
finally
{
try
{
namespace
.
setVariable
(
"view"
,
null
)
;
namespace
.
setVariable
(
"editPane"
,
null
)
;
namespace
.
setVariable
(
"buffer"
,
null
)
;
namespace
.
setVariable
(
"textArea"
,
null
)
;
}
catch
(
EvalError
e
)
{
}
}
return
null
;
}
public
static
boolean
isScriptRunning
(
)
{
return
running
;
}
public
static
NameSpace
getNameSpace
(
)
{
return
global
;
}
static
void
init
(
)
{
Log
.
log
(
Log
.
DEBUG
,
BeanShell
.
class
,
"Initializing BeanShell"
+
" interpreter"
)
;
BshClassManager
.
setClassLoader
(
new
JARClassLoader
(
)
)
;
global
=
new
NameSpace
(
"jEdit embedded BeanShell Interpreter"
)
;
interpForMethods
=
createInterpreter
(
global
)
;
try
{
Interpreter
interp
=
createInterpreter
(
global
)
;
BufferedReader
in
=
new
BufferedReader
(
new
InputStreamReader
(
BeanShell
.
class
.
getResourceAsStream
(
"jedit.bsh"
)
)
)
;
interp
.
eval
(
in
,
global
,
"jedit.bsh"
)
;
}
catch
(
Throwable
t
)
{
Log
.
log
(
Log
.
ERROR
,
BeanShell
.
class
,
t
)
;
System
.
exit
(
1
)
;
}
internal
=
(
NameSpace
)
eval
(
null
,
"__cruft.namespace;"
,
false
)
;
}
private
static
Interpreter
interpForMethods
;
private
static
NameSpace
global
;
private
static
NameSpace
internal
;
private
static
boolean
running
;
private
static
int
cachedBlockCounter
;
private
static
Interpreter
createInterpreter
(
NameSpace
nameSpace
)
{
return
new
Interpreter
(
null
,
System
.
out
,
System
.
err
,
false
,
nameSpace
)
;
}
}
