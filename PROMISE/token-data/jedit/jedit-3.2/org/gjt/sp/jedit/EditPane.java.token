package
org
.
gjt
.
sp
.
jedit
;
import
javax
.
swing
.
event
.
*
;
import
javax
.
swing
.
*
;
import
java
.
awt
.
*
;
import
org
.
gjt
.
sp
.
jedit
.
gui
.
*
;
import
org
.
gjt
.
sp
.
jedit
.
io
.
VFSManager
;
import
org
.
gjt
.
sp
.
jedit
.
msg
.
*
;
import
org
.
gjt
.
sp
.
jedit
.
syntax
.
*
;
import
org
.
gjt
.
sp
.
jedit
.
textarea
.
*
;
import
org
.
gjt
.
sp
.
util
.
Log
;
public
class
EditPane
extends
JPanel
implements
EBComponent
{
public
View
getView
(
)
{
return
view
;
}
public
Buffer
getBuffer
(
)
{
return
buffer
;
}
public
void
setBuffer
(
final
Buffer
buffer
)
{
if
(
this
.
buffer
==
buffer
)
return
;
if
(
buffer
.
isClosed
(
)
)
throw
new
InternalError
(
buffer
+
" has been closed"
)
;
buffer
.
endCompoundEdit
(
)
;
recentBuffer
=
this
.
buffer
;
if
(
recentBuffer
!=
null
)
saveCaretInfo
(
)
;
this
.
buffer
=
buffer
;
textArea
.
setBuffer
(
buffer
)
;
if
(
!
init
)
{
view
.
updateTitle
(
)
;
if
(
bufferSwitcher
!=
null
)
{
if
(
bufferSwitcher
.
getSelectedItem
(
)
!=
buffer
)
bufferSwitcher
.
setSelectedItem
(
buffer
)
;
}
EditBus
.
send
(
new
EditPaneUpdate
(
this
,
EditPaneUpdate
.
BUFFER_CHANGED
)
)
;
}
SwingUtilities
.
invokeLater
(
new
Runnable
(
)
{
public
void
run
(
)
{
if
(
view
.
getEditPane
(
)
==
EditPane
.
this
&&
(
bufferSwitcher
==
null
||
!
bufferSwitcher
.
isPopupVisible
(
)
)
)
{
focusOnTextArea
(
)
;
}
}
}
)
;
Runnable
runnable
=
new
Runnable
(
)
{
public
void
run
(
)
{
loadCaretInfo
(
)
;
buffer
.
checkModTime
(
view
)
;
}
}
;
if
(
buffer
.
isPerformingIO
(
)
)
VFSManager
.
runInAWTThread
(
runnable
)
;
else
runnable
.
run
(
)
;
}
public
void
prevBuffer
(
)
{
Buffer
buffer
=
this
.
buffer
.
getPrev
(
)
;
if
(
buffer
==
null
)
setBuffer
(
jEdit
.
getLastBuffer
(
)
)
;
else
setBuffer
(
buffer
)
;
}
public
void
nextBuffer
(
)
{
Buffer
buffer
=
this
.
buffer
.
getNext
(
)
;
if
(
buffer
==
null
)
setBuffer
(
jEdit
.
getFirstBuffer
(
)
)
;
else
setBuffer
(
buffer
)
;
}
public
void
recentBuffer
(
)
{
if
(
recentBuffer
!=
null
)
setBuffer
(
recentBuffer
)
;
else
getToolkit
(
)
.
beep
(
)
;
}
public
void
focusOnTextArea
(
)
{
textArea
.
grabFocus
(
)
;
}
public
JEditTextArea
getTextArea
(
)
{
return
textArea
;
}
public
void
saveCaretInfo
(
)
{
buffer
.
putProperty
(
Buffer
.
CARET
,
new
Integer
(
textArea
.
getCaretPosition
(
)
)
)
;
Selection
[
]
selection
=
textArea
.
getSelection
(
)
;
if
(
selection
!=
null
)
buffer
.
putProperty
(
Buffer
.
SELECTION
,
selection
)
;
buffer
.
putProperty
(
Buffer
.
SCROLL_VERT
,
new
Integer
(
textArea
.
getFirstLine
(
)
)
)
;
buffer
.
putProperty
(
Buffer
.
SCROLL_HORIZ
,
new
Integer
(
textArea
.
getHorizontalOffset
(
)
)
)
;
}
public
void
loadCaretInfo
(
)
{
Integer
caret
=
(
Integer
)
buffer
.
getProperty
(
Buffer
.
CARET
)
;
Selection
[
]
selection
=
(
Selection
[
]
)
buffer
.
getProperty
(
Buffer
.
SELECTION
)
;
Integer
firstLine
=
(
Integer
)
buffer
.
getProperty
(
Buffer
.
SCROLL_VERT
)
;
Integer
horizontalOffset
=
(
Integer
)
buffer
.
getProperty
(
Buffer
.
SCROLL_HORIZ
)
;
if
(
caret
!=
null
)
{
textArea
.
setCaretPosition
(
Math
.
min
(
caret
.
intValue
(
)
,
buffer
.
getLength
(
)
)
)
;
}
if
(
selection
!=
null
)
textArea
.
setSelection
(
selection
)
;
if
(
firstLine
!=
null
)
textArea
.
setFirstLine
(
firstLine
.
intValue
(
)
)
;
if
(
horizontalOffset
!=
null
)
textArea
.
setHorizontalOffset
(
horizontalOffset
.
intValue
(
)
)
;
}
public
void
handleMessage
(
EBMessage
msg
)
{
if
(
msg
instanceof
PropertiesChanged
)
{
propertiesChanged
(
)
;
loadBufferSwitcher
(
)
;
}
else
if
(
msg
instanceof
BufferUpdate
)
handleBufferUpdate
(
(
BufferUpdate
)
msg
)
;
}
public
final
Dimension
getMinimumSize
(
)
{
return
new
Dimension
(
0
,
0
)
;
}
EditPane
(
View
view
,
Buffer
buffer
)
{
super
(
new
BorderLayout
(
)
)
;
init
=
true
;
this
.
view
=
view
;
EditBus
.
addToBus
(
this
)
;
textArea
=
new
JEditTextArea
(
view
)
;
add
(
BorderLayout
.
CENTER
,
textArea
)
;
markerHighlight
=
new
MarkerHighlight
(
)
;
textArea
.
getGutter
(
)
.
addCustomHighlight
(
markerHighlight
)
;
propertiesChanged
(
)
;
if
(
buffer
==
null
)
setBuffer
(
jEdit
.
getFirstBuffer
(
)
)
;
else
setBuffer
(
buffer
)
;
loadBufferSwitcher
(
)
;
init
=
false
;
}
void
close
(
)
{
saveCaretInfo
(
)
;
EditBus
.
send
(
new
EditPaneUpdate
(
this
,
EditPaneUpdate
.
DESTROYED
)
)
;
EditBus
.
removeFromBus
(
this
)
;
}
private
boolean
init
;
private
View
view
;
private
Buffer
buffer
;
private
Buffer
recentBuffer
;
private
BufferSwitcher
bufferSwitcher
;
private
JEditTextArea
textArea
;
private
MarkerHighlight
markerHighlight
;
private
void
propertiesChanged
(
)
{
TextAreaPainter
painter
=
textArea
.
getPainter
(
)
;
painter
.
setFont
(
UIManager
.
getFont
(
"TextArea.font"
)
)
;
painter
.
setBracketHighlightEnabled
(
jEdit
.
getBooleanProperty
(
"view.bracketHighlight"
)
)
;
painter
.
setBracketHighlightColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.bracketHighlightColor"
)
)
)
;
painter
.
setEOLMarkersPainted
(
jEdit
.
getBooleanProperty
(
"view.eolMarkers"
)
)
;
painter
.
setEOLMarkerColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.eolMarkerColor"
)
)
)
;
painter
.
setWrapGuidePainted
(
jEdit
.
getBooleanProperty
(
"view.wrapGuide"
)
)
;
painter
.
setWrapGuideColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.wrapGuideColor"
)
)
)
;
painter
.
setCaretColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.caretColor"
)
)
)
;
painter
.
setSelectionColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.selectionColor"
)
)
)
;
painter
.
setBackground
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.bgColor"
)
)
)
;
painter
.
setForeground
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.fgColor"
)
)
)
;
painter
.
setBlockCaretEnabled
(
jEdit
.
getBooleanProperty
(
"view.blockCaret"
)
)
;
painter
.
setLineHighlightEnabled
(
jEdit
.
getBooleanProperty
(
"view.lineHighlight"
)
)
;
painter
.
setLineHighlightColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.lineHighlightColor"
)
)
)
;
painter
.
setAntiAliasEnabled
(
jEdit
.
getBooleanProperty
(
"view.antiAlias"
)
)
;
painter
.
setFractionalFontMetricsEnabled
(
jEdit
.
getBooleanProperty
(
"view.fracFontMetrics"
)
)
;
painter
.
setStyles
(
GUIUtilities
.
loadStyles
(
jEdit
.
getProperty
(
"view.font"
)
,
Integer
.
parseInt
(
jEdit
.
getProperty
(
"view.fontsize"
)
)
)
)
;
Gutter
gutter
=
textArea
.
getGutter
(
)
;
gutter
.
setExpanded
(
jEdit
.
getBooleanProperty
(
"view.gutter.lineNumbers"
)
)
;
try
{
int
interval
=
Integer
.
parseInt
(
jEdit
.
getProperty
(
"view.gutter.highlightInterval"
)
)
;
gutter
.
setHighlightInterval
(
interval
)
;
}
catch
(
NumberFormatException
nf
)
{
}
gutter
.
setCurrentLineHighlightEnabled
(
jEdit
.
getBooleanProperty
(
"view.gutter.highlightCurrentLine"
)
)
;
gutter
.
setBackground
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.bgColor"
)
)
)
;
gutter
.
setForeground
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.fgColor"
)
)
)
;
gutter
.
setHighlightedForeground
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.highlightColor"
)
)
)
;
gutter
.
setFoldColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.foldColor"
)
)
)
;
markerHighlight
.
setMarkerHighlightColor
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.markerColor"
)
)
)
;
markerHighlight
.
setHighlightEnabled
(
jEdit
.
getBooleanProperty
(
"view.gutter.markerHighlight"
)
)
;
gutter
.
setCurrentLineForeground
(
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.currentLineColor"
)
)
)
;
String
alignment
=
jEdit
.
getProperty
(
"view.gutter.numberAlignment"
)
;
if
(
"right"
.
equals
(
alignment
)
)
{
gutter
.
setLineNumberAlignment
(
Gutter
.
RIGHT
)
;
}
else
if
(
"center"
.
equals
(
alignment
)
)
{
gutter
.
setLineNumberAlignment
(
Gutter
.
CENTER
)
;
}
else
{
gutter
.
setLineNumberAlignment
(
Gutter
.
LEFT
)
;
}
try
{
String
fontname
=
jEdit
.
getProperty
(
"view.gutter.font"
)
;
int
fontsize
=
Integer
.
parseInt
(
jEdit
.
getProperty
(
"view.gutter.fontsize"
)
)
;
int
fontstyle
=
Integer
.
parseInt
(
jEdit
.
getProperty
(
"view.gutter.fontstyle"
)
)
;
gutter
.
setFont
(
new
Font
(
fontname
,
fontstyle
,
fontsize
)
)
;
}
catch
(
NumberFormatException
nf
)
{
}
try
{
int
width
=
Integer
.
parseInt
(
jEdit
.
getProperty
(
"view.gutter.borderWidth"
)
)
;
gutter
.
setBorder
(
width
,
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.focusBorderColor"
)
)
,
GUIUtilities
.
parseColor
(
jEdit
.
getProperty
(
"view.gutter.noFocusBorderColor"
)
)
,
textArea
.
getPainter
(
)
.
getBackground
(
)
)
;
}
catch
(
NumberFormatException
nf
)
{
}
textArea
.
setCaretBlinkEnabled
(
jEdit
.
getBooleanProperty
(
"view.caretBlink"
)
)
;
try
{
textArea
.
setElectricScroll
(
Integer
.
parseInt
(
jEdit
.
getProperty
(
"view.electricBorders"
)
)
)
;
}
catch
(
NumberFormatException
nf
)
{
textArea
.
setElectricScroll
(
0
)
;
}
textArea
.
setRightClickPopup
(
GUIUtilities
.
loadPopupMenu
(
"view.context"
)
)
;
textArea
.
setMiddleMousePasteEnabled
(
jEdit
.
getBooleanProperty
(
"view.middleMousePaste"
)
)
;
}
private
void
loadBufferSwitcher
(
)
{
if
(
jEdit
.
getBooleanProperty
(
"view.showBufferSwitcher"
)
)
{
if
(
bufferSwitcher
==
null
)
{
bufferSwitcher
=
new
BufferSwitcher
(
this
)
;
add
(
BorderLayout
.
NORTH
,
bufferSwitcher
)
;
bufferSwitcher
.
updateBufferList
(
)
;
revalidate
(
)
;
}
}
else
if
(
bufferSwitcher
!=
null
)
{
remove
(
bufferSwitcher
)
;
revalidate
(
)
;
bufferSwitcher
=
null
;
}
}
private
void
handleBufferUpdate
(
BufferUpdate
msg
)
{
Buffer
_buffer
=
msg
.
getBuffer
(
)
;
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
CREATED
)
{
if
(
bufferSwitcher
!=
null
)
bufferSwitcher
.
updateBufferList
(
)
;
if
(
buffer
.
isClosed
(
)
)
setBuffer
(
jEdit
.
getFirstBuffer
(
)
)
;
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
CLOSED
)
{
if
(
bufferSwitcher
!=
null
)
bufferSwitcher
.
updateBufferList
(
)
;
if
(
_buffer
==
buffer
)
{
Buffer
newBuffer
=
(
recentBuffer
!=
null
?
recentBuffer
:
_buffer
.
getPrev
(
)
)
;
if
(
newBuffer
!=
null
&&
!
newBuffer
.
isClosed
(
)
)
setBuffer
(
newBuffer
)
;
else
if
(
jEdit
.
getBufferCount
(
)
!=
0
)
setBuffer
(
jEdit
.
getFirstBuffer
(
)
)
;
recentBuffer
=
null
;
}
else
if
(
_buffer
==
recentBuffer
)
recentBuffer
=
null
;
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
LOAD_STARTED
)
{
if
(
_buffer
==
buffer
)
{
textArea
.
setCaretPosition
(
0
)
;
textArea
.
getPainter
(
)
.
repaint
(
)
;
}
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
DIRTY_CHANGED
)
{
if
(
_buffer
==
buffer
)
{
if
(
bufferSwitcher
!=
null
)
{
if
(
buffer
.
isDirty
(
)
)
bufferSwitcher
.
repaint
(
)
;
else
bufferSwitcher
.
updateBufferList
(
)
;
}
}
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
LOADED
)
{
if
(
_buffer
==
buffer
)
{
textArea
.
repaint
(
)
;
textArea
.
updateScrollBars
(
)
;
if
(
bufferSwitcher
!=
null
)
bufferSwitcher
.
updateBufferList
(
)
;
if
(
view
.
getEditPane
(
)
==
this
)
{
StatusBar
status
=
view
.
getStatus
(
)
;
status
.
repaintCaretStatus
(
)
;
status
.
updateBufferStatus
(
)
;
status
.
updateMiscStatus
(
)
;
}
loadCaretInfo
(
)
;
}
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
MARKERS_CHANGED
)
{
if
(
_buffer
==
buffer
)
textArea
.
getGutter
(
)
.
repaint
(
)
;
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
MODE_CHANGED
)
{
if
(
_buffer
==
buffer
)
{
textArea
.
getPainter
(
)
.
repaint
(
)
;
if
(
view
.
getEditPane
(
)
==
this
)
view
.
getStatus
(
)
.
updateBufferStatus
(
)
;
}
}
else
if
(
msg
.
getWhat
(
)
==
BufferUpdate
.
ENCODING_CHANGED
)
{
if
(
_buffer
==
buffer
)
{
if
(
view
.
getEditPane
(
)
==
this
)
view
.
getStatus
(
)
.
updateBufferStatus
(
)
;
}
}
}
}
