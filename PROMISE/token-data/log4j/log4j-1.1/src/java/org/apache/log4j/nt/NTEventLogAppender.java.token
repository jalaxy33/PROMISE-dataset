package
org
.
apache
.
log4j
.
nt
;
import
org
.
apache
.
log4j
.
*
;
import
org
.
apache
.
log4j
.
spi
.
LoggingEvent
;
import
org
.
apache
.
log4j
.
Priority
;
import
org
.
apache
.
log4j
.
helpers
.
OptionConverter
;
import
org
.
apache
.
log4j
.
helpers
.
LogLog
;
import
java
.
io
.
*
;
public
class
NTEventLogAppender
extends
AppenderSkeleton
{
private
int
_handle
=
0
;
public
static
final
String
SOURCE_OPTION
=
"Source"
;
private
String
source
=
null
;
private
String
server
=
null
;
private
static
final
int
FATAL
=
Priority
.
FATAL
.
toInt
(
)
;
private
static
final
int
ERROR
=
Priority
.
ERROR
.
toInt
(
)
;
private
static
final
int
WARN
=
Priority
.
WARN
.
toInt
(
)
;
private
static
final
int
INFO
=
Priority
.
INFO
.
toInt
(
)
;
private
static
final
int
DEBUG
=
Priority
.
DEBUG
.
toInt
(
)
;
public
NTEventLogAppender
(
)
{
this
(
null
,
null
,
null
)
;
}
public
NTEventLogAppender
(
String
source
)
{
this
(
null
,
source
,
null
)
;
}
public
NTEventLogAppender
(
String
server
,
String
source
)
{
this
(
server
,
source
,
null
)
;
}
public
NTEventLogAppender
(
Layout
layout
)
{
this
(
null
,
null
,
layout
)
;
}
public
NTEventLogAppender
(
String
source
,
Layout
layout
)
{
this
(
null
,
source
,
layout
)
;
}
public
NTEventLogAppender
(
String
server
,
String
source
,
Layout
layout
)
{
if
(
source
==
null
)
{
source
=
"Log4j"
;
}
if
(
layout
==
null
)
{
this
.
layout
=
new
TTCCLayout
(
)
;
}
else
{
this
.
layout
=
layout
;
}
try
{
_handle
=
registerEventSource
(
server
,
source
)
;
}
catch
(
Exception
e
)
{
e
.
printStackTrace
(
)
;
_handle
=
0
;
}
}
public
String
[
]
getOptionStrings
(
)
{
return
OptionConverter
.
concatanateArrays
(
super
.
getOptionStrings
(
)
,
new
String
[
]
{
SOURCE_OPTION
}
)
;
}
public
void
setOption
(
String
key
,
String
value
)
{
if
(
value
==
null
)
return
;
super
.
setOption
(
key
,
value
)
;
if
(
key
.
equalsIgnoreCase
(
SOURCE_OPTION
)
)
{
source
=
value
.
trim
(
)
;
}
}
public
void
close
(
)
{
}
public
void
activateOptions
(
)
{
if
(
source
!=
null
)
{
try
{
_handle
=
registerEventSource
(
server
,
source
)
;
}
catch
(
Exception
e
)
{
LogLog
.
error
(
"Could not register event source."
,
e
)
;
_handle
=
0
;
}
}
}
public
void
append
(
LoggingEvent
event
)
{
StringBuffer
sbuf
=
new
StringBuffer
(
)
;
sbuf
.
append
(
layout
.
format
(
event
)
)
;
if
(
layout
.
ignoresThrowable
(
)
)
{
String
[
]
s
=
event
.
getThrowableStrRep
(
)
;
if
(
s
!=
null
)
{
int
len
=
s
.
length
;
for
(
int
i
=
0
;
i
<
len
;
i
++
)
{
sbuf
.
append
(
s
[
i
]
)
;
}
}
}
int
nt_category
=
event
.
priority
.
toInt
(
)
;
reportEvent
(
_handle
,
sbuf
.
toString
(
)
,
nt_category
)
;
}
public
void
finalize
(
)
{
deregisterEventSource
(
_handle
)
;
_handle
=
0
;
}
public
void
setSource
(
String
source
)
{
this
.
source
=
source
.
trim
(
)
;
}
public
String
getSource
(
)
{
return
source
;
}
public
boolean
requiresLayout
(
)
{
return
true
;
}
native
private
int
registerEventSource
(
String
server
,
String
source
)
;
native
private
void
reportEvent
(
int
handle
,
String
message
,
int
priority
)
;
native
private
void
deregisterEventSource
(
int
handle
)
;
static
{
System
.
loadLibrary
(
"NTEventLogAppender"
)
;
}
}
