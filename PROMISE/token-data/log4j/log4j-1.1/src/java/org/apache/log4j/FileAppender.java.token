package
org
.
apache
.
log4j
;
import
java
.
io
.
IOException
;
import
java
.
io
.
Writer
;
import
java
.
io
.
FileWriter
;
import
java
.
io
.
OutputStream
;
import
java
.
io
.
OutputStreamWriter
;
import
org
.
apache
.
log4j
.
spi
.
ErrorHandler
;
import
org
.
apache
.
log4j
.
spi
.
ErrorCode
;
import
org
.
apache
.
log4j
.
spi
.
LoggingEvent
;
import
org
.
apache
.
log4j
.
helpers
.
OptionConverter
;
import
org
.
apache
.
log4j
.
helpers
.
QuietWriter
;
import
org
.
apache
.
log4j
.
helpers
.
LogLog
;
public
class
FileAppender
extends
WriterAppender
{
public
static
final
String
FILE_OPTION
=
"File"
;
public
static
final
String
APPEND_OPTION
=
"Append"
;
protected
boolean
fileAppend
=
true
;
protected
String
fileName
=
null
;
protected
boolean
qwIsOurs
=
false
;
public
FileAppender
(
)
{
}
public
FileAppender
(
Layout
layout
,
OutputStream
os
)
{
super
(
layout
,
os
)
;
}
public
FileAppender
(
Layout
layout
,
Writer
writer
)
{
super
(
layout
,
writer
)
;
}
public
FileAppender
(
Layout
layout
,
String
filename
,
boolean
append
)
throws
IOException
{
this
.
layout
=
layout
;
this
.
setFile
(
filename
,
append
)
;
}
public
FileAppender
(
Layout
layout
,
String
filename
)
throws
IOException
{
this
(
layout
,
filename
,
true
)
;
}
public
void
setFile
(
String
file
)
{
String
val
=
file
.
trim
(
)
;
if
(
val
.
equalsIgnoreCase
(
"System.out"
)
)
{
setWriter
(
new
OutputStreamWriter
(
System
.
out
)
)
;
}
else
if
(
val
.
equalsIgnoreCase
(
"System.err"
)
)
{
setWriter
(
new
OutputStreamWriter
(
System
.
err
)
)
;
}
else
{
fileName
=
val
;
}
}
public
boolean
getAppend
(
)
{
return
fileAppend
;
}
public
String
getFile
(
)
{
return
fileName
;
}
public
String
[
]
getOptionStrings
(
)
{
return
OptionConverter
.
concatanateArrays
(
super
.
getOptionStrings
(
)
,
new
String
[
]
{
FILE_OPTION
,
APPEND_OPTION
}
)
;
}
public
void
setAppend
(
boolean
flag
)
{
fileAppend
=
flag
;
}
public
void
activateOptions
(
)
{
if
(
fileName
!=
null
)
{
try
{
setFile
(
fileName
,
fileAppend
)
;
}
catch
(
java
.
io
.
IOException
e
)
{
errorHandler
.
error
(
"setFile("
+
fileName
+
","
+
fileAppend
+
") call failed."
,
e
,
ErrorCode
.
FILE_OPEN_FAILURE
)
;
}
}
else
{
LogLog
.
warn
(
"File option not set for appender ["
+
name
+
"]."
)
;
LogLog
.
warn
(
"Are you using FileAppender instead of ConsoleAppender?"
)
;
}
}
protected
void
closeFile
(
)
{
if
(
this
.
qw
!=
null
&&
this
.
qwIsOurs
)
{
try
{
this
.
qw
.
close
(
)
;
}
catch
(
java
.
io
.
IOException
e
)
{
LogLog
.
error
(
"Could not close "
+
qw
,
e
)
;
}
}
}
public
synchronized
void
setFile
(
String
fileName
,
boolean
append
)
throws
IOException
{
reset
(
)
;
this
.
setQWForFiles
(
new
FileWriter
(
fileName
,
append
)
)
;
this
.
fileName
=
fileName
;
this
.
fileAppend
=
append
;
this
.
qwIsOurs
=
true
;
writeHeader
(
)
;
}
public
void
setOption
(
String
key
,
String
value
)
{
if
(
value
==
null
)
return
;
super
.
setOption
(
key
,
value
)
;
if
(
key
.
equalsIgnoreCase
(
FILE_OPTION
)
)
{
String
val
=
value
.
trim
(
)
;
if
(
val
.
equalsIgnoreCase
(
"System.out"
)
)
{
setWriter
(
new
OutputStreamWriter
(
System
.
out
)
)
;
}
else
if
(
val
.
equalsIgnoreCase
(
"System.err"
)
)
{
setWriter
(
new
OutputStreamWriter
(
System
.
err
)
)
;
}
else
{
fileName
=
val
;
}
}
else
if
(
key
.
equalsIgnoreCase
(
APPEND_OPTION
)
)
{
fileAppend
=
OptionConverter
.
toBoolean
(
value
,
fileAppend
)
;
}
}
protected
void
setQWForFiles
(
Writer
writer
)
{
this
.
qw
=
new
QuietWriter
(
writer
,
errorHandler
)
;
}
protected
void
reset
(
)
{
closeFile
(
)
;
this
.
fileName
=
null
;
if
(
qwIsOurs
)
{
super
.
reset
(
)
;
}
else
{
this
.
qw
=
null
;
}
}
}
