package
org
.
apache
.
log4j
.
spi
;
import
org
.
apache
.
log4j
.
*
;
import
org
.
apache
.
log4j
.
helpers
.
LogLog
;
import
java
.
lang
.
reflect
.
Method
;
import
java
.
io
.
ObjectOutputStream
;
import
java
.
io
.
ObjectInputStream
;
import
java
.
util
.
Hashtable
;
public
class
LoggingEvent
implements
java
.
io
.
Serializable
{
private
static
long
startTime
=
System
.
currentTimeMillis
(
)
;
transient
public
final
String
fqnOfCategoryClass
;
transient
public
Category
logger
;
public
final
String
categoryName
;
transient
public
Priority
level
;
private
String
ndc
;
private
Hashtable
mdcCopy
;
private
boolean
ndcLookupRequired
=
true
;
private
boolean
mdcLookupRequired
=
true
;
transient
private
Object
message
;
private
String
renderedMessage
;
private
String
threadName
;
private
ThrowableInformation
throwableInfo
;
public
final
long
timeStamp
;
private
LocationInfo
locationInfo
;
static
final
long
serialVersionUID
=
-
868428216207166145L
;
static
final
Integer
[
]
PARAM_ARRAY
=
new
Integer
[
1
]
;
static
final
String
TO_LEVEL
=
"toLevel"
;
static
final
Class
[
]
TO_LEVEL_PARAMS
=
new
Class
[
]
{
int
.
class
}
;
static
final
Hashtable
methodCache
=
new
Hashtable
(
3
)
;
public
LoggingEvent
(
String
fqnOfCategoryClass
,
Category
logger
,
Priority
priority
,
Object
message
,
Throwable
throwable
)
{
this
.
fqnOfCategoryClass
=
fqnOfCategoryClass
;
this
.
logger
=
logger
;
this
.
categoryName
=
logger
.
getName
(
)
;
this
.
level
=
priority
;
this
.
message
=
message
;
if
(
throwable
!=
null
)
{
this
.
throwableInfo
=
new
ThrowableInformation
(
throwable
)
;
}
timeStamp
=
System
.
currentTimeMillis
(
)
;
}
public
LoggingEvent
(
String
fqnOfCategoryClass
,
Category
logger
,
long
timeStamp
,
Priority
priority
,
Object
message
,
Throwable
throwable
)
{
this
.
fqnOfCategoryClass
=
fqnOfCategoryClass
;
this
.
logger
=
logger
;
this
.
categoryName
=
logger
.
getName
(
)
;
this
.
level
=
priority
;
this
.
message
=
message
;
if
(
throwable
!=
null
)
{
this
.
throwableInfo
=
new
ThrowableInformation
(
throwable
)
;
}
this
.
timeStamp
=
timeStamp
;
}
public
LocationInfo
getLocationInformation
(
)
{
if
(
locationInfo
==
null
)
{
locationInfo
=
new
LocationInfo
(
new
Throwable
(
)
,
fqnOfCategoryClass
)
;
}
return
locationInfo
;
}
public
Object
getMessage
(
)
{
if
(
message
!=
null
)
{
return
message
;
}
else
{
return
getRenderedMessage
(
)
;
}
}
public
String
getNDC
(
)
{
if
(
ndcLookupRequired
)
{
ndcLookupRequired
=
false
;
ndc
=
NDC
.
get
(
)
;
}
return
ndc
;
}
public
Object
getMDC
(
String
key
)
{
Object
r
;
if
(
mdcCopy
!=
null
)
{
r
=
mdcCopy
.
get
(
key
)
;
if
(
r
!=
null
)
{
return
r
;
}
}
return
MDC
.
get
(
key
)
;
}
public
void
getMDCCopy
(
)
{
if
(
mdcLookupRequired
)
{
ndcLookupRequired
=
false
;
Hashtable
t
=
(
Hashtable
)
MDC
.
getContext
(
)
;
if
(
t
!=
null
)
{
mdcCopy
=
(
Hashtable
)
t
.
clone
(
)
;
}
}
}
public
String
getRenderedMessage
(
)
{
if
(
renderedMessage
==
null
&&
message
!=
null
)
{
if
(
message
instanceof
String
)
renderedMessage
=
(
String
)
message
;
else
{
LoggerRepository
repository
=
logger
.
getHierarchy
(
)
;
if
(
repository
instanceof
RendererSupport
)
{
RendererSupport
rs
=
(
RendererSupport
)
repository
;
renderedMessage
=
rs
.
getRendererMap
(
)
.
findAndRender
(
message
)
;
}
else
{
renderedMessage
=
message
.
toString
(
)
;
}
}
}
return
renderedMessage
;
}
public
static
long
getStartTime
(
)
{
return
startTime
;
}
public
String
getThreadName
(
)
{
if
(
threadName
==
null
)
threadName
=
(
Thread
.
currentThread
(
)
)
.
getName
(
)
;
return
threadName
;
}
public
ThrowableInformation
getThrowableInformation
(
)
{
return
throwableInfo
;
}
public
String
[
]
getThrowableStrRep
(
)
{
if
(
throwableInfo
==
null
)
return
null
;
else
return
throwableInfo
.
getThrowableStrRep
(
)
;
}
private
void
readLevel
(
ObjectInputStream
ois
)
throws
java
.
io
.
IOException
,
ClassNotFoundException
{
int
p
=
ois
.
readInt
(
)
;
try
{
String
className
=
(
String
)
ois
.
readObject
(
)
;
if
(
className
==
null
)
{
level
=
Level
.
toLevel
(
p
)
;
}
else
{
Method
m
=
(
Method
)
methodCache
.
get
(
className
)
;
if
(
m
==
null
)
{
Class
clazz
=
Class
.
forName
(
className
)
;
m
=
clazz
.
getDeclaredMethod
(
TO_LEVEL
,
TO_LEVEL_PARAMS
)
;
methodCache
.
put
(
className
,
m
)
;
}
PARAM_ARRAY
[
0
]
=
new
Integer
(
p
)
;
level
=
(
Level
)
m
.
invoke
(
null
,
PARAM_ARRAY
)
;
}
}
catch
(
Exception
e
)
{
LogLog
.
warn
(
"Level deserialization failed, reverting to default."
,
e
)
;
level
=
Level
.
toLevel
(
p
)
;
}
}
private
void
readObject
(
ObjectInputStream
ois
)
throws
java
.
io
.
IOException
,
ClassNotFoundException
{
ois
.
defaultReadObject
(
)
;
readLevel
(
ois
)
;
if
(
locationInfo
==
null
)
locationInfo
=
new
LocationInfo
(
null
,
null
)
;
}
private
void
writeObject
(
ObjectOutputStream
oos
)
throws
java
.
io
.
IOException
{
this
.
getThreadName
(
)
;
this
.
getRenderedMessage
(
)
;
this
.
getNDC
(
)
;
this
.
getMDCCopy
(
)
;
this
.
getThrowableStrRep
(
)
;
oos
.
defaultWriteObject
(
)
;
writeLevel
(
oos
)
;
}
private
void
writeLevel
(
ObjectOutputStream
oos
)
throws
java
.
io
.
IOException
{
oos
.
writeInt
(
level
.
toInt
(
)
)
;
Class
clazz
=
level
.
getClass
(
)
;
if
(
clazz
==
Level
.
class
)
{
oos
.
writeObject
(
null
)
;
}
else
{
oos
.
writeObject
(
clazz
.
getName
(
)
)
;
}
}
}
