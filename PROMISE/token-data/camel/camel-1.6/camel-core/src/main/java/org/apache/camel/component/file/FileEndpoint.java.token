package
org
.
apache
.
camel
.
component
.
file
;
import
java
.
io
.
File
;
import
java
.
io
.
IOException
;
import
java
.
lang
.
reflect
.
Method
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
Map
;
import
org
.
apache
.
camel
.
Consumer
;
import
org
.
apache
.
camel
.
ExchangePattern
;
import
org
.
apache
.
camel
.
Expression
;
import
org
.
apache
.
camel
.
Message
;
import
org
.
apache
.
camel
.
Processor
;
import
org
.
apache
.
camel
.
Producer
;
import
org
.
apache
.
camel
.
impl
.
ScheduledPollEndpoint
;
import
org
.
apache
.
camel
.
language
.
simple
.
FileLanguage
;
import
org
.
apache
.
camel
.
util
.
FactoryFinder
;
import
org
.
apache
.
camel
.
util
.
ObjectHelper
;
import
org
.
apache
.
camel
.
util
.
UuidGenerator
;
import
org
.
apache
.
commons
.
logging
.
Log
;
import
org
.
apache
.
commons
.
logging
.
LogFactory
;
public
class
FileEndpoint
extends
ScheduledPollEndpoint
<
FileExchange
>
{
public
static
final
transient
String
DEFAULT_LOCK_FILE_POSTFIX
=
".camelLock"
;
private
static
final
transient
Log
LOG
=
LogFactory
.
getLog
(
FileEndpoint
.
class
)
;
private
static
final
transient
String
DEFAULT_STRATEGYFACTORY_CLASS
=
"org.apache.camel.component.file.strategy.FileProcessStrategyFactory"
;
private
File
file
;
private
FileProcessStrategy
fileProcessStrategy
;
private
boolean
autoCreate
=
true
;
private
boolean
lock
=
true
;
private
boolean
delete
;
private
boolean
noop
;
private
boolean
append
=
true
;
private
String
moveNamePrefix
;
private
String
moveNamePostfix
;
private
String
[
]
excludedNamePrefixes
;
private
String
[
]
excludedNamePostfixes
;
private
String
preMoveNamePrefix
;
private
String
preMoveNamePostfix
;
private
String
excludedNamePrefix
;
private
String
excludedNamePostfix
;
private
int
bufferSize
=
128
*
1024
;
private
boolean
ignoreFileNameHeader
;
private
Expression
expression
;
private
Expression
preMoveExpression
;
protected
FileEndpoint
(
File
file
,
String
endpointUri
,
FileComponent
component
)
{
super
(
endpointUri
,
component
)
;
this
.
file
=
file
;
}
public
FileEndpoint
(
String
endpointUri
,
File
file
)
{
super
(
endpointUri
)
;
this
.
file
=
file
;
}
public
FileEndpoint
(
File
file
)
{
this
.
file
=
file
;
}
public
FileEndpoint
(
)
{
}
public
Producer
<
FileExchange
>
createProducer
(
)
throws
Exception
{
Producer
<
FileExchange
>
result
=
new
FileProducer
(
this
)
;
return
result
;
}
public
Consumer
<
FileExchange
>
createConsumer
(
Processor
processor
)
throws
Exception
{
Consumer
<
FileExchange
>
result
=
new
FileConsumer
(
this
,
processor
)
;
if
(
isDelete
(
)
&&
(
getMoveNamePrefix
(
)
!=
null
||
getMoveNamePostfix
(
)
!=
null
||
getExpression
(
)
!=
null
)
)
{
throw
new
IllegalArgumentException
(
"You cannot set delet and a moveNamePrefix, moveNamePostfix or expression option"
)
;
}
configureConsumer
(
result
)
;
return
result
;
}
public
FileExchange
createExchange
(
File
file
)
{
return
new
FileExchange
(
getCamelContext
(
)
,
getExchangePattern
(
)
,
file
)
;
}
@
Override
public
FileExchange
createExchange
(
)
{
return
createExchange
(
getFile
(
)
)
;
}
@
Override
public
FileExchange
createExchange
(
ExchangePattern
pattern
)
{
return
new
FileExchange
(
getCamelContext
(
)
,
pattern
,
file
)
;
}
public
String
getGeneratedFileName
(
Message
message
)
{
return
getFileFriendlyMessageId
(
message
.
getMessageId
(
)
)
;
}
public
void
configureMessage
(
File
file
,
Message
message
)
{
message
.
setBody
(
file
)
;
String
relativePath
=
file
.
getPath
(
)
.
substring
(
getFile
(
)
.
getPath
(
)
.
length
(
)
)
;
if
(
relativePath
.
startsWith
(
File
.
separator
)
||
relativePath
.
startsWith
(
"/"
)
)
{
relativePath
=
relativePath
.
substring
(
1
)
;
}
message
.
setHeader
(
FileComponent
.
HEADER_FILE_NAME
,
relativePath
)
;
}
public
File
getFile
(
)
{
ObjectHelper
.
notNull
(
file
,
"file"
)
;
if
(
autoCreate
&&
!
file
.
exists
(
)
)
{
file
.
mkdirs
(
)
;
}
return
file
;
}
public
void
setFile
(
File
file
)
{
this
.
file
=
file
;
}
public
boolean
isSingleton
(
)
{
return
true
;
}
public
boolean
isAutoCreate
(
)
{
return
this
.
autoCreate
;
}
public
void
setAutoCreate
(
boolean
autoCreate
)
{
this
.
autoCreate
=
autoCreate
;
}
public
FileProcessStrategy
getFileStrategy
(
)
{
if
(
fileProcessStrategy
==
null
)
{
fileProcessStrategy
=
createFileStrategy
(
)
;
LOG
.
debug
(
"Using file process strategy: "
+
fileProcessStrategy
)
;
}
return
fileProcessStrategy
;
}
public
void
setFileStrategy
(
FileProcessStrategy
fileProcessStrategy
)
{
this
.
fileProcessStrategy
=
fileProcessStrategy
;
}
public
boolean
isDelete
(
)
{
return
delete
;
}
public
void
setDelete
(
boolean
delete
)
{
this
.
delete
=
delete
;
}
public
boolean
isLock
(
)
{
return
lock
;
}
public
void
setLock
(
boolean
lock
)
{
this
.
lock
=
lock
;
}
public
String
getMoveNamePostfix
(
)
{
return
moveNamePostfix
;
}
public
void
setMoveNamePostfix
(
String
moveNamePostfix
)
{
this
.
moveNamePostfix
=
moveNamePostfix
;
}
public
String
getMoveNamePrefix
(
)
{
return
moveNamePrefix
;
}
public
void
setMoveNamePrefix
(
String
moveNamePrefix
)
{
this
.
moveNamePrefix
=
moveNamePrefix
;
}
public
String
[
]
getExcludedNamePrefixes
(
)
{
return
excludedNamePrefixes
;
}
public
void
setExcludedNamePrefixes
(
String
[
]
excludedNamePrefixes
)
{
this
.
excludedNamePrefixes
=
excludedNamePrefixes
;
}
public
String
[
]
getExcludedNamePostfixes
(
)
{
return
excludedNamePostfixes
;
}
public
void
setExcludedNamePostfixes
(
String
[
]
excludedNamePostfixes
)
{
this
.
excludedNamePostfixes
=
excludedNamePostfixes
;
}
public
String
getPreMoveNamePrefix
(
)
{
return
preMoveNamePrefix
;
}
public
void
setPreMoveNamePrefix
(
String
preMoveNamePrefix
)
{
this
.
preMoveNamePrefix
=
preMoveNamePrefix
;
}
public
String
getPreMoveNamePostfix
(
)
{
return
preMoveNamePostfix
;
}
public
void
setPreMoveNamePostfix
(
String
preMoveNamePostfix
)
{
this
.
preMoveNamePostfix
=
preMoveNamePostfix
;
}
public
boolean
isNoop
(
)
{
return
noop
;
}
public
void
setNoop
(
boolean
noop
)
{
this
.
noop
=
noop
;
}
public
boolean
isAppend
(
)
{
return
append
;
}
public
void
setAppend
(
boolean
append
)
{
this
.
append
=
append
;
}
public
int
getBufferSize
(
)
{
return
bufferSize
;
}
public
void
setBufferSize
(
int
bufferSize
)
{
this
.
bufferSize
=
bufferSize
;
}
public
boolean
isIgnoreFileNameHeader
(
)
{
return
ignoreFileNameHeader
;
}
public
void
setIgnoreFileNameHeader
(
boolean
ignoreFileNameHeader
)
{
this
.
ignoreFileNameHeader
=
ignoreFileNameHeader
;
}
public
String
getExcludedNamePrefix
(
)
{
return
excludedNamePrefix
;
}
public
void
setExcludedNamePrefix
(
String
excludedNamePrefix
)
{
this
.
excludedNamePrefix
=
excludedNamePrefix
;
}
public
String
getExcludedNamePostfix
(
)
{
return
excludedNamePostfix
;
}
public
void
setExcludedNamePostfix
(
String
excludedNamePostfix
)
{
this
.
excludedNamePostfix
=
excludedNamePostfix
;
}
public
Expression
getExpression
(
)
{
return
expression
;
}
public
void
setExpression
(
Expression
expression
)
{
this
.
expression
=
expression
;
}
public
void
setExpression
(
String
fileLanguageExpression
)
{
this
.
expression
=
FileLanguage
.
file
(
fileLanguageExpression
)
;
}
public
Expression
getPreMoveExpression
(
)
{
return
preMoveExpression
;
}
public
void
setPreMoveExpression
(
Expression
expression
)
{
this
.
preMoveExpression
=
expression
;
}
public
void
setPreMoveExpression
(
String
fileLanguageExpression
)
{
this
.
preMoveExpression
=
FileLanguage
.
file
(
fileLanguageExpression
)
;
}
protected
FileProcessStrategy
createFileStrategy
(
)
{
Class
<
?
>
factory
=
null
;
try
{
FactoryFinder
finder
=
getCamelContext
(
)
.
createFactoryFinder
(
"META-INF/services/org/apache/camel/component/"
)
;
factory
=
finder
.
findClass
(
"file"
,
"strategy.factory."
)
;
}
catch
(
ClassNotFoundException
e
)
{
LOG
.
debug
(
"'strategy.factory.class' not found"
,
e
)
;
}
catch
(
IOException
e
)
{
LOG
.
debug
(
"No strategy factory defined in 'META-INF/services/org/apache/camel/component/file'"
,
e
)
;
}
if
(
factory
==
null
)
{
factory
=
ObjectHelper
.
loadClass
(
DEFAULT_STRATEGYFACTORY_CLASS
)
;
if
(
factory
==
null
)
{
throw
new
TypeNotPresentException
(
"FileProcessStrategyFactory class not found"
,
null
)
;
}
}
try
{
Method
factoryMethod
=
factory
.
getMethod
(
"createFileProcessStrategy"
,
Map
.
class
)
;
return
(
FileProcessStrategy
)
ObjectHelper
.
invokeMethod
(
factoryMethod
,
null
,
getParamsAsMap
(
)
)
;
}
catch
(
NoSuchMethodException
e
)
{
throw
new
TypeNotPresentException
(
factory
.
getSimpleName
(
)
+
".createFileProcessStrategy(Properties params) method not found"
,
e
)
;
}
}
protected
Map
<
String
,
Object
>
getParamsAsMap
(
)
{
Map
<
String
,
Object
>
params
=
new
HashMap
<
String
,
Object
>
(
)
;
if
(
isNoop
(
)
)
{
params
.
put
(
"noop"
,
Boolean
.
toString
(
true
)
)
;
}
if
(
isDelete
(
)
)
{
params
.
put
(
"delete"
,
Boolean
.
toString
(
true
)
)
;
}
if
(
isAppend
(
)
)
{
params
.
put
(
"append"
,
Boolean
.
toString
(
true
)
)
;
}
if
(
isLock
(
)
)
{
params
.
put
(
"lock"
,
Boolean
.
toString
(
true
)
)
;
}
if
(
moveNamePrefix
!=
null
)
{
params
.
put
(
"moveNamePrefix"
,
moveNamePrefix
)
;
}
if
(
moveNamePostfix
!=
null
)
{
params
.
put
(
"moveNamePostfix"
,
moveNamePostfix
)
;
}
if
(
preMoveNamePrefix
!=
null
)
{
params
.
put
(
"preMoveNamePrefix"
,
preMoveNamePrefix
)
;
}
if
(
preMoveNamePostfix
!=
null
)
{
params
.
put
(
"preMoveNamePostfix"
,
preMoveNamePostfix
)
;
}
if
(
expression
!=
null
)
{
params
.
put
(
"expression"
,
expression
)
;
}
if
(
preMoveExpression
!=
null
)
{
params
.
put
(
"preMoveExpression"
,
preMoveExpression
)
;
}
return
params
;
}
@
Override
protected
String
createEndpointUri
(
)
{
return
"file://"
+
getFile
(
)
.
getAbsolutePath
(
)
;
}
protected
String
getFileFriendlyMessageId
(
String
id
)
{
return
UuidGenerator
.
generateSanitizedId
(
id
)
;
}
}
