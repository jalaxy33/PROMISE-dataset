package
org
.
apache
.
camel
.
component
.
file
;
import
org
.
apache
.
camel
.
Consumer
;
import
org
.
apache
.
camel
.
Processor
;
import
org
.
apache
.
camel
.
Producer
;
import
org
.
apache
.
camel
.
ExchangePattern
;
import
org
.
apache
.
camel
.
Message
;
import
org
.
apache
.
camel
.
component
.
file
.
strategy
.
DefaultFileRenamer
;
import
org
.
apache
.
camel
.
component
.
file
.
strategy
.
DeleteFileProcessStrategy
;
import
org
.
apache
.
camel
.
component
.
file
.
strategy
.
FileProcessStrategy
;
import
org
.
apache
.
camel
.
component
.
file
.
strategy
.
FileProcessStrategySupport
;
import
org
.
apache
.
camel
.
component
.
file
.
strategy
.
NoOpFileProcessStrategy
;
import
org
.
apache
.
camel
.
component
.
file
.
strategy
.
RenameFileProcessStrategy
;
import
org
.
apache
.
camel
.
impl
.
ScheduledPollEndpoint
;
import
org
.
apache
.
commons
.
logging
.
Log
;
import
org
.
apache
.
commons
.
logging
.
LogFactory
;
import
java
.
io
.
File
;
public
class
FileEndpoint
extends
ScheduledPollEndpoint
<
FileExchange
>
{
private
static
final
transient
Log
LOG
=
LogFactory
.
getLog
(
FileEndpoint
.
class
)
;
private
File
file
;
private
FileProcessStrategy
fileProcessStrategy
;
private
boolean
autoCreate
=
true
;
private
boolean
lock
=
true
;
private
boolean
delete
;
private
boolean
noop
;
private
boolean
append
=
true
;
private
String
moveNamePrefix
;
private
String
moveNamePostfix
;
private
String
[
]
excludedNamePrefixes
=
{
"."
}
;
private
String
[
]
excludedNamePostfixes
=
{
FileProcessStrategySupport
.
DEFAULT_LOCK_FILE_POSTFIX
}
;
private
int
bufferSize
=
128
*
1024
;
private
boolean
ignoreFileNameHeader
;
protected
FileEndpoint
(
File
file
,
String
endpointUri
,
FileComponent
component
)
{
super
(
endpointUri
,
component
)
;
this
.
file
=
file
;
}
public
Producer
<
FileExchange
>
createProducer
(
)
throws
Exception
{
Producer
<
FileExchange
>
result
=
new
FileProducer
(
this
)
;
return
result
;
}
public
Consumer
<
FileExchange
>
createConsumer
(
Processor
file
)
throws
Exception
{
Consumer
<
FileExchange
>
result
=
new
FileConsumer
(
this
,
file
)
;
configureConsumer
(
result
)
;
return
result
;
}
public
FileExchange
createExchange
(
File
file
)
{
return
new
FileExchange
(
getContext
(
)
,
getExchangePattern
(
)
,
file
)
;
}
public
FileExchange
createExchange
(
)
{
return
createExchange
(
getFile
(
)
)
;
}
public
FileExchange
createExchange
(
ExchangePattern
pattern
)
{
return
new
FileExchange
(
getContext
(
)
,
pattern
,
file
)
;
}
public
void
configureMessage
(
File
file
,
Message
message
)
{
message
.
setBody
(
file
)
;
String
path
=
file
.
getPath
(
)
;
String
relativePath
=
path
.
substring
(
path
.
length
(
)
)
;
if
(
relativePath
.
startsWith
(
File
.
separator
)
||
relativePath
.
startsWith
(
"/"
)
)
{
relativePath
=
relativePath
.
substring
(
1
)
;
}
message
.
setHeader
(
FileComponent
.
HEADER_FILE_NAME
,
relativePath
)
;
}
public
File
getFile
(
)
{
if
(
autoCreate
&&
!
file
.
exists
(
)
)
{
file
.
mkdirs
(
)
;
}
return
file
;
}
public
boolean
isSingleton
(
)
{
return
true
;
}
public
boolean
isAutoCreate
(
)
{
return
this
.
autoCreate
;
}
public
void
setAutoCreate
(
boolean
autoCreate
)
{
this
.
autoCreate
=
autoCreate
;
}
public
FileProcessStrategy
getFileStrategy
(
)
{
if
(
fileProcessStrategy
==
null
)
{
fileProcessStrategy
=
createFileStrategy
(
)
;
LOG
.
debug
(
""
+
this
+
" using strategy: "
+
fileProcessStrategy
)
;
}
return
fileProcessStrategy
;
}
public
void
setFileStrategy
(
FileProcessStrategy
fileProcessStrategy
)
{
this
.
fileProcessStrategy
=
fileProcessStrategy
;
}
public
boolean
isDelete
(
)
{
return
delete
;
}
public
void
setDelete
(
boolean
delete
)
{
this
.
delete
=
delete
;
}
public
boolean
isLock
(
)
{
return
lock
;
}
public
void
setLock
(
boolean
lock
)
{
this
.
lock
=
lock
;
}
public
String
getMoveNamePostfix
(
)
{
return
moveNamePostfix
;
}
public
void
setMoveNamePostfix
(
String
moveNamePostfix
)
{
this
.
moveNamePostfix
=
moveNamePostfix
;
}
public
String
getMoveNamePrefix
(
)
{
return
moveNamePrefix
;
}
public
void
setMoveNamePrefix
(
String
moveNamePrefix
)
{
this
.
moveNamePrefix
=
moveNamePrefix
;
}
public
String
[
]
getExcludedNamePrefixes
(
)
{
return
excludedNamePrefixes
;
}
public
void
setExcludedNamePrefixes
(
String
[
]
excludedNamePrefixes
)
{
this
.
excludedNamePrefixes
=
excludedNamePrefixes
;
}
public
String
[
]
getExcludedNamePostfixes
(
)
{
return
excludedNamePostfixes
;
}
public
void
setExcludedNamePostfixes
(
String
[
]
excludedNamePostfixes
)
{
this
.
excludedNamePostfixes
=
excludedNamePostfixes
;
}
public
boolean
isNoop
(
)
{
return
noop
;
}
public
void
setNoop
(
boolean
noop
)
{
this
.
noop
=
noop
;
}
public
boolean
isAppend
(
)
{
return
append
;
}
public
void
setAppend
(
boolean
append
)
{
this
.
append
=
append
;
}
public
int
getBufferSize
(
)
{
return
bufferSize
;
}
public
void
setBufferSize
(
int
bufferSize
)
{
this
.
bufferSize
=
bufferSize
;
}
public
boolean
isIgnoreFileNameHeader
(
)
{
return
ignoreFileNameHeader
;
}
public
void
setIgnoreFileNameHeader
(
boolean
ignoreFileNameHeader
)
{
this
.
ignoreFileNameHeader
=
ignoreFileNameHeader
;
}
protected
FileProcessStrategy
createFileStrategy
(
)
{
if
(
isNoop
(
)
)
{
return
new
NoOpFileProcessStrategy
(
)
;
}
else
if
(
moveNamePostfix
!=
null
||
moveNamePrefix
!=
null
)
{
if
(
isDelete
(
)
)
{
throw
new
IllegalArgumentException
(
"You cannot set the deleteFiles property and a moveFilenamePostfix or moveFilenamePrefix"
)
;
}
return
new
RenameFileProcessStrategy
(
isLock
(
)
,
moveNamePrefix
,
moveNamePostfix
)
;
}
else
if
(
isDelete
(
)
)
{
return
new
DeleteFileProcessStrategy
(
isLock
(
)
)
;
}
else
{
return
new
RenameFileProcessStrategy
(
isLock
(
)
)
;
}
}
}
