package
fr
.
jayasoft
.
ivy
.
repository
.
vfs
;
import
java
.
io
.
IOException
;
import
java
.
io
.
InputStream
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
List
;
import
org
.
apache
.
commons
.
vfs
.
FileContent
;
import
org
.
apache
.
commons
.
vfs
.
FileObject
;
import
org
.
apache
.
commons
.
vfs
.
FileSystemException
;
import
org
.
apache
.
commons
.
vfs
.
FileSystemManager
;
import
org
.
apache
.
commons
.
vfs
.
FileType
;
import
fr
.
jayasoft
.
ivy
.
repository
.
Resource
;
import
fr
.
jayasoft
.
ivy
.
util
.
Message
;
import
fr
.
jayasoft
.
ivy
.
resolver
.
VfsResolver
;
public
class
VfsResource
implements
Resource
{
private
String
_vfsURI
;
private
FileSystemManager
_fsManager
;
private
transient
boolean
_init
=
false
;
private
transient
boolean
_exists
;
private
transient
long
_lastModified
;
private
transient
long
_contentLength
;
private
transient
FileContent
_content
=
null
;
private
transient
FileObject
_resourceImpl
;
public
VfsResource
(
String
vfsURI
,
FileSystemManager
fsManager
)
{
this
.
_vfsURI
=
vfsURI
;
this
.
_fsManager
=
fsManager
;
this
.
_init
=
false
;
}
private
void
init
(
)
{
if
(
!
_init
)
{
try
{
_resourceImpl
=
_fsManager
.
resolveFile
(
_vfsURI
)
;
_content
=
_resourceImpl
.
getContent
(
)
;
_exists
=
_resourceImpl
.
exists
(
)
;
_lastModified
=
_content
.
getLastModifiedTime
(
)
;
_contentLength
=
_content
.
getSize
(
)
;
}
catch
(
FileSystemException
e
)
{
Message
.
verbose
(
e
.
getLocalizedMessage
(
)
)
;
_exists
=
false
;
_lastModified
=
0
;
_contentLength
=
0
;
}
_init
=
true
;
}
}
public
List
getChildren
(
)
{
init
(
)
;
ArrayList
list
=
new
ArrayList
(
)
;
try
{
if
(
(
_resourceImpl
!=
null
)
&&
_resourceImpl
.
exists
(
)
&&
(
_resourceImpl
.
getType
(
)
==
FileType
.
FOLDER
)
)
{
FileObject
[
]
children
=
_resourceImpl
.
getChildren
(
)
;
for
(
int
i
=
0
;
i
<
children
.
length
;
i
++
)
{
FileObject
child
=
children
[
i
]
;
list
.
add
(
normalize
(
child
.
getName
(
)
.
getURI
(
)
)
)
;
}
}
}
catch
(
IOException
e
)
{
Message
.
verbose
(
e
.
getLocalizedMessage
(
)
)
;
}
return
list
;
}
public
FileContent
getContent
(
)
{
init
(
)
;
return
_content
;
}
public
String
getName
(
)
{
return
normalize
(
_vfsURI
)
;
}
public
Resource
clone
(
String
cloneName
)
{
return
new
VfsResource
(
cloneName
,
_fsManager
)
;
}
public
static
String
normalize
(
String
vfsURI
)
{
if
(
vfsURI
==
null
)
{
return
""
;
}
if
(
vfsURI
.
startsWith
(
"file:////"
)
)
{
vfsURI
=
vfsURI
.
replaceFirst
(
"////"
,
"///"
)
;
}
return
vfsURI
;
}
public
long
getLastModified
(
)
{
init
(
)
;
return
_lastModified
;
}
public
long
getContentLength
(
)
{
init
(
)
;
return
_contentLength
;
}
public
boolean
exists
(
)
{
init
(
)
;
return
_exists
;
}
public
boolean
physicallyExists
(
)
{
init
(
)
;
try
{
return
_resourceImpl
.
exists
(
)
;
}
catch
(
Exception
e
)
{
Message
.
verbose
(
e
.
getLocalizedMessage
(
)
)
;
return
false
;
}
}
public
String
toString
(
)
{
return
VfsResolver
.
prepareForDisplay
(
getName
(
)
)
;
}
public
boolean
isLocal
(
)
{
return
getName
(
)
.
startsWith
(
"file:"
)
;
}
public
InputStream
openStream
(
)
throws
IOException
{
return
getContent
(
)
.
getInputStream
(
)
;
}
}
