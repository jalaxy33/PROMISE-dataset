package
org
.
apache
.
poi
.
hssf
.
model
;
import
org
.
apache
.
poi
.
hssf
.
record
.
*
;
import
org
.
apache
.
poi
.
hssf
.
record
.
aggregates
.
ColumnInfoRecordsAggregate
;
import
org
.
apache
.
poi
.
hssf
.
record
.
aggregates
.
FormulaRecordAggregate
;
import
org
.
apache
.
poi
.
hssf
.
record
.
aggregates
.
RowRecordsAggregate
;
import
org
.
apache
.
poi
.
hssf
.
record
.
aggregates
.
ValueRecordsAggregate
;
import
org
.
apache
.
poi
.
hssf
.
record
.
formula
.
Ptg
;
import
org
.
apache
.
poi
.
hssf
.
util
.
PaneInformation
;
import
org
.
apache
.
poi
.
util
.
POILogFactory
;
import
org
.
apache
.
poi
.
util
.
POILogger
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
Iterator
;
import
java
.
util
.
List
;
public
class
Sheet
implements
Model
{
public
static
final
short
LeftMargin
=
0
;
public
static
final
short
RightMargin
=
1
;
public
static
final
short
TopMargin
=
2
;
public
static
final
short
BottomMargin
=
3
;
private
static
POILogger
log
=
POILogFactory
.
getLogger
(
Sheet
.
class
)
;
protected
ArrayList
records
=
null
;
int
preoffset
=
0
;
int
loc
=
0
;
protected
int
dimsloc
=
0
;
protected
DimensionsRecord
dims
;
protected
DefaultColWidthRecord
defaultcolwidth
=
null
;
protected
DefaultRowHeightRecord
defaultrowheight
=
null
;
protected
GridsetRecord
gridset
=
null
;
protected
PrintSetupRecord
printSetup
=
null
;
protected
HeaderRecord
header
=
null
;
protected
FooterRecord
footer
=
null
;
protected
PrintGridlinesRecord
printGridlines
=
null
;
protected
WindowTwoRecord
windowTwo
=
null
;
protected
MergeCellsRecord
merged
=
null
;
protected
Margin
[
]
margins
=
null
;
protected
List
mergedRecords
=
new
ArrayList
(
)
;
protected
int
numMergedRegions
=
0
;
protected
SelectionRecord
selection
=
null
;
protected
ColumnInfoRecordsAggregate
columns
=
null
;
protected
ValueRecordsAggregate
cells
=
null
;
protected
RowRecordsAggregate
rows
=
null
;
private
Iterator
valueRecIterator
=
null
;
private
Iterator
rowRecIterator
=
null
;
protected
int
eofLoc
=
0
;
protected
ProtectRecord
protect
=
null
;
protected
PageBreakRecord
rowBreaks
=
null
;
protected
PageBreakRecord
colBreaks
=
null
;
public
static
final
byte
PANE_LOWER_RIGHT
=
(
byte
)
0
;
public
static
final
byte
PANE_UPPER_RIGHT
=
(
byte
)
1
;
public
static
final
byte
PANE_LOWER_LEFT
=
(
byte
)
2
;
public
static
final
byte
PANE_UPPER_LEFT
=
(
byte
)
3
;
public
Sheet
(
)
{
}
public
static
Sheet
createSheet
(
List
recs
,
int
sheetnum
,
int
offset
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
logFormatted
(
POILogger
.
DEBUG
,
"Sheet createSheet (existing file) with %"
,
new
Integer
(
recs
.
size
(
)
)
)
;
Sheet
retval
=
new
Sheet
(
)
;
ArrayList
records
=
new
ArrayList
(
recs
.
size
(
)
/
5
)
;
boolean
isfirstcell
=
true
;
boolean
isfirstrow
=
true
;
int
bofEofNestingLevel
=
0
;
for
(
int
k
=
offset
;
k
<
recs
.
size
(
)
;
k
++
)
{
Record
rec
=
(
Record
)
recs
.
get
(
k
)
;
if
(
rec
.
getSid
(
)
==
BOFRecord
.
sid
)
{
bofEofNestingLevel
++
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Hit BOF record. Nesting increased to "
+
bofEofNestingLevel
)
;
}
else
if
(
rec
.
getSid
(
)
==
EOFRecord
.
sid
)
{
--
bofEofNestingLevel
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Hit EOF record. Nesting decreased to "
+
bofEofNestingLevel
)
;
if
(
bofEofNestingLevel
==
0
)
{
records
.
add
(
rec
)
;
retval
.
eofLoc
=
k
;
break
;
}
}
else
if
(
rec
.
getSid
(
)
==
DimensionsRecord
.
sid
)
{
if
(
retval
.
columns
==
null
)
{
retval
.
columns
=
new
ColumnInfoRecordsAggregate
(
)
;
records
.
add
(
retval
.
columns
)
;
}
retval
.
dims
=
(
DimensionsRecord
)
rec
;
retval
.
dimsloc
=
records
.
size
(
)
;
}
else
if
(
rec
.
getSid
(
)
==
MergeCellsRecord
.
sid
)
{
retval
.
mergedRecords
.
add
(
rec
)
;
retval
.
merged
=
(
MergeCellsRecord
)
rec
;
retval
.
numMergedRegions
+=
retval
.
merged
.
getNumAreas
(
)
;
}
else
if
(
rec
.
getSid
(
)
==
ColumnInfoRecord
.
sid
)
{
ColumnInfoRecord
col
=
(
ColumnInfoRecord
)
rec
;
if
(
retval
.
columns
!=
null
)
{
rec
=
null
;
}
else
{
rec
=
retval
.
columns
=
new
ColumnInfoRecordsAggregate
(
)
;
}
retval
.
columns
.
insertColumn
(
col
)
;
}
else
if
(
rec
.
getSid
(
)
==
DefaultColWidthRecord
.
sid
)
{
retval
.
defaultcolwidth
=
(
DefaultColWidthRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
DefaultRowHeightRecord
.
sid
)
{
retval
.
defaultrowheight
=
(
DefaultRowHeightRecord
)
rec
;
}
else
if
(
rec
.
isValue
(
)
&&
bofEofNestingLevel
==
1
)
{
if
(
isfirstcell
)
{
retval
.
cells
=
new
ValueRecordsAggregate
(
)
;
rec
=
retval
.
cells
;
retval
.
cells
.
construct
(
k
,
recs
)
;
isfirstcell
=
false
;
}
else
{
rec
=
null
;
}
}
else
if
(
rec
.
getSid
(
)
==
StringRecord
.
sid
)
{
rec
=
null
;
}
else
if
(
rec
.
getSid
(
)
==
RowRecord
.
sid
)
{
RowRecord
row
=
(
RowRecord
)
rec
;
if
(
!
isfirstrow
)
rec
=
null
;
if
(
isfirstrow
)
{
retval
.
rows
=
new
RowRecordsAggregate
(
)
;
rec
=
retval
.
rows
;
isfirstrow
=
false
;
}
retval
.
rows
.
insertRow
(
row
)
;
}
else
if
(
rec
.
getSid
(
)
==
PrintGridlinesRecord
.
sid
)
{
retval
.
printGridlines
=
(
PrintGridlinesRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
GridsetRecord
.
sid
)
{
retval
.
gridset
=
(
GridsetRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
HeaderRecord
.
sid
&&
bofEofNestingLevel
==
1
)
{
retval
.
header
=
(
HeaderRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
FooterRecord
.
sid
&&
bofEofNestingLevel
==
1
)
{
retval
.
footer
=
(
FooterRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
PrintSetupRecord
.
sid
&&
bofEofNestingLevel
==
1
)
{
retval
.
printSetup
=
(
PrintSetupRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
LeftMarginRecord
.
sid
)
{
retval
.
getMargins
(
)
[
LeftMargin
]
=
(
LeftMarginRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
RightMarginRecord
.
sid
)
{
retval
.
getMargins
(
)
[
RightMargin
]
=
(
RightMarginRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
TopMarginRecord
.
sid
)
{
retval
.
getMargins
(
)
[
TopMargin
]
=
(
TopMarginRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
BottomMarginRecord
.
sid
)
{
retval
.
getMargins
(
)
[
BottomMargin
]
=
(
BottomMarginRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
SelectionRecord
.
sid
)
{
retval
.
selection
=
(
SelectionRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
WindowTwoRecord
.
sid
)
{
retval
.
windowTwo
=
(
WindowTwoRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
DBCellRecord
.
sid
)
{
rec
=
null
;
}
else
if
(
rec
.
getSid
(
)
==
IndexRecord
.
sid
)
{
rec
=
null
;
}
else
if
(
rec
.
getSid
(
)
==
ProtectRecord
.
sid
)
{
retval
.
protect
=
(
ProtectRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
PageBreakRecord
.
HORIZONTAL_SID
)
{
retval
.
rowBreaks
=
(
PageBreakRecord
)
rec
;
}
else
if
(
rec
.
getSid
(
)
==
PageBreakRecord
.
VERTICAL_SID
)
{
retval
.
colBreaks
=
(
PageBreakRecord
)
rec
;
}
if
(
rec
!=
null
)
{
records
.
add
(
rec
)
;
}
}
retval
.
records
=
records
;
retval
.
checkCells
(
)
;
retval
.
checkRows
(
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"sheet createSheet (existing file) exited"
)
;
return
retval
;
}
public
Sheet
cloneSheet
(
)
{
ArrayList
clonedRecords
=
new
ArrayList
(
this
.
records
.
size
(
)
)
;
for
(
int
i
=
0
;
i
<
this
.
records
.
size
(
)
;
i
++
)
{
Record
rec
=
(
Record
)
(
(
Record
)
this
.
records
.
get
(
i
)
)
.
clone
(
)
;
if
(
rec
instanceof
RowRecordsAggregate
)
{
RowRecordsAggregate
rrAgg
=
(
RowRecordsAggregate
)
rec
;
for
(
Iterator
rowIter
=
rrAgg
.
getIterator
(
)
;
rowIter
.
hasNext
(
)
;
)
{
Record
rowRec
=
(
Record
)
rowIter
.
next
(
)
;
clonedRecords
.
add
(
rowRec
)
;
}
}
else
if
(
rec
instanceof
ValueRecordsAggregate
)
{
ValueRecordsAggregate
vrAgg
=
(
ValueRecordsAggregate
)
rec
;
for
(
Iterator
cellIter
=
vrAgg
.
getIterator
(
)
;
cellIter
.
hasNext
(
)
;
)
{
Record
valRec
=
(
Record
)
cellIter
.
next
(
)
;
if
(
valRec
instanceof
FormulaRecordAggregate
)
{
FormulaRecordAggregate
fmAgg
=
(
FormulaRecordAggregate
)
valRec
;
Record
fmAggRec
=
fmAgg
.
getFormulaRecord
(
)
;
if
(
fmAggRec
!=
null
)
clonedRecords
.
add
(
fmAggRec
)
;
fmAggRec
=
fmAgg
.
getStringRecord
(
)
;
if
(
fmAggRec
!=
null
)
clonedRecords
.
add
(
fmAggRec
)
;
}
else
{
clonedRecords
.
add
(
valRec
)
;
}
}
}
else
if
(
rec
instanceof
FormulaRecordAggregate
)
{
FormulaRecordAggregate
fmAgg
=
(
FormulaRecordAggregate
)
rec
;
Record
fmAggRec
=
fmAgg
.
getFormulaRecord
(
)
;
if
(
fmAggRec
!=
null
)
clonedRecords
.
add
(
fmAggRec
)
;
fmAggRec
=
fmAgg
.
getStringRecord
(
)
;
if
(
fmAggRec
!=
null
)
clonedRecords
.
add
(
fmAggRec
)
;
}
else
{
clonedRecords
.
add
(
rec
)
;
}
}
return
createSheet
(
clonedRecords
,
0
,
0
)
;
}
public
static
Sheet
createSheet
(
List
records
,
int
sheetnum
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Sheet createSheet (exisiting file) assumed offset 0"
)
;
return
createSheet
(
records
,
sheetnum
,
0
)
;
}
public
static
Sheet
createSheet
(
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Sheet createsheet from scratch called"
)
;
Sheet
retval
=
new
Sheet
(
)
;
ArrayList
records
=
new
ArrayList
(
30
)
;
records
.
add
(
retval
.
createBOF
(
)
)
;
records
.
add
(
retval
.
createCalcMode
(
)
)
;
records
.
add
(
retval
.
createCalcCount
(
)
)
;
records
.
add
(
retval
.
createRefMode
(
)
)
;
records
.
add
(
retval
.
createIteration
(
)
)
;
records
.
add
(
retval
.
createDelta
(
)
)
;
records
.
add
(
retval
.
createSaveRecalc
(
)
)
;
records
.
add
(
retval
.
createPrintHeaders
(
)
)
;
retval
.
printGridlines
=
(
PrintGridlinesRecord
)
retval
.
createPrintGridlines
(
)
;
records
.
add
(
retval
.
printGridlines
)
;
retval
.
gridset
=
(
GridsetRecord
)
retval
.
createGridset
(
)
;
records
.
add
(
retval
.
gridset
)
;
records
.
add
(
retval
.
createGuts
(
)
)
;
retval
.
defaultrowheight
=
(
DefaultRowHeightRecord
)
retval
.
createDefaultRowHeight
(
)
;
records
.
add
(
retval
.
defaultrowheight
)
;
records
.
add
(
retval
.
createWSBool
(
)
)
;
retval
.
rowBreaks
=
new
PageBreakRecord
(
PageBreakRecord
.
HORIZONTAL_SID
)
;
records
.
add
(
retval
.
rowBreaks
)
;
retval
.
colBreaks
=
new
PageBreakRecord
(
PageBreakRecord
.
VERTICAL_SID
)
;
records
.
add
(
retval
.
colBreaks
)
;
retval
.
header
=
(
HeaderRecord
)
retval
.
createHeader
(
)
;
records
.
add
(
retval
.
header
)
;
retval
.
footer
=
(
FooterRecord
)
retval
.
createFooter
(
)
;
records
.
add
(
retval
.
footer
)
;
records
.
add
(
retval
.
createHCenter
(
)
)
;
records
.
add
(
retval
.
createVCenter
(
)
)
;
retval
.
printSetup
=
(
PrintSetupRecord
)
retval
.
createPrintSetup
(
)
;
records
.
add
(
retval
.
printSetup
)
;
retval
.
defaultcolwidth
=
(
DefaultColWidthRecord
)
retval
.
createDefaultColWidth
(
)
;
records
.
add
(
retval
.
defaultcolwidth
)
;
ColumnInfoRecordsAggregate
columns
=
new
ColumnInfoRecordsAggregate
(
)
;
records
.
add
(
columns
)
;
retval
.
columns
=
columns
;
retval
.
dims
=
(
DimensionsRecord
)
retval
.
createDimensions
(
)
;
records
.
add
(
retval
.
dims
)
;
retval
.
dimsloc
=
records
.
size
(
)
-
1
;
records
.
add
(
retval
.
windowTwo
=
retval
.
createWindowTwo
(
)
)
;
retval
.
setLoc
(
records
.
size
(
)
-
1
)
;
retval
.
selection
=
(
SelectionRecord
)
retval
.
createSelection
(
)
;
records
.
add
(
retval
.
selection
)
;
retval
.
protect
=
(
ProtectRecord
)
retval
.
createProtect
(
)
;
records
.
add
(
retval
.
protect
)
;
records
.
add
(
retval
.
createEOF
(
)
)
;
retval
.
records
=
records
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Sheet createsheet from scratch exit"
)
;
return
retval
;
}
private
void
checkCells
(
)
{
if
(
cells
==
null
)
{
cells
=
new
ValueRecordsAggregate
(
)
;
records
.
add
(
getDimsLoc
(
)
+
1
,
cells
)
;
}
}
private
void
checkRows
(
)
{
if
(
rows
==
null
)
{
rows
=
new
RowRecordsAggregate
(
)
;
records
.
add
(
getDimsLoc
(
)
+
1
,
rows
)
;
}
}
public
int
addMergedRegion
(
int
rowFrom
,
short
colFrom
,
int
rowTo
,
short
colTo
)
{
if
(
merged
==
null
||
merged
.
getNumAreas
(
)
==
1027
)
{
merged
=
(
MergeCellsRecord
)
createMergedCells
(
)
;
mergedRecords
.
add
(
merged
)
;
records
.
add
(
records
.
size
(
)
-
1
,
merged
)
;
}
merged
.
addArea
(
rowFrom
,
colFrom
,
rowTo
,
colTo
)
;
return
numMergedRegions
++
;
}
public
void
removeMergedRegion
(
int
index
)
{
if
(
index
>=
numMergedRegions
||
mergedRecords
.
size
(
)
==
0
)
return
;
int
pos
=
0
;
int
startNumRegions
=
0
;
if
(
numMergedRegions
-
index
<
merged
.
getNumAreas
(
)
)
{
pos
=
mergedRecords
.
size
(
)
-
1
;
startNumRegions
=
numMergedRegions
-
merged
.
getNumAreas
(
)
;
}
else
{
for
(
int
n
=
0
;
n
<
mergedRecords
.
size
(
)
;
n
++
)
{
MergeCellsRecord
record
=
(
MergeCellsRecord
)
mergedRecords
.
get
(
n
)
;
if
(
startNumRegions
+
record
.
getNumAreas
(
)
>
index
)
{
pos
=
n
;
break
;
}
startNumRegions
+=
record
.
getNumAreas
(
)
;
}
}
MergeCellsRecord
rec
=
(
MergeCellsRecord
)
mergedRecords
.
get
(
pos
)
;
rec
.
removeAreaAt
(
index
-
startNumRegions
)
;
numMergedRegions
--
;
if
(
rec
.
getNumAreas
(
)
==
0
)
{
mergedRecords
.
remove
(
pos
)
;
records
.
remove
(
merged
)
;
if
(
merged
==
rec
)
{
if
(
mergedRecords
.
size
(
)
>
0
)
{
merged
=
(
MergeCellsRecord
)
mergedRecords
.
get
(
mergedRecords
.
size
(
)
-
1
)
;
}
else
{
merged
=
null
;
}
}
}
}
public
MergeCellsRecord
.
MergedRegion
getMergedRegionAt
(
int
index
)
{
if
(
index
>=
numMergedRegions
||
mergedRecords
.
size
(
)
==
0
)
return
null
;
int
pos
=
0
;
int
startNumRegions
=
0
;
if
(
numMergedRegions
-
index
<
merged
.
getNumAreas
(
)
)
{
pos
=
mergedRecords
.
size
(
)
-
1
;
startNumRegions
=
numMergedRegions
-
merged
.
getNumAreas
(
)
;
}
else
{
for
(
int
n
=
0
;
n
<
mergedRecords
.
size
(
)
;
n
++
)
{
MergeCellsRecord
record
=
(
MergeCellsRecord
)
mergedRecords
.
get
(
n
)
;
if
(
startNumRegions
+
record
.
getNumAreas
(
)
>
index
)
{
pos
=
n
;
break
;
}
startNumRegions
+=
record
.
getNumAreas
(
)
;
}
}
return
(
(
MergeCellsRecord
)
mergedRecords
.
get
(
pos
)
)
.
getAreaAt
(
index
-
startNumRegions
)
;
}
public
int
getNumMergedRegions
(
)
{
return
numMergedRegions
;
}
public
int
getNumRecords
(
)
{
checkCells
(
)
;
checkRows
(
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
{
log
.
log
(
POILogger
.
DEBUG
,
"Sheet.getNumRecords"
)
;
log
.
logFormatted
(
POILogger
.
DEBUG
,
"returning % + % + % - 2 = %"
,
new
int
[
]
{
records
.
size
(
)
,
cells
.
getPhysicalNumberOfCells
(
)
,
rows
.
getPhysicalNumberOfRows
(
)
,
records
.
size
(
)
+
cells
.
getPhysicalNumberOfCells
(
)
+
rows
.
getPhysicalNumberOfRows
(
)
-
2
}
)
;
}
return
records
.
size
(
)
+
cells
.
getPhysicalNumberOfCells
(
)
+
rows
.
getPhysicalNumberOfRows
(
)
-
2
;
}
public
void
setDimensions
(
int
firstrow
,
short
firstcol
,
int
lastrow
,
short
lastcol
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
{
log
.
log
(
POILogger
.
DEBUG
,
"Sheet.setDimensions"
)
;
log
.
log
(
POILogger
.
DEBUG
,
(
new
StringBuffer
(
"firstrow"
)
)
.
append
(
firstrow
)
.
append
(
"firstcol"
)
.
append
(
firstcol
)
.
append
(
"lastrow"
)
.
append
(
lastrow
)
.
append
(
"lastcol"
)
.
append
(
lastcol
)
.
toString
(
)
)
;
}
dims
.
setFirstCol
(
firstcol
)
;
dims
.
setFirstRow
(
firstrow
)
;
dims
.
setLastCol
(
lastcol
)
;
dims
.
setLastRow
(
lastrow
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Sheet.setDimensions exiting"
)
;
}
public
void
setLoc
(
int
loc
)
{
valueRecIterator
=
null
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"sheet.setLoc(): "
+
loc
)
;
this
.
loc
=
loc
;
}
public
int
getLoc
(
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"sheet.getLoc():"
+
loc
)
;
return
loc
;
}
public
void
setPreOffset
(
int
offset
)
{
this
.
preoffset
=
offset
;
}
public
int
getPreOffset
(
)
{
return
preoffset
;
}
public
int
serialize
(
int
offset
,
byte
[
]
data
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Sheet.serialize using offsets"
)
;
int
pos
=
offset
;
boolean
haveSerializedIndex
=
false
;
for
(
int
k
=
0
;
k
<
records
.
size
(
)
;
k
++
)
{
Record
record
=
(
(
Record
)
records
.
get
(
k
)
)
;
if
(
record
instanceof
RowRecordsAggregate
)
{
pos
+=
(
(
RowRecordsAggregate
)
record
)
.
serialize
(
pos
,
data
,
cells
)
;
}
else
if
(
record
instanceof
ValueRecordsAggregate
)
{
}
else
{
pos
+=
record
.
serialize
(
pos
,
data
)
;
}
if
(
record
.
getSid
(
)
==
BOFRecord
.
sid
)
{
if
(
rows
!=
null
&&
!
haveSerializedIndex
)
{
haveSerializedIndex
=
true
;
pos
+=
serializeIndexRecord
(
k
,
pos
,
data
)
;
}
}
}
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"Sheet.serialize returning "
)
;
return
pos
-
offset
;
}
private
int
serializeIndexRecord
(
final
int
BOFRecordIndex
,
final
int
offset
,
byte
[
]
data
)
{
IndexRecord
index
=
new
IndexRecord
(
)
;
index
.
setFirstRow
(
rows
.
getFirstRowNum
(
)
)
;
index
.
setLastRowAdd1
(
rows
.
getLastRowNum
(
)
+
1
)
;
int
sheetRecSize
=
0
;
for
(
int
j
=
BOFRecordIndex
+
1
;
j
<
records
.
size
(
)
;
j
++
)
{
Record
tmpRec
=
(
(
Record
)
records
.
get
(
j
)
)
;
if
(
tmpRec
instanceof
RowRecordsAggregate
)
break
;
sheetRecSize
+=
tmpRec
.
getRecordSize
(
)
;
}
int
blockCount
=
rows
.
getRowBlockCount
(
)
;
int
indexRecSize
=
IndexRecord
.
getRecordSizeForBlockCount
(
blockCount
)
;
int
rowBlockOffset
=
0
;
int
cellBlockOffset
=
0
;
int
dbCellOffset
=
0
;
for
(
int
block
=
0
;
block
<
blockCount
;
block
++
)
{
rowBlockOffset
+=
rows
.
getRowBlockSize
(
block
)
;
cellBlockOffset
+=
null
==
cells
?
0
:
cells
.
getRowCellBlockSize
(
rows
.
getStartRowNumberForBlock
(
block
)
,
rows
.
getEndRowNumberForBlock
(
block
)
)
;
index
.
addDbcell
(
offset
+
indexRecSize
+
sheetRecSize
+
dbCellOffset
+
rowBlockOffset
+
cellBlockOffset
)
;
dbCellOffset
+=
(
8
+
(
rows
.
getRowCountForBlock
(
block
)
*
2
)
)
;
}
return
index
.
serialize
(
offset
,
data
)
;
}
public
RowRecord
createRow
(
int
row
)
{
return
RowRecordsAggregate
.
createRow
(
row
)
;
}
public
LabelSSTRecord
createLabelSST
(
int
row
,
short
col
,
int
index
)
{
log
.
logFormatted
(
POILogger
.
DEBUG
,
"create labelsst row,col,index %,%,%"
,
new
int
[
]
{
row
,
col
,
index
}
)
;
LabelSSTRecord
rec
=
new
LabelSSTRecord
(
)
;
rec
.
setRow
(
row
)
;
rec
.
setColumn
(
col
)
;
rec
.
setSSTIndex
(
index
)
;
rec
.
setXFIndex
(
(
short
)
0x0f
)
;
return
rec
;
}
public
NumberRecord
createNumber
(
int
row
,
short
col
,
double
value
)
{
log
.
logFormatted
(
POILogger
.
DEBUG
,
"create number row,col,value %,%,%"
,
new
double
[
]
{
row
,
col
,
value
}
)
;
NumberRecord
rec
=
new
NumberRecord
(
)
;
rec
.
setRow
(
row
)
;
rec
.
setColumn
(
col
)
;
rec
.
setValue
(
value
)
;
rec
.
setXFIndex
(
(
short
)
0x0f
)
;
return
rec
;
}
public
BlankRecord
createBlank
(
int
row
,
short
col
)
{
log
.
logFormatted
(
POILogger
.
DEBUG
,
"create blank row,col %,%"
,
new
int
[
]
{
row
,
col
}
)
;
BlankRecord
rec
=
new
BlankRecord
(
)
;
rec
.
setRow
(
row
)
;
rec
.
setColumn
(
col
)
;
rec
.
setXFIndex
(
(
short
)
0x0f
)
;
return
rec
;
}
public
FormulaRecord
createFormula
(
int
row
,
short
col
,
String
formula
)
{
log
.
logFormatted
(
POILogger
.
DEBUG
,
"create formula row,col,formula %,%,%"
,
new
int
[
]
{
row
,
col
}
,
formula
)
;
FormulaRecord
rec
=
new
FormulaRecord
(
)
;
rec
.
setRow
(
row
)
;
rec
.
setColumn
(
col
)
;
rec
.
setOptions
(
(
short
)
2
)
;
rec
.
setValue
(
0
)
;
rec
.
setXFIndex
(
(
short
)
0x0f
)
;
FormulaParser
fp
=
new
FormulaParser
(
formula
,
null
)
;
fp
.
parse
(
)
;
Ptg
[
]
ptg
=
fp
.
getRPNPtg
(
)
;
int
size
=
0
;
for
(
int
k
=
0
;
k
<
ptg
.
length
;
k
++
)
{
size
+=
ptg
[
k
]
.
getSize
(
)
;
rec
.
pushExpressionToken
(
ptg
[
k
]
)
;
}
rec
.
setExpressionLength
(
(
short
)
size
)
;
return
rec
;
}
public
void
addValueRecord
(
int
row
,
CellValueRecordInterface
col
)
{
checkCells
(
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
{
log
.
logFormatted
(
POILogger
.
DEBUG
,
"add value record  row,loc %,%"
,
new
int
[
]
{
row
,
loc
}
)
;
}
DimensionsRecord
d
=
(
DimensionsRecord
)
records
.
get
(
getDimsLoc
(
)
)
;
if
(
col
.
getColumn
(
)
>
d
.
getLastCol
(
)
)
{
d
.
setLastCol
(
(
short
)
(
col
.
getColumn
(
)
+
1
)
)
;
}
if
(
col
.
getColumn
(
)
<
d
.
getFirstCol
(
)
)
{
d
.
setFirstCol
(
col
.
getColumn
(
)
)
;
}
cells
.
insertCell
(
col
)
;
}
public
void
removeValueRecord
(
int
row
,
CellValueRecordInterface
col
)
{
checkCells
(
)
;
log
.
logFormatted
(
POILogger
.
DEBUG
,
"remove value record row,dimsloc %,%"
,
new
int
[
]
{
row
,
dimsloc
}
)
;
loc
=
dimsloc
;
cells
.
removeCell
(
col
)
;
}
public
void
replaceValueRecord
(
CellValueRecordInterface
newval
)
{
checkCells
(
)
;
setLoc
(
dimsloc
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"replaceValueRecord "
)
;
cells
.
removeCell
(
newval
)
;
cells
.
insertCell
(
newval
)
;
}
public
void
addRow
(
RowRecord
row
)
{
checkRows
(
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"addRow "
)
;
DimensionsRecord
d
=
(
DimensionsRecord
)
records
.
get
(
getDimsLoc
(
)
)
;
if
(
row
.
getRowNumber
(
)
>=
d
.
getLastRow
(
)
)
{
d
.
setLastRow
(
row
.
getRowNumber
(
)
+
1
)
;
}
if
(
row
.
getRowNumber
(
)
<
d
.
getFirstRow
(
)
)
{
d
.
setFirstRow
(
row
.
getRowNumber
(
)
)
;
}
RowRecord
existingRow
=
rows
.
getRow
(
row
.
getRowNumber
(
)
)
;
if
(
existingRow
!=
null
)
rows
.
removeRow
(
existingRow
)
;
rows
.
insertRow
(
row
)
;
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"exit addRow"
)
;
}
public
void
removeRow
(
RowRecord
row
)
{
checkRows
(
)
;
setLoc
(
getDimsLoc
(
)
)
;
rows
.
removeRow
(
row
)
;
}
public
CellValueRecordInterface
getNextValueRecord
(
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"getNextValue loc= "
+
loc
)
;
if
(
valueRecIterator
==
null
)
{
valueRecIterator
=
cells
.
getIterator
(
)
;
}
if
(
!
valueRecIterator
.
hasNext
(
)
)
{
return
null
;
}
return
(
CellValueRecordInterface
)
valueRecIterator
.
next
(
)
;
}
public
RowRecord
getNextRow
(
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"getNextRow loc= "
+
loc
)
;
if
(
rowRecIterator
==
null
)
{
rowRecIterator
=
rows
.
getIterator
(
)
;
}
if
(
!
rowRecIterator
.
hasNext
(
)
)
{
return
null
;
}
return
(
RowRecord
)
rowRecIterator
.
next
(
)
;
}
public
RowRecord
getRow
(
int
rownum
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"getNextRow loc= "
+
loc
)
;
return
rows
.
getRow
(
rownum
)
;
}
protected
Record
createBOF
(
)
{
BOFRecord
retval
=
new
BOFRecord
(
)
;
retval
.
setVersion
(
(
short
)
0x600
)
;
retval
.
setType
(
(
short
)
0x010
)
;
retval
.
setBuild
(
(
short
)
0x0dbb
)
;
retval
.
setBuildYear
(
(
short
)
1996
)
;
retval
.
setHistoryBitMask
(
0xc1
)
;
retval
.
setRequiredVersion
(
0x6
)
;
return
retval
;
}
protected
Record
createIndex
(
)
{
IndexRecord
retval
=
new
IndexRecord
(
)
;
retval
.
setFirstRow
(
0
)
;
retval
.
setLastRowAdd1
(
0
)
;
return
retval
;
}
protected
Record
createCalcMode
(
)
{
CalcModeRecord
retval
=
new
CalcModeRecord
(
)
;
retval
.
setCalcMode
(
(
short
)
1
)
;
return
retval
;
}
protected
Record
createCalcCount
(
)
{
CalcCountRecord
retval
=
new
CalcCountRecord
(
)
;
retval
.
setIterations
(
(
short
)
0x64
)
;
return
retval
;
}
protected
Record
createRefMode
(
)
{
RefModeRecord
retval
=
new
RefModeRecord
(
)
;
retval
.
setMode
(
RefModeRecord
.
USE_A1_MODE
)
;
return
retval
;
}
protected
Record
createIteration
(
)
{
IterationRecord
retval
=
new
IterationRecord
(
)
;
retval
.
setIteration
(
false
)
;
return
retval
;
}
protected
Record
createDelta
(
)
{
DeltaRecord
retval
=
new
DeltaRecord
(
)
;
retval
.
setMaxChange
(
0.0010
)
;
return
retval
;
}
protected
Record
createSaveRecalc
(
)
{
SaveRecalcRecord
retval
=
new
SaveRecalcRecord
(
)
;
retval
.
setRecalc
(
true
)
;
return
retval
;
}
protected
Record
createPrintHeaders
(
)
{
PrintHeadersRecord
retval
=
new
PrintHeadersRecord
(
)
;
retval
.
setPrintHeaders
(
false
)
;
return
retval
;
}
protected
Record
createPrintGridlines
(
)
{
PrintGridlinesRecord
retval
=
new
PrintGridlinesRecord
(
)
;
retval
.
setPrintGridlines
(
false
)
;
return
retval
;
}
protected
Record
createGridset
(
)
{
GridsetRecord
retval
=
new
GridsetRecord
(
)
;
retval
.
setGridset
(
true
)
;
return
retval
;
}
protected
Record
createGuts
(
)
{
GutsRecord
retval
=
new
GutsRecord
(
)
;
retval
.
setLeftRowGutter
(
(
short
)
0
)
;
retval
.
setTopColGutter
(
(
short
)
0
)
;
retval
.
setRowLevelMax
(
(
short
)
0
)
;
retval
.
setColLevelMax
(
(
short
)
0
)
;
return
retval
;
}
protected
Record
createDefaultRowHeight
(
)
{
DefaultRowHeightRecord
retval
=
new
DefaultRowHeightRecord
(
)
;
retval
.
setOptionFlags
(
(
short
)
0
)
;
retval
.
setRowHeight
(
(
short
)
0xff
)
;
return
retval
;
}
protected
Record
createWSBool
(
)
{
WSBoolRecord
retval
=
new
WSBoolRecord
(
)
;
retval
.
setWSBool1
(
(
byte
)
0x4
)
;
retval
.
setWSBool2
(
(
byte
)
0xffffffc1
)
;
return
retval
;
}
protected
Record
createHeader
(
)
{
HeaderRecord
retval
=
new
HeaderRecord
(
)
;
retval
.
setHeaderLength
(
(
byte
)
0
)
;
retval
.
setHeader
(
null
)
;
return
retval
;
}
protected
Record
createFooter
(
)
{
FooterRecord
retval
=
new
FooterRecord
(
)
;
retval
.
setFooterLength
(
(
byte
)
0
)
;
retval
.
setFooter
(
null
)
;
return
retval
;
}
protected
Record
createHCenter
(
)
{
HCenterRecord
retval
=
new
HCenterRecord
(
)
;
retval
.
setHCenter
(
false
)
;
return
retval
;
}
protected
Record
createVCenter
(
)
{
VCenterRecord
retval
=
new
VCenterRecord
(
)
;
retval
.
setVCenter
(
false
)
;
return
retval
;
}
protected
Record
createPrintSetup
(
)
{
PrintSetupRecord
retval
=
new
PrintSetupRecord
(
)
;
retval
.
setPaperSize
(
(
short
)
1
)
;
retval
.
setScale
(
(
short
)
100
)
;
retval
.
setPageStart
(
(
short
)
1
)
;
retval
.
setFitWidth
(
(
short
)
1
)
;
retval
.
setFitHeight
(
(
short
)
1
)
;
retval
.
setOptions
(
(
short
)
2
)
;
retval
.
setHResolution
(
(
short
)
300
)
;
retval
.
setVResolution
(
(
short
)
300
)
;
retval
.
setHeaderMargin
(
0.5
)
;
retval
.
setFooterMargin
(
0.5
)
;
retval
.
setCopies
(
(
short
)
0
)
;
return
retval
;
}
protected
Record
createDefaultColWidth
(
)
{
DefaultColWidthRecord
retval
=
new
DefaultColWidthRecord
(
)
;
retval
.
setColWidth
(
(
short
)
8
)
;
return
retval
;
}
protected
Record
createColInfo
(
)
{
return
ColumnInfoRecordsAggregate
.
createColInfo
(
)
;
}
public
short
getDefaultColumnWidth
(
)
{
return
defaultcolwidth
.
getColWidth
(
)
;
}
public
boolean
isGridsPrinted
(
)
{
if
(
gridset
==
null
)
{
gridset
=
(
GridsetRecord
)
createGridset
(
)
;
int
loc
=
findFirstRecordLocBySid
(
EOFRecord
.
sid
)
;
records
.
add
(
loc
,
gridset
)
;
}
return
!
gridset
.
getGridset
(
)
;
}
public
void
setGridsPrinted
(
boolean
value
)
{
gridset
.
setGridset
(
!
value
)
;
}
public
void
setDefaultColumnWidth
(
short
dcw
)
{
defaultcolwidth
.
setColWidth
(
dcw
)
;
}
public
void
setDefaultRowHeight
(
short
dch
)
{
defaultrowheight
.
setRowHeight
(
dch
)
;
}
public
short
getDefaultRowHeight
(
)
{
return
defaultrowheight
.
getRowHeight
(
)
;
}
public
short
getColumnWidth
(
short
column
)
{
short
retval
=
0
;
ColumnInfoRecord
ci
=
null
;
if
(
columns
!=
null
)
{
int
count
=
columns
.
getNumColumns
(
)
;
for
(
int
k
=
0
;
k
<
count
;
k
++
)
{
ci
=
columns
.
getColInfo
(
k
)
;
if
(
(
ci
.
getFirstColumn
(
)
<=
column
)
&&
(
column
<=
ci
.
getLastColumn
(
)
)
)
{
break
;
}
ci
=
null
;
}
}
if
(
ci
!=
null
)
{
retval
=
ci
.
getColumnWidth
(
)
;
}
else
{
retval
=
defaultcolwidth
.
getColWidth
(
)
;
}
return
retval
;
}
public
short
getXFIndexForColAt
(
short
column
)
{
short
retval
=
0
;
ColumnInfoRecord
ci
=
null
;
if
(
columns
!=
null
)
{
int
count
=
columns
.
getNumColumns
(
)
;
for
(
int
k
=
0
;
k
<
count
;
k
++
)
{
ci
=
columns
.
getColInfo
(
k
)
;
if
(
(
ci
.
getFirstColumn
(
)
<=
column
)
&&
(
column
<=
ci
.
getLastColumn
(
)
)
)
{
break
;
}
ci
=
null
;
}
}
retval
=
(
ci
!=
null
)
?
ci
.
getXFIndex
(
)
:
0xF
;
return
retval
;
}
public
void
setColumnWidth
(
short
column
,
short
width
)
{
setColumn
(
column
,
new
Short
(
width
)
,
null
,
null
,
null
)
;
}
public
boolean
isColumnHidden
(
short
column
)
{
boolean
retval
=
false
;
ColumnInfoRecord
ci
=
null
;
if
(
columns
!=
null
)
{
for
(
Iterator
iterator
=
columns
.
getIterator
(
)
;
iterator
.
hasNext
(
)
;
)
{
ci
=
(
ColumnInfoRecord
)
iterator
.
next
(
)
;
if
(
(
ci
.
getFirstColumn
(
)
<=
column
)
&&
(
column
<=
ci
.
getLastColumn
(
)
)
)
{
break
;
}
ci
=
null
;
}
}
if
(
ci
!=
null
)
{
retval
=
ci
.
getHidden
(
)
;
}
return
retval
;
}
public
void
setColumnHidden
(
short
column
,
boolean
hidden
)
{
setColumn
(
column
,
null
,
null
,
new
Boolean
(
hidden
)
,
null
)
;
}
public
void
setColumn
(
short
column
,
Short
width
,
Integer
level
,
Boolean
hidden
,
Boolean
collapsed
)
{
if
(
columns
==
null
)
columns
=
new
ColumnInfoRecordsAggregate
(
)
;
columns
.
setColumn
(
column
,
null
,
width
,
level
,
hidden
,
collapsed
)
;
}
public
void
setColumn
(
short
column
,
Short
xfStyle
,
Short
width
,
Integer
level
,
Boolean
hidden
,
Boolean
collapsed
)
{
if
(
columns
==
null
)
columns
=
new
ColumnInfoRecordsAggregate
(
)
;
columns
.
setColumn
(
column
,
xfStyle
,
width
,
level
,
hidden
,
collapsed
)
;
}
public
void
groupColumnRange
(
short
fromColumn
,
short
toColumn
,
boolean
indent
)
{
columns
.
groupColumnRange
(
fromColumn
,
toColumn
,
indent
)
;
int
maxLevel
=
0
;
int
count
=
columns
.
getNumColumns
(
)
;
for
(
int
k
=
0
;
k
<
count
;
k
++
)
{
ColumnInfoRecord
columnInfoRecord
=
columns
.
getColInfo
(
k
)
;
maxLevel
=
Math
.
max
(
columnInfoRecord
.
getOutlineLevel
(
)
,
maxLevel
)
;
}
GutsRecord
guts
=
(
GutsRecord
)
findFirstRecordBySid
(
GutsRecord
.
sid
)
;
guts
.
setColLevelMax
(
(
short
)
(
maxLevel
+
1
)
)
;
if
(
maxLevel
==
0
)
guts
.
setTopColGutter
(
(
short
)
0
)
;
else
guts
.
setTopColGutter
(
(
short
)
(
29
+
(
12
*
(
maxLevel
-
1
)
)
)
)
;
}
protected
Record
createDimensions
(
)
{
DimensionsRecord
retval
=
new
DimensionsRecord
(
)
;
retval
.
setFirstCol
(
(
short
)
0
)
;
retval
.
setLastRow
(
1
)
;
retval
.
setFirstRow
(
0
)
;
retval
.
setLastCol
(
(
short
)
1
)
;
return
retval
;
}
protected
WindowTwoRecord
createWindowTwo
(
)
{
WindowTwoRecord
retval
=
new
WindowTwoRecord
(
)
;
retval
.
setOptions
(
(
short
)
0x6b6
)
;
retval
.
setTopRow
(
(
short
)
0
)
;
retval
.
setLeftCol
(
(
short
)
0
)
;
retval
.
setHeaderColor
(
0x40
)
;
retval
.
setPageBreakZoom
(
(
short
)
0
)
;
retval
.
setNormalZoom
(
(
short
)
0
)
;
return
retval
;
}
protected
Record
createSelection
(
)
{
SelectionRecord
retval
=
new
SelectionRecord
(
)
;
retval
.
setPane
(
(
byte
)
0x3
)
;
retval
.
setActiveCellCol
(
(
short
)
0x0
)
;
retval
.
setActiveCellRow
(
(
short
)
0x0
)
;
retval
.
setNumRefs
(
(
short
)
0x0
)
;
return
retval
;
}
public
short
getTopRow
(
)
{
return
(
windowTwo
==
null
)
?
(
short
)
0
:
windowTwo
.
getTopRow
(
)
;
}
public
void
setTopRow
(
short
topRow
)
{
if
(
windowTwo
!=
null
)
{
windowTwo
.
setTopRow
(
topRow
)
;
}
}
public
void
setLeftCol
(
short
leftCol
)
{
if
(
windowTwo
!=
null
)
{
windowTwo
.
setLeftCol
(
leftCol
)
;
}
}
public
short
getLeftCol
(
)
{
return
(
windowTwo
==
null
)
?
(
short
)
0
:
windowTwo
.
getLeftCol
(
)
;
}
public
int
getActiveCellRow
(
)
{
if
(
selection
==
null
)
{
return
0
;
}
return
selection
.
getActiveCellRow
(
)
;
}
public
void
setActiveCellRow
(
int
row
)
{
if
(
selection
!=
null
)
{
selection
.
setActiveCellRow
(
row
)
;
}
}
public
short
getActiveCellCol
(
)
{
if
(
selection
==
null
)
{
return
(
short
)
0
;
}
return
selection
.
getActiveCellCol
(
)
;
}
public
void
setActiveCellCol
(
short
col
)
{
if
(
selection
!=
null
)
{
selection
.
setActiveCellCol
(
col
)
;
}
}
protected
Record
createMergedCells
(
)
{
MergeCellsRecord
retval
=
new
MergeCellsRecord
(
)
;
retval
.
setNumAreas
(
(
short
)
0
)
;
return
retval
;
}
protected
Record
createEOF
(
)
{
return
new
EOFRecord
(
)
;
}
public
int
getDimsLoc
(
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"getDimsLoc dimsloc= "
+
dimsloc
)
;
return
dimsloc
;
}
public
void
checkDimsLoc
(
Record
rec
,
int
recloc
)
{
if
(
rec
.
getSid
(
)
==
DimensionsRecord
.
sid
)
{
loc
=
recloc
;
dimsloc
=
recloc
;
}
}
public
int
getSize
(
)
{
int
retval
=
0
;
for
(
int
k
=
0
;
k
<
records
.
size
(
)
;
k
++
)
{
retval
+=
(
(
Record
)
records
.
get
(
k
)
)
.
getRecordSize
(
)
;
}
if
(
rows
!=
null
)
{
final
int
blocks
=
rows
.
getRowBlockCount
(
)
;
retval
+=
IndexRecord
.
getRecordSizeForBlockCount
(
blocks
)
;
retval
+=
(
8
*
blocks
)
;
for
(
Iterator
itr
=
rows
.
getIterator
(
)
;
itr
.
hasNext
(
)
;
)
{
RowRecord
row
=
(
RowRecord
)
itr
.
next
(
)
;
if
(
cells
!=
null
&&
cells
.
rowHasCells
(
row
.
getRowNumber
(
)
)
)
retval
+=
2
;
}
}
return
retval
;
}
public
List
getRecords
(
)
{
return
records
;
}
public
GridsetRecord
getGridsetRecord
(
)
{
return
gridset
;
}
public
Record
findFirstRecordBySid
(
short
sid
)
{
for
(
Iterator
iterator
=
records
.
iterator
(
)
;
iterator
.
hasNext
(
)
;
)
{
Record
record
=
(
Record
)
iterator
.
next
(
)
;
if
(
record
.
getSid
(
)
==
sid
)
{
return
record
;
}
}
return
null
;
}
public
void
setSCLRecord
(
SCLRecord
sclRecord
)
{
int
oldRecordLoc
=
findFirstRecordLocBySid
(
SCLRecord
.
sid
)
;
if
(
oldRecordLoc
==
-
1
)
{
int
windowRecordLoc
=
findFirstRecordLocBySid
(
WindowTwoRecord
.
sid
)
;
records
.
add
(
windowRecordLoc
+
1
,
sclRecord
)
;
}
else
{
records
.
set
(
oldRecordLoc
,
sclRecord
)
;
}
}
public
int
findFirstRecordLocBySid
(
short
sid
)
{
int
index
=
0
;
for
(
Iterator
iterator
=
records
.
iterator
(
)
;
iterator
.
hasNext
(
)
;
)
{
Record
record
=
(
Record
)
iterator
.
next
(
)
;
if
(
record
.
getSid
(
)
==
sid
)
{
return
index
;
}
index
++
;
}
return
-
1
;
}
public
HeaderRecord
getHeader
(
)
{
return
header
;
}
public
void
setHeader
(
HeaderRecord
newHeader
)
{
header
=
newHeader
;
}
public
FooterRecord
getFooter
(
)
{
return
footer
;
}
public
void
setFooter
(
FooterRecord
newFooter
)
{
footer
=
newFooter
;
}
public
PrintSetupRecord
getPrintSetup
(
)
{
return
printSetup
;
}
public
void
setPrintSetup
(
PrintSetupRecord
newPrintSetup
)
{
printSetup
=
newPrintSetup
;
}
public
PrintGridlinesRecord
getPrintGridlines
(
)
{
return
printGridlines
;
}
public
void
setPrintGridlines
(
PrintGridlinesRecord
newPrintGridlines
)
{
printGridlines
=
newPrintGridlines
;
}
public
void
setSelected
(
boolean
sel
)
{
windowTwo
.
setSelected
(
sel
)
;
}
public
double
getMargin
(
short
margin
)
{
if
(
getMargins
(
)
[
margin
]
!=
null
)
return
margins
[
margin
]
.
getMargin
(
)
;
else
{
switch
(
margin
)
{
case
LeftMargin
:
return
.75
;
case
RightMargin
:
return
.75
;
case
TopMargin
:
return
1.0
;
case
BottomMargin
:
return
1.0
;
default
:
throw
new
RuntimeException
(
"Unknown margin constant:  "
+
margin
)
;
}
}
}
public
void
setMargin
(
short
margin
,
double
size
)
{
Margin
m
=
getMargins
(
)
[
margin
]
;
if
(
m
==
null
)
{
switch
(
margin
)
{
case
LeftMargin
:
m
=
new
LeftMarginRecord
(
)
;
records
.
add
(
getDimsLoc
(
)
+
1
,
m
)
;
break
;
case
RightMargin
:
m
=
new
RightMarginRecord
(
)
;
records
.
add
(
getDimsLoc
(
)
+
1
,
m
)
;
break
;
case
TopMargin
:
m
=
new
TopMarginRecord
(
)
;
records
.
add
(
getDimsLoc
(
)
+
1
,
m
)
;
break
;
case
BottomMargin
:
m
=
new
BottomMarginRecord
(
)
;
records
.
add
(
getDimsLoc
(
)
+
1
,
m
)
;
break
;
default
:
throw
new
RuntimeException
(
"Unknown margin constant:  "
+
margin
)
;
}
margins
[
margin
]
=
m
;
}
m
.
setMargin
(
size
)
;
}
public
int
getEofLoc
(
)
{
return
eofLoc
;
}
public
void
createFreezePane
(
int
colSplit
,
int
rowSplit
,
int
topRow
,
int
leftmostColumn
)
{
int
paneLoc
=
findFirstRecordLocBySid
(
PaneRecord
.
sid
)
;
if
(
paneLoc
!=
-
1
)
records
.
remove
(
paneLoc
)
;
int
loc
=
findFirstRecordLocBySid
(
WindowTwoRecord
.
sid
)
;
PaneRecord
pane
=
new
PaneRecord
(
)
;
pane
.
setX
(
(
short
)
colSplit
)
;
pane
.
setY
(
(
short
)
rowSplit
)
;
pane
.
setTopRow
(
(
short
)
topRow
)
;
pane
.
setLeftColumn
(
(
short
)
leftmostColumn
)
;
if
(
rowSplit
==
0
)
{
pane
.
setTopRow
(
(
short
)
0
)
;
pane
.
setActivePane
(
(
short
)
1
)
;
}
else
if
(
colSplit
==
0
)
{
pane
.
setLeftColumn
(
(
short
)
64
)
;
pane
.
setActivePane
(
(
short
)
2
)
;
}
else
{
pane
.
setActivePane
(
(
short
)
0
)
;
}
records
.
add
(
loc
+
1
,
pane
)
;
windowTwo
.
setFreezePanes
(
true
)
;
windowTwo
.
setFreezePanesNoSplit
(
true
)
;
SelectionRecord
sel
=
(
SelectionRecord
)
findFirstRecordBySid
(
SelectionRecord
.
sid
)
;
sel
.
setPane
(
(
byte
)
pane
.
getActivePane
(
)
)
;
}
public
void
createSplitPane
(
int
xSplitPos
,
int
ySplitPos
,
int
topRow
,
int
leftmostColumn
,
int
activePane
)
{
int
paneLoc
=
findFirstRecordLocBySid
(
PaneRecord
.
sid
)
;
if
(
paneLoc
!=
-
1
)
records
.
remove
(
paneLoc
)
;
int
loc
=
findFirstRecordLocBySid
(
WindowTwoRecord
.
sid
)
;
PaneRecord
r
=
new
PaneRecord
(
)
;
r
.
setX
(
(
short
)
xSplitPos
)
;
r
.
setY
(
(
short
)
ySplitPos
)
;
r
.
setTopRow
(
(
short
)
topRow
)
;
r
.
setLeftColumn
(
(
short
)
leftmostColumn
)
;
r
.
setActivePane
(
(
short
)
activePane
)
;
records
.
add
(
loc
+
1
,
r
)
;
windowTwo
.
setFreezePanes
(
false
)
;
windowTwo
.
setFreezePanesNoSplit
(
false
)
;
SelectionRecord
sel
=
(
SelectionRecord
)
findFirstRecordBySid
(
SelectionRecord
.
sid
)
;
sel
.
setPane
(
PANE_LOWER_RIGHT
)
;
}
public
PaneInformation
getPaneInformation
(
)
{
PaneRecord
rec
=
(
PaneRecord
)
findFirstRecordBySid
(
PaneRecord
.
sid
)
;
if
(
rec
==
null
)
return
null
;
return
new
PaneInformation
(
rec
.
getX
(
)
,
rec
.
getY
(
)
,
rec
.
getTopRow
(
)
,
rec
.
getLeftColumn
(
)
,
(
byte
)
rec
.
getActivePane
(
)
,
windowTwo
.
getFreezePanes
(
)
)
;
}
public
SelectionRecord
getSelection
(
)
{
return
selection
;
}
public
void
setSelection
(
SelectionRecord
selection
)
{
this
.
selection
=
selection
;
}
protected
Record
createProtect
(
)
{
if
(
log
.
check
(
POILogger
.
DEBUG
)
)
log
.
log
(
POILogger
.
DEBUG
,
"create protect record with protection disabled"
)
;
ProtectRecord
retval
=
new
ProtectRecord
(
)
;
retval
.
setProtect
(
false
)
;
return
retval
;
}
public
ProtectRecord
getProtect
(
)
{
if
(
protect
==
null
)
{
protect
=
(
ProtectRecord
)
createProtect
(
)
;
int
loc
=
findFirstRecordLocBySid
(
EOFRecord
.
sid
)
;
records
.
add
(
loc
,
protect
)
;
}
return
protect
;
}
public
void
setDisplayGridlines
(
boolean
show
)
{
windowTwo
.
setDisplayGridlines
(
show
)
;
}
public
boolean
isDisplayGridlines
(
)
{
return
windowTwo
.
getDisplayGridlines
(
)
;
}
public
void
setDisplayFormulas
(
boolean
show
)
{
windowTwo
.
setDisplayFormulas
(
show
)
;
}
public
boolean
isDisplayFormulas
(
)
{
return
windowTwo
.
getDisplayFormulas
(
)
;
}
public
void
setDisplayRowColHeadings
(
boolean
show
)
{
windowTwo
.
setDisplayRowColHeadings
(
show
)
;
}
public
boolean
isDisplayRowColHeadings
(
)
{
return
windowTwo
.
getDisplayRowColHeadings
(
)
;
}
protected
Margin
[
]
getMargins
(
)
{
if
(
margins
==
null
)
margins
=
new
Margin
[
4
]
;
return
margins
;
}
public
int
aggregateDrawingRecords
(
DrawingManager2
drawingManager
)
{
int
loc
=
findFirstRecordLocBySid
(
DrawingRecord
.
sid
)
;
boolean
noDrawingRecordsFound
=
loc
==
-
1
;
if
(
noDrawingRecordsFound
)
{
EscherAggregate
aggregate
=
new
EscherAggregate
(
drawingManager
)
;
loc
=
findFirstRecordLocBySid
(
EscherAggregate
.
sid
)
;
if
(
loc
==
-
1
)
{
loc
=
findFirstRecordLocBySid
(
WindowTwoRecord
.
sid
)
;
}
else
{
getRecords
(
)
.
remove
(
loc
)
;
}
getRecords
(
)
.
add
(
loc
,
aggregate
)
;
return
loc
;
}
else
{
List
records
=
getRecords
(
)
;
EscherAggregate
r
=
EscherAggregate
.
createAggregate
(
records
,
loc
,
drawingManager
)
;
int
startloc
=
loc
;
while
(
loc
+
1
<
records
.
size
(
)
&&
records
.
get
(
loc
)
instanceof
DrawingRecord
&&
records
.
get
(
loc
+
1
)
instanceof
ObjRecord
)
{
loc
+=
2
;
}
int
endloc
=
loc
-
1
;
for
(
int
i
=
0
;
i
<
(
endloc
-
startloc
+
1
)
;
i
++
)
records
.
remove
(
startloc
)
;
records
.
add
(
startloc
,
r
)
;
return
startloc
;
}
}
public
void
preSerialize
(
)
{
for
(
Iterator
iterator
=
getRecords
(
)
.
iterator
(
)
;
iterator
.
hasNext
(
)
;
)
{
Record
r
=
(
Record
)
iterator
.
next
(
)
;
if
(
r
instanceof
EscherAggregate
)
r
.
getRecordSize
(
)
;
}
}
public
void
shiftBreaks
(
PageBreakRecord
breaks
,
short
start
,
short
stop
,
int
count
)
{
if
(
rowBreaks
==
null
)
return
;
Iterator
iterator
=
breaks
.
getBreaksIterator
(
)
;
List
shiftedBreak
=
new
ArrayList
(
)
;
while
(
iterator
.
hasNext
(
)
)
{
PageBreakRecord
.
Break
breakItem
=
(
PageBreakRecord
.
Break
)
iterator
.
next
(
)
;
short
breakLocation
=
breakItem
.
main
;
boolean
inStart
=
(
breakLocation
>=
start
)
;
boolean
inEnd
=
(
breakLocation
<=
stop
)
;
if
(
inStart
&&
inEnd
)
shiftedBreak
.
add
(
breakItem
)
;
}
iterator
=
shiftedBreak
.
iterator
(
)
;
while
(
iterator
.
hasNext
(
)
)
{
PageBreakRecord
.
Break
breakItem
=
(
PageBreakRecord
.
Break
)
iterator
.
next
(
)
;
breaks
.
removeBreak
(
breakItem
.
main
)
;
breaks
.
addBreak
(
(
short
)
(
breakItem
.
main
+
count
)
,
breakItem
.
subFrom
,
breakItem
.
subTo
)
;
}
}
public
void
setRowBreak
(
int
row
,
short
fromCol
,
short
toCol
)
{
if
(
rowBreaks
==
null
)
{
int
loc
=
findFirstRecordLocBySid
(
WindowTwoRecord
.
sid
)
;
rowBreaks
=
new
PageBreakRecord
(
PageBreakRecord
.
HORIZONTAL_SID
)
;
records
.
add
(
loc
,
rowBreaks
)
;
}
rowBreaks
.
addBreak
(
(
short
)
row
,
fromCol
,
toCol
)
;
}
public
void
removeRowBreak
(
int
row
)
{
if
(
rowBreaks
==
null
)
throw
new
IllegalArgumentException
(
"Sheet does not define any row breaks"
)
;
rowBreaks
.
removeBreak
(
(
short
)
row
)
;
}
public
boolean
isRowBroken
(
int
row
)
{
return
(
rowBreaks
==
null
)
?
false
:
rowBreaks
.
getBreak
(
(
short
)
row
)
!=
null
;
}
public
void
setColumnBreak
(
short
column
,
short
fromRow
,
short
toRow
)
{
if
(
colBreaks
==
null
)
{
int
loc
=
findFirstRecordLocBySid
(
WindowTwoRecord
.
sid
)
;
colBreaks
=
new
PageBreakRecord
(
PageBreakRecord
.
VERTICAL_SID
)
;
records
.
add
(
loc
,
colBreaks
)
;
}
colBreaks
.
addBreak
(
column
,
fromRow
,
toRow
)
;
}
public
void
removeColumnBreak
(
short
column
)
{
if
(
colBreaks
==
null
)
throw
new
IllegalArgumentException
(
"Sheet does not define any column breaks"
)
;
colBreaks
.
removeBreak
(
column
)
;
}
public
boolean
isColumnBroken
(
short
column
)
{
return
(
colBreaks
==
null
)
?
false
:
colBreaks
.
getBreak
(
column
)
!=
null
;
}
public
void
shiftRowBreaks
(
int
startingRow
,
int
endingRow
,
int
count
)
{
shiftBreaks
(
rowBreaks
,
(
short
)
startingRow
,
(
short
)
endingRow
,
(
short
)
count
)
;
}
public
void
shiftColumnBreaks
(
short
startingCol
,
short
endingCol
,
short
count
)
{
shiftBreaks
(
colBreaks
,
startingCol
,
endingCol
,
count
)
;
}
public
Iterator
getRowBreaks
(
)
{
return
rowBreaks
.
getBreaksIterator
(
)
;
}
public
int
getNumRowBreaks
(
)
{
return
(
rowBreaks
==
null
)
?
0
:
(
int
)
rowBreaks
.
getNumBreaks
(
)
;
}
public
Iterator
getColumnBreaks
(
)
{
return
colBreaks
.
getBreaksIterator
(
)
;
}
public
int
getNumColumnBreaks
(
)
{
return
(
colBreaks
==
null
)
?
0
:
(
int
)
colBreaks
.
getNumBreaks
(
)
;
}
public
void
setColumnGroupCollapsed
(
short
columnNumber
,
boolean
collapsed
)
{
if
(
collapsed
)
{
columns
.
collapseColumn
(
columnNumber
)
;
}
else
{
columns
.
expandColumn
(
columnNumber
)
;
}
}
public
void
groupRowRange
(
int
fromRow
,
int
toRow
,
boolean
indent
)
{
checkRows
(
)
;
for
(
int
rowNum
=
fromRow
;
rowNum
<=
toRow
;
rowNum
++
)
{
RowRecord
row
=
getRow
(
rowNum
)
;
if
(
row
==
null
)
{
row
=
createRow
(
rowNum
)
;
addRow
(
row
)
;
}
int
level
=
row
.
getOutlineLevel
(
)
;
if
(
indent
)
level
++
;
else
level
--
;
level
=
Math
.
max
(
0
,
level
)
;
level
=
Math
.
min
(
7
,
level
)
;
row
.
setOutlineLevel
(
(
short
)
(
level
)
)
;
}
recalcRowGutter
(
)
;
}
private
void
recalcRowGutter
(
)
{
int
maxLevel
=
0
;
Iterator
iterator
=
rows
.
getIterator
(
)
;
while
(
iterator
.
hasNext
(
)
)
{
RowRecord
rowRecord
=
(
RowRecord
)
iterator
.
next
(
)
;
maxLevel
=
Math
.
max
(
rowRecord
.
getOutlineLevel
(
)
,
maxLevel
)
;
}
GutsRecord
guts
=
(
GutsRecord
)
findFirstRecordBySid
(
GutsRecord
.
sid
)
;
guts
.
setRowLevelMax
(
(
short
)
(
maxLevel
+
1
)
)
;
guts
.
setLeftRowGutter
(
(
short
)
(
29
+
(
12
*
(
maxLevel
)
)
)
)
;
}
public
void
setRowGroupCollapsed
(
int
row
,
boolean
collapse
)
{
if
(
collapse
)
{
rows
.
collapseRow
(
row
)
;
}
else
{
rows
.
expandRow
(
row
)
;
}
}
}
