package
org
.
apache
.
synapse
.
mediators
.
builtin
;
import
org
.
apache
.
synapse
.
MessageContext
;
import
org
.
apache
.
synapse
.
config
.
xml
.
XMLConfigConstants
;
import
org
.
apache
.
synapse
.
core
.
axis2
.
Axis2MessageContext
;
import
org
.
apache
.
synapse
.
mediators
.
AbstractMediator
;
import
org
.
apache
.
synapse
.
util
.
xpath
.
SynapseXPath
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
Map
;
import
java
.
util
.
Set
;
public
class
PropertyMediator
extends
AbstractMediator
{
private
String
name
=
null
;
private
String
value
=
null
;
private
SynapseXPath
expression
=
null
;
private
String
scope
=
null
;
public
static
final
int
ACTION_SET
=
0
;
public
static
final
int
ACTION_REMOVE
=
1
;
private
int
action
=
ACTION_SET
;
public
boolean
mediate
(
MessageContext
synCtx
)
{
boolean
traceOn
=
isTraceOn
(
synCtx
)
;
boolean
traceOrDebugOn
=
isTraceOrDebugOn
(
traceOn
)
;
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"Start : Property mediator"
)
;
if
(
traceOn
&&
trace
.
isTraceEnabled
(
)
)
{
trace
.
trace
(
"Message : "
+
synCtx
.
getEnvelope
(
)
)
;
}
}
if
(
action
==
ACTION_SET
)
{
String
resultValue
=
(
value
!=
null
?
value
:
expression
.
stringValueOf
(
synCtx
)
)
;
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"Setting property : "
+
name
+
" at scope : "
+
(
scope
==
null
?
"default"
:
scope
)
+
" to : "
+
resultValue
+
" (i.e. "
+
(
value
!=
null
?
"constant : "
+
value
:
"result of expression : "
+
expression
)
+
")"
)
;
}
if
(
scope
==
null
||
XMLConfigConstants
.
SCOPE_DEFAULT
.
equals
(
scope
)
)
{
synCtx
.
setProperty
(
name
,
resultValue
)
;
}
else
if
(
XMLConfigConstants
.
SCOPE_AXIS2
.
equals
(
scope
)
&&
synCtx
instanceof
Axis2MessageContext
)
{
Axis2MessageContext
axis2smc
=
(
Axis2MessageContext
)
synCtx
;
org
.
apache
.
axis2
.
context
.
MessageContext
axis2MessageCtx
=
axis2smc
.
getAxis2MessageContext
(
)
;
axis2MessageCtx
.
setProperty
(
name
,
resultValue
)
;
}
else
if
(
XMLConfigConstants
.
SCOPE_CLIENT
.
equals
(
scope
)
&&
synCtx
instanceof
Axis2MessageContext
)
{
Axis2MessageContext
axis2smc
=
(
Axis2MessageContext
)
synCtx
;
org
.
apache
.
axis2
.
context
.
MessageContext
axis2MessageCtx
=
axis2smc
.
getAxis2MessageContext
(
)
;
axis2MessageCtx
.
getOptions
(
)
.
setProperty
(
name
,
resultValue
)
;
}
else
if
(
XMLConfigConstants
.
SCOPE_TRANSPORT
.
equals
(
scope
)
&&
synCtx
instanceof
Axis2MessageContext
)
{
Axis2MessageContext
axis2smc
=
(
Axis2MessageContext
)
synCtx
;
org
.
apache
.
axis2
.
context
.
MessageContext
axis2MessageCtx
=
axis2smc
.
getAxis2MessageContext
(
)
;
Object
headers
=
axis2MessageCtx
.
getProperty
(
org
.
apache
.
axis2
.
context
.
MessageContext
.
TRANSPORT_HEADERS
)
;
if
(
headers
!=
null
&&
headers
instanceof
Map
)
{
Map
headersMap
=
(
HashMap
)
headers
;
headersMap
.
put
(
name
,
resultValue
)
;
}
if
(
headers
==
null
)
{
Map
headersMap
=
new
HashMap
(
)
;
headersMap
.
put
(
name
,
resultValue
)
;
axis2MessageCtx
.
setProperty
(
org
.
apache
.
axis2
.
context
.
MessageContext
.
TRANSPORT_HEADERS
,
headersMap
)
;
}
}
}
else
{
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"Removing property : "
+
name
+
" (scope:"
+
(
scope
==
null
?
"default"
:
scope
)
+
")"
)
;
}
if
(
scope
==
null
||
XMLConfigConstants
.
SCOPE_DEFAULT
.
equals
(
scope
)
)
{
Set
pros
=
synCtx
.
getPropertyKeySet
(
)
;
if
(
pros
!=
null
)
{
pros
.
remove
(
name
)
;
}
}
else
if
(
(
XMLConfigConstants
.
SCOPE_AXIS2
.
equals
(
scope
)
||
XMLConfigConstants
.
SCOPE_CLIENT
.
equals
(
scope
)
)
&&
synCtx
instanceof
Axis2MessageContext
)
{
Axis2MessageContext
axis2smc
=
(
Axis2MessageContext
)
synCtx
;
org
.
apache
.
axis2
.
context
.
MessageContext
axis2MessageCtx
=
axis2smc
.
getAxis2MessageContext
(
)
;
axis2MessageCtx
.
removeProperty
(
name
)
;
}
else
if
(
XMLConfigConstants
.
SCOPE_TRANSPORT
.
equals
(
scope
)
&&
synCtx
instanceof
Axis2MessageContext
)
{
Axis2MessageContext
axis2smc
=
(
Axis2MessageContext
)
synCtx
;
org
.
apache
.
axis2
.
context
.
MessageContext
axis2MessageCtx
=
axis2smc
.
getAxis2MessageContext
(
)
;
Object
headers
=
axis2MessageCtx
.
getProperty
(
org
.
apache
.
axis2
.
context
.
MessageContext
.
TRANSPORT_HEADERS
)
;
if
(
headers
!=
null
&&
headers
instanceof
Map
)
{
Map
headersMap
=
(
HashMap
)
headers
;
headersMap
.
remove
(
name
)
;
}
else
{
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"No transport headers found for the message"
)
;
}
}
}
}
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"End : Property mediator"
)
;
}
return
true
;
}
public
String
getName
(
)
{
return
name
;
}
public
void
setName
(
String
name
)
{
this
.
name
=
name
;
}
public
String
getValue
(
)
{
return
value
;
}
public
void
setValue
(
String
value
)
{
this
.
value
=
value
;
}
public
SynapseXPath
getExpression
(
)
{
return
expression
;
}
public
void
setExpression
(
SynapseXPath
expression
)
{
this
.
expression
=
expression
;
}
public
String
getScope
(
)
{
return
scope
;
}
public
void
setScope
(
String
scope
)
{
this
.
scope
=
scope
;
}
public
int
getAction
(
)
{
return
action
;
}
public
void
setAction
(
int
action
)
{
this
.
action
=
action
;
}
}
