package
org
.
apache
.
synapse
.
mediators
.
eip
.
splitter
;
import
org
.
apache
.
synapse
.
MessageContext
;
import
org
.
apache
.
synapse
.
ManagedLifecycle
;
import
org
.
apache
.
synapse
.
core
.
axis2
.
Axis2MessageContext
;
import
org
.
apache
.
synapse
.
core
.
SynapseEnvironment
;
import
org
.
apache
.
synapse
.
util
.
MessageHelper
;
import
org
.
apache
.
synapse
.
mediators
.
AbstractMediator
;
import
org
.
apache
.
synapse
.
mediators
.
base
.
SequenceMediator
;
import
org
.
apache
.
synapse
.
mediators
.
eip
.
Target
;
import
org
.
apache
.
synapse
.
mediators
.
eip
.
EIPConstants
;
import
org
.
apache
.
axis2
.
AxisFault
;
import
org
.
apache
.
axis2
.
Constants
;
import
org
.
apache
.
axis2
.
context
.
OperationContext
;
import
java
.
util
.
ArrayList
;
import
java
.
util
.
List
;
import
java
.
util
.
Iterator
;
public
class
CloneMediator
extends
AbstractMediator
implements
ManagedLifecycle
{
private
boolean
continueParent
=
false
;
private
List
<
Target
>
targets
=
new
ArrayList
<
Target
>
(
)
;
public
boolean
mediate
(
MessageContext
synCtx
)
{
boolean
traceOn
=
isTraceOn
(
synCtx
)
;
boolean
traceOrDebugOn
=
isTraceOrDebugOn
(
traceOn
)
;
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"Start : Clone mediator"
)
;
if
(
traceOn
&&
trace
.
isTraceEnabled
(
)
)
{
trace
.
trace
(
"Message : "
+
synCtx
.
getEnvelope
(
)
)
;
}
}
Iterator
<
Target
>
iter
=
targets
.
iterator
(
)
;
int
i
=
0
;
while
(
iter
.
hasNext
(
)
)
{
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"Submitting "
+
(
i
+
1
)
+
" of "
+
targets
.
size
(
)
+
" messages for processing in parallel"
)
;
}
iter
.
next
(
)
.
mediate
(
getClonedMessageContext
(
synCtx
,
i
++
,
targets
.
size
(
)
)
)
;
}
OperationContext
opCtx
=
(
(
Axis2MessageContext
)
synCtx
)
.
getAxis2MessageContext
(
)
.
getOperationContext
(
)
;
if
(
!
continueParent
&&
opCtx
!=
null
)
{
opCtx
.
setProperty
(
Constants
.
RESPONSE_WRITTEN
,
"SKIP"
)
;
}
if
(
traceOrDebugOn
)
{
traceOrDebug
(
traceOn
,
"End : Clone mediator"
)
;
}
return
continueParent
;
}
private
MessageContext
getClonedMessageContext
(
MessageContext
synCtx
,
int
messageSequence
,
int
messageCount
)
{
MessageContext
newCtx
=
null
;
try
{
newCtx
=
MessageHelper
.
cloneMessageContext
(
synCtx
)
;
newCtx
.
setProperty
(
EIPConstants
.
MESSAGE_SEQUENCE
,
String
.
valueOf
(
messageSequence
)
+
EIPConstants
.
MESSAGE_SEQUENCE_DELEMITER
+
messageCount
)
;
}
catch
(
AxisFault
axisFault
)
{
handleException
(
"Error cloning the message context"
,
axisFault
,
synCtx
)
;
}
return
newCtx
;
}
public
boolean
isContinueParent
(
)
{
return
continueParent
;
}
public
void
setContinueParent
(
boolean
continueParent
)
{
this
.
continueParent
=
continueParent
;
}
public
List
<
Target
>
getTargets
(
)
{
return
targets
;
}
public
void
setTargets
(
List
<
Target
>
targets
)
{
this
.
targets
=
targets
;
}
public
void
addTarget
(
Target
target
)
{
this
.
targets
.
add
(
target
)
;
}
public
void
init
(
SynapseEnvironment
se
)
{
for
(
Target
target
:
targets
)
{
SequenceMediator
seq
=
target
.
getSequence
(
)
;
if
(
seq
!=
null
)
{
seq
.
init
(
se
)
;
}
}
}
public
void
destroy
(
)
{
for
(
Target
target
:
targets
)
{
SequenceMediator
seq
=
target
.
getSequence
(
)
;
if
(
seq
!=
null
)
{
seq
.
destroy
(
)
;
}
}
}
}
