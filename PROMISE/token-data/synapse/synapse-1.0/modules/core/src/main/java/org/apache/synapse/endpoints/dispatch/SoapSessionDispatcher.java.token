package
org
.
apache
.
synapse
.
endpoints
.
dispatch
;
import
org
.
apache
.
synapse
.
endpoints
.
Endpoint
;
import
org
.
apache
.
synapse
.
MessageContext
;
import
org
.
apache
.
synapse
.
core
.
axis2
.
Axis2MessageContext
;
import
org
.
apache
.
axiom
.
soap
.
SOAPHeader
;
import
org
.
apache
.
axiom
.
om
.
OMElement
;
import
org
.
apache
.
axis2
.
context
.
OperationContext
;
import
org
.
apache
.
axis2
.
AxisFault
;
import
javax
.
xml
.
namespace
.
QName
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
Map
;
import
java
.
util
.
Collections
;
public
class
SoapSessionDispatcher
implements
Dispatcher
{
private
Map
sessionMap
=
Collections
.
synchronizedMap
(
new
HashMap
(
)
)
;
public
Endpoint
getEndpoint
(
MessageContext
synCtx
)
{
Endpoint
endpoint
=
null
;
SOAPHeader
header
=
synCtx
.
getEnvelope
(
)
.
getHeader
(
)
;
if
(
header
!=
null
)
{
OMElement
sgcID
=
header
.
getFirstChildWithName
(
new
QName
(
"http://ws.apache.org/namespaces/axis2"
,
"ServiceGroupId"
,
"axis2"
)
)
;
if
(
sgcID
!=
null
&&
sgcID
.
getText
(
)
!=
null
)
{
Object
e
=
sessionMap
.
get
(
sgcID
.
getText
(
)
)
;
if
(
e
!=
null
)
{
endpoint
=
(
Endpoint
)
e
;
}
}
}
return
endpoint
;
}
public
void
updateSession
(
MessageContext
synCtx
,
Endpoint
endpoint
)
{
SOAPHeader
header
=
synCtx
.
getEnvelope
(
)
.
getHeader
(
)
;
if
(
header
!=
null
)
{
OMElement
replyTo
=
header
.
getFirstChildWithName
(
new
QName
(
"http://www.w3.org/2005/08/addressing"
,
"ReplyTo"
,
"wsa"
)
)
;
if
(
replyTo
!=
null
)
{
OMElement
referenceParameters
=
replyTo
.
getFirstChildWithName
(
new
QName
(
"http://www.w3.org/2005/08/addressing"
,
"ReferenceParameters"
,
"wsa"
)
)
;
if
(
referenceParameters
!=
null
)
{
OMElement
sgcID
=
referenceParameters
.
getFirstChildWithName
(
new
QName
(
"http://ws.apache.org/namespaces/axis2"
,
"ServiceGroupId"
,
"axis2"
)
)
;
synchronized
(
sessionMap
)
{
if
(
!
sessionMap
.
containsKey
(
sgcID
.
getText
(
)
)
)
{
sessionMap
.
put
(
sgcID
.
getText
(
)
,
endpoint
)
;
}
}
}
}
}
}
public
void
unbind
(
MessageContext
synCtx
)
{
SOAPHeader
header
=
synCtx
.
getEnvelope
(
)
.
getHeader
(
)
;
if
(
header
!=
null
)
{
OMElement
sgcID
=
header
.
getFirstChildWithName
(
new
QName
(
"http://ws.apache.org/namespaces/axis2"
,
"ServiceGroupId"
,
"axis2"
)
)
;
if
(
sgcID
!=
null
&&
sgcID
.
getText
(
)
!=
null
)
{
sessionMap
.
remove
(
sgcID
.
getText
(
)
)
;
}
}
}
public
boolean
isServerInitiatedSession
(
)
{
return
true
;
}
}
