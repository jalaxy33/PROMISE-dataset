package
org
.
apache
.
synapse
.
config
.
xml
;
import
org
.
apache
.
axiom
.
om
.
OMElement
;
import
org
.
apache
.
axiom
.
om
.
OMNode
;
import
org
.
apache
.
commons
.
logging
.
Log
;
import
org
.
apache
.
commons
.
logging
.
LogFactory
;
import
org
.
apache
.
synapse
.
SynapseException
;
import
org
.
apache
.
synapse
.
Mediator
;
import
org
.
apache
.
synapse
.
config
.
XMLToObjectMapper
;
import
org
.
apache
.
synapse
.
config
.
xml
.
eventing
.
EventPublisherMediatorFactory
;
import
javax
.
xml
.
namespace
.
QName
;
import
java
.
util
.
HashMap
;
import
java
.
util
.
Iterator
;
import
java
.
util
.
Map
;
import
java
.
util
.
Properties
;
import
java
.
util
.
ServiceLoader
;
public
class
MediatorFactoryFinder
implements
XMLToObjectMapper
{
private
static
final
Log
log
=
LogFactory
.
getLog
(
MediatorFactoryFinder
.
class
)
;
private
static
final
Class
[
]
mediatorFactories
=
{
SequenceMediatorFactory
.
class
,
LogMediatorFactory
.
class
,
SendMediatorFactory
.
class
,
FilterMediatorFactory
.
class
,
SynapseMediatorFactory
.
class
,
DropMediatorFactory
.
class
,
HeaderMediatorFactory
.
class
,
FaultMediatorFactory
.
class
,
PropertyMediatorFactory
.
class
,
SwitchMediatorFactory
.
class
,
InMediatorFactory
.
class
,
OutMediatorFactory
.
class
,
ClassMediatorFactory
.
class
,
ValidateMediatorFactory
.
class
,
XSLTMediatorFactory
.
class
,
AnnotatedCommandMediatorFactory
.
class
,
POJOCommandMediatorFactory
.
class
,
CloneMediatorFactory
.
class
,
IterateMediatorFactory
.
class
,
AggregateMediatorFactory
.
class
,
DBReportMediatorFactory
.
class
,
DBLookupMediatorFactory
.
class
,
CacheMediatorFactory
.
class
,
CalloutMediatorFactory
.
class
,
EventPublisherMediatorFactory
.
class
,
TransactionMediatorFactory
.
class
,
EnqueueMediatorFactory
.
class
,
ConditionalRouterMediatorFactory
.
class
,
SamplingThrottleMediatorFactory
.
class
,
URLRewriteMediatorFactory
.
class
,
EnrichMediatorFactory
.
class
,
MessageStoreMediatorFactory
.
class
,
TemplateMediatorFactory
.
class
,
InvokeMediatorFactory
.
class
,
PayloadFactoryMediatorFactory
.
class
,
BeanMediatorFactory
.
class
,
EJBMediatorFactory
.
class
,
RespondMediatorFactory
.
class
,
LoopbackMediatorFactory
.
class
}
;
private
final
static
MediatorFactoryFinder
instance
=
new
MediatorFactoryFinder
(
)
;
private
static
Map
<
QName
,
Class
>
factoryMap
=
new
HashMap
<
QName
,
Class
>
(
)
;
private
static
boolean
initialized
=
false
;
public
static
synchronized
MediatorFactoryFinder
getInstance
(
)
{
if
(
!
initialized
)
{
loadMediatorFactories
(
)
;
}
return
instance
;
}
public
static
synchronized
void
reset
(
)
{
factoryMap
.
clear
(
)
;
initialized
=
false
;
}
private
MediatorFactoryFinder
(
)
{
}
private
static
void
loadMediatorFactories
(
)
{
for
(
Class
c
:
mediatorFactories
)
{
try
{
MediatorFactory
fac
=
(
MediatorFactory
)
c
.
newInstance
(
)
;
factoryMap
.
put
(
fac
.
getTagQName
(
)
,
c
)
;
}
catch
(
Exception
e
)
{
throw
new
SynapseException
(
"Error instantiating "
+
c
.
getName
(
)
,
e
)
;
}
}
registerExtensions
(
)
;
initialized
=
true
;
}
private
static
void
registerExtensions
(
)
{
Iterator
<
MediatorFactory
>
factories
=
ServiceLoader
.
load
(
MediatorFactory
.
class
)
.
iterator
(
)
;
while
(
factories
.
hasNext
(
)
)
{
MediatorFactory
factory
=
factories
.
next
(
)
;
QName
tag
=
factory
.
getTagQName
(
)
;
factoryMap
.
put
(
tag
,
factory
.
getClass
(
)
)
;
if
(
log
.
isDebugEnabled
(
)
)
{
log
.
debug
(
"Added MediatorFactory "
+
factory
.
getClass
(
)
+
" to handle "
+
tag
)
;
}
}
}
public
Mediator
getMediator
(
OMElement
element
,
Properties
properties
)
{
String
localName
=
element
.
getLocalName
(
)
;
QName
qName
;
if
(
element
.
getNamespace
(
)
!=
null
)
{
qName
=
new
QName
(
element
.
getNamespace
(
)
.
getNamespaceURI
(
)
,
localName
)
;
}
else
{
qName
=
new
QName
(
localName
)
;
}
if
(
log
.
isDebugEnabled
(
)
)
{
log
.
debug
(
"getMediator("
+
qName
+
")"
)
;
}
Class
cls
=
factoryMap
.
get
(
qName
)
;
if
(
cls
==
null
&&
localName
.
indexOf
(
'.'
)
>
-
1
)
{
String
newLocalName
=
localName
.
substring
(
0
,
localName
.
indexOf
(
'.'
)
)
;
qName
=
new
QName
(
element
.
getNamespace
(
)
.
getNamespaceURI
(
)
,
newLocalName
)
;
if
(
log
.
isDebugEnabled
(
)
)
{
log
.
debug
(
"getMediator.2("
+
qName
+
")"
)
;
}
cls
=
factoryMap
.
get
(
qName
)
;
}
if
(
cls
==
null
)
{
String
msg
=
"Unknown mediator referenced by configuration element : "
+
qName
;
log
.
error
(
msg
)
;
throw
new
SynapseException
(
msg
)
;
}
try
{
MediatorFactory
mf
=
(
MediatorFactory
)
cls
.
newInstance
(
)
;
return
mf
.
createMediator
(
element
,
properties
)
;
}
catch
(
InstantiationException
e
)
{
String
msg
=
"Error initializing mediator factory : "
+
cls
;
log
.
error
(
msg
)
;
throw
new
SynapseException
(
msg
,
e
)
;
}
catch
(
IllegalAccessException
e
)
{
String
msg
=
"Error initializing mediator factory : "
+
cls
;
log
.
error
(
msg
)
;
throw
new
SynapseException
(
msg
,
e
)
;
}
}
public
Map
<
QName
,
Class
>
getFactoryMap
(
)
{
return
factoryMap
;
}
public
Object
getObjectFromOMNode
(
OMNode
om
,
Properties
properties
)
{
if
(
om
instanceof
OMElement
)
{
return
getMediator
(
(
OMElement
)
om
,
properties
)
;
}
else
{
handleException
(
"Invalid mediator configuration XML : "
+
om
)
;
}
return
null
;
}
private
void
handleException
(
String
msg
)
{
log
.
error
(
msg
)
;
throw
new
SynapseException
(
msg
)
;
}
}
