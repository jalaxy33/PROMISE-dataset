SegmentMerger
byte
NORMS_HEADER
byte
Directory
directory
String
segment
int
termIndexInterval
DEFAULT_TERM_INDEX_INTERVAL
List
readers
ArrayList
FieldInfos
fieldInfos
int
mergedDocs
CheckAbort
checkAbort
boolean
mergeDocStores
int
MAX_RAW_MERGE_DOCS
SegmentMerger
dir
Directory
name
String
directory
dir
segment
name
SegmentMerger
writer
IndexWriter
name
String
merge
MergePolicy
OneMerge
directory
getDirectory
segment
name
if
merge
checkAbort
CheckAbort
merge
directory
termIndexInterval
getTermIndexInterval
hasProx
boolean
return
hasProx
add
reader
IndexReader
add
reader
segmentReader
IndexReader
i
int
return
IndexReader
get
i
merge
int
return
merge
merge
int
mergeDocStores
boolean
mergeDocStores
mergeDocStores
mergedDocs
mergeFields
mergeTerms
mergeNorms
if
mergeDocStores
hasVectors
mergeVectors
return
mergedDocs
closeReaders
for
forControl
int
i
i
size
i
block
IndexReader
reader
IndexReader
get
i
close
createCompoundFile
List
fileName
String
CompoundFileWriter
cfsWriter
CompoundFileWriter
directory
fileName
checkAbort
List
files
ArrayList
length
for
forControl
int
i
i
length
i
block
String
ext
COMPOUND_EXTENSIONS
i
if
equals
PROX_EXTENSION
hasProx
continue
if
mergeDocStores
equals
FIELDS_EXTENSION
equals
FIELDS_INDEX_EXTENSION
add
segment
ext
for
forControl
int
i
i
size
i
block
FieldInfo
fi
fieldInfo
i
if
isIndexed
omitNorms
block
add
segment
NORMS_EXTENSION
break
if
hasVectors
mergeDocStores
block
for
forControl
int
i
i
length
i
block
add
segment
VECTOR_EXTENSIONS
i
Iterator
it
iterator
while
hasNext
block
addFile
String
next
close
return
files
addIndexed
reader
IndexReader
fieldInfos
FieldInfos
names
Collection
storeTermVectors
boolean
storePositionWithTermVector
boolean
storeOffsetWithTermVector
boolean
storePayloads
boolean
omitTf
boolean
Iterator
i
iterator
while
hasNext
block
String
field
String
next
add
field
storeTermVectors
storePositionWithTermVector
storeOffsetWithTermVector
hasNorms
field
storePayloads
omitTf
SegmentReader
matchingSegmentReaders
int
rawDocLengths
int
rawDocLengths2
setMatchingSegmentReaders
matchingSegmentReaders
SegmentReader
size
for
forControl
int
i
i
size
i
block
IndexReader
reader
IndexReader
get
i
if
reader
SegmentReader
block
SegmentReader
segmentReader
SegmentReader
reader
boolean
same
FieldInfos
segmentFieldInfos
getFieldInfos
for
forControl
int
j
same
j
size
j
same
fieldName
equals
fieldName
j
j
if
same
matchingSegmentReaders
i
segmentReader
rawDocLengths
int
MAX_RAW_MERGE_DOCS
rawDocLengths2
int
MAX_RAW_MERGE_DOCS
mergeFields
int
if
mergeDocStores
block
SegmentReader
sr
SegmentReader
get
size
fieldInfos
FieldInfos
clone
block
fieldInfos
FieldInfos
for
forControl
int
i
i
size
i
block
IndexReader
reader
IndexReader
get
i
if
reader
SegmentReader
block
SegmentReader
segmentReader
SegmentReader
reader
for
forControl
int
j
j
getFieldInfos
size
j
block
FieldInfo
fi
getFieldInfos
fieldInfo
j
add
name
isIndexed
storeTermVector
storePositionWithTermVector
storeOffsetWithTermVector
hasNorms
name
storePayloads
omitTf
block
addIndexed
reader
fieldInfos
getFieldNames
TERMVECTOR_WITH_POSITION_OFFSET
addIndexed
reader
fieldInfos
getFieldNames
TERMVECTOR_WITH_POSITION
addIndexed
reader
fieldInfos
getFieldNames
TERMVECTOR_WITH_OFFSET
addIndexed
reader
fieldInfos
getFieldNames
TERMVECTOR
addIndexed
reader
fieldInfos
getFieldNames
OMIT_TF
addIndexed
reader
fieldInfos
getFieldNames
STORES_PAYLOADS
addIndexed
reader
fieldInfos
getFieldNames
INDEXED
add
getFieldNames
UNINDEXED
write
directory
segment
int
docCount
setMatchingSegmentReaders
if
mergeDocStores
block
FieldSelector
fieldSelectorMerge
FieldSelector
accept
FieldSelectorResult
fieldName
String
return
LOAD_FOR_MERGE
FieldsWriter
fieldsWriter
FieldsWriter
directory
segment
fieldInfos
try
for
forControl
int
i
i
size
i
block
IndexReader
reader
IndexReader
get
i
SegmentReader
matchingSegmentReader
matchingSegmentReaders
i
FieldsReader
matchingFieldsReader
boolean
hasMatchingReader
if
matchingSegmentReader
block
FieldsReader
fieldsReader
getFieldsReader
if
fieldsReader
canReadRawDocs
block
matchingFieldsReader
hasMatchingReader
block
matchingFieldsReader
fieldsReader
hasMatchingReader
block
hasMatchingReader
matchingFieldsReader
int
maxDoc
maxDoc
boolean
hasDeletions
hasDeletions
for
forControl
int
j
j
maxDoc
block
if
hasDeletions
isDeleted
j
block
if
hasMatchingReader
block
int
start
j
int
numDocs
do
numDocs
MAX_RAW_MERGE_DOCS
block
j
numDocs
if
j
maxDoc
break
if
hasDeletions
isDeleted
j
block
j
break
IndexInput
stream
rawDocs
rawDocLengths
start
numDocs
addRawDocuments
stream
rawDocLengths
numDocs
docCount
numDocs
if
checkAbort
work
numDocs
block
Document
doc
document
j
fieldSelectorMerge
addDocument
doc
j
docCount
if
checkAbort
work
j
close
long
fdxFileLength
fileLength
segment
FIELDS_INDEX_EXTENSION
if
docCount
fdxFileLength
throw
RuntimeException
docCount
fdxFileLength
for
forControl
int
i
i
size
i
docCount
IndexReader
get
i
return
docCount
mergeVectors
TermVectorsWriter
termVectorsWriter
TermVectorsWriter
directory
segment
fieldInfos
try
for
forControl
int
r
r
size
r
block
SegmentReader
matchingSegmentReader
matchingSegmentReaders
r
TermVectorsReader
matchingVectorsReader
boolean
hasMatchingReader
if
matchingSegmentReader
block
matchingVectorsReader
termVectorsReaderOrig
if
matchingVectorsReader
canReadRawDocs
block
matchingVectorsReader
hasMatchingReader
hasMatchingReader
matchingVectorsReader
block
hasMatchingReader
matchingVectorsReader
IndexReader
reader
IndexReader
get
r
boolean
hasDeletions
hasDeletions
int
maxDoc
maxDoc
for
forControl
int
docNum
docNum
maxDoc
block
if
hasDeletions
isDeleted
docNum
block
if
hasMatchingReader
block
int
start
docNum
int
numDocs
do
numDocs
MAX_RAW_MERGE_DOCS
block
docNum
numDocs
if
docNum
maxDoc
break
if
hasDeletions
isDeleted
docNum
block
docNum
break
rawDocs
rawDocLengths
rawDocLengths2
start
numDocs
addRawDocuments
matchingVectorsReader
rawDocLengths
rawDocLengths2
numDocs
if
checkAbort
work
numDocs
block
TermFreqVector
vectors
getTermFreqVectors
docNum
addAllDocVectors
vectors
docNum
if
checkAbort
work
docNum
close
long
tvxSize
fileLength
segment
VECTORS_INDEX_EXTENSION
if
mergedDocs
tvxSize
throw
RuntimeException
mergedDocs
tvxSize
IndexOutput
freqOutput
IndexOutput
proxOutput
TermInfosWriter
termInfosWriter
int
skipInterval
int
maxSkipLevels
SegmentMergeQueue
queue
DefaultSkipListWriter
skipListWriter
mergeTerms
try
freqOutput
createOutput
segment
if
hasProx
proxOutput
createOutput
segment
termInfosWriter
TermInfosWriter
directory
segment
fieldInfos
termIndexInterval
skipInterval
skipInterval
maxSkipLevels
maxSkipLevels
skipListWriter
DefaultSkipListWriter
skipInterval
maxSkipLevels
mergedDocs
freqOutput
proxOutput
queue
SegmentMergeQueue
size
mergeTermInfos
if
freqOutput
close
if
proxOutput
close
if
termInfosWriter
close
if
queue
close
mergeTermInfos
int
base
int
readerCount
size
for
forControl
int
i
i
readerCount
i
block
IndexReader
reader
IndexReader
get
i
TermEnum
termEnum
terms
SegmentMergeInfo
smi
SegmentMergeInfo
base
termEnum
reader
int
docMap
getDocMap
if
docMap
block
if
docMaps
block
docMaps
int
readerCount
delCounts
int
readerCount
docMaps
i
docMap
delCounts
i
maxDoc
numDocs
base
numDocs
if
next
put
smi
close
SegmentMergeInfo
match
SegmentMergeInfo
size
while
size
block
int
matchSize
match
matchSize
SegmentMergeInfo
pop
Term
term
match
term
SegmentMergeInfo
top
SegmentMergeInfo
top
while
top
compareTo
term
block
match
matchSize
SegmentMergeInfo
pop
top
SegmentMergeInfo
top
int
df
mergeTermInfo
match
matchSize
if
checkAbort
work
df
while
matchSize
block
SegmentMergeInfo
smi
match
matchSize
if
next
put
smi
close
TermInfo
termInfo
TermInfo
mergeTermInfo
int
smis
SegmentMergeInfo
n
int
long
freqPointer
getFilePointer
long
proxPointer
if
proxOutput
proxPointer
getFilePointer
proxPointer
int
df
if
fieldInfo
omitTf
smis
term
field
block
df
appendPostingsNoTf
smis
n
block
df
appendPostings
smis
n
long
skipPointer
writeSkip
freqOutput
if
df
block
set
df
freqPointer
proxPointer
int
skipPointer
freqPointer
add
smis
term
termInfo
return
df
byte
payloadBuffer
int
docMaps
getDocMaps
int
return
docMaps
int
delCounts
getDelCounts
int
return
delCounts
appendPostings
int
smis
SegmentMergeInfo
n
int
int
lastDoc
int
df
resetSkip
boolean
storePayloads
fieldInfo
storePayloads
smis
term
field
int
lastPayloadLength
for
forControl
int
i
i
n
i
block
SegmentMergeInfo
smi
smis
i
TermPositions
postings
getPositions
assert
postings
int
base
base
int
docMap
getDocMap
seek
termEnum
while
next
block
int
doc
doc
if
docMap
doc
docMap
doc
doc
base
if
doc
df
doc
lastDoc
throw
CorruptIndexException
doc
lastDoc
df
if
df
skipInterval
block
setSkipData
lastDoc
storePayloads
lastPayloadLength
bufferSkip
df
int
docCode
doc
lastDoc
lastDoc
doc
int
freq
freq
if
freq
block
writeVInt
docCode
block
writeVInt
docCode
writeVInt
freq
int
lastPosition
for
forControl
int
j
j
freq
j
block
int
position
nextPosition
int
delta
position
lastPosition
if
storePayloads
block
int
payloadLength
getPayloadLength
if
payloadLength
lastPayloadLength
block
writeVInt
delta
block
writeVInt
delta
writeVInt
payloadLength
lastPayloadLength
payloadLength
if
payloadLength
block
if
payloadBuffer
length
payloadLength
block
payloadBuffer
byte
payloadLength
getPayload
payloadBuffer
writeBytes
payloadBuffer
payloadLength
block
writeVInt
delta
lastPosition
position
return
df
appendPostingsNoTf
int
smis
SegmentMergeInfo
n
int
int
lastDoc
int
df
resetSkip
int
lastPayloadLength
for
forControl
int
i
i
n
i
block
SegmentMergeInfo
smi
smis
i
TermPositions
postings
getPositions
assert
postings
int
base
base
int
docMap
getDocMap
seek
termEnum
while
next
block
int
doc
doc
if
docMap
doc
docMap
doc
doc
base
if
doc
df
doc
lastDoc
throw
CorruptIndexException
doc
lastDoc
df
if
df
skipInterval
block
setSkipData
lastDoc
lastPayloadLength
bufferSkip
df
int
docCode
doc
lastDoc
lastDoc
doc
writeVInt
docCode
return
df
mergeNorms
byte
normBuffer
IndexOutput
output
try
for
forControl
int
i
i
size
i
block
FieldInfo
fi
fieldInfo
i
if
isIndexed
omitNorms
block
if
output
block
output
createOutput
segment
NORMS_EXTENSION
writeBytes
NORMS_HEADER
length
for
forControl
int
j
j
size
j
block
IndexReader
reader
IndexReader
get
j
int
maxDoc
maxDoc
if
normBuffer
length
maxDoc
block
normBuffer
byte
maxDoc
norms
name
normBuffer
if
hasDeletions
block
writeBytes
normBuffer
maxDoc
block
for
forControl
int
k
k
maxDoc
k
block
if
isDeleted
k
block
writeByte
normBuffer
k
if
checkAbort
work
maxDoc
if
output
block
close
CheckAbort
double
workCount
MergePolicy
OneMerge
merge
Directory
dir
CheckAbort
merge
MergePolicy
OneMerge
dir
Directory
merge
merge
dir
dir
work
units
double
workCount
units
if
workCount
block
checkAborted
dir
workCount
